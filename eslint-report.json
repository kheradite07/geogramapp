[{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\capacitor.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\next-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\parse.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst data = JSON.parse(fs.readFileSync('eslint-report.json'));\r\nlet errCount = 0;\r\ndata.filter(d => d.errorCount > 0).forEach(d => {\r\n    console.log('File:', d.filePath);\r\n    d.messages.filter(m => m.severity === 2).forEach(m => {\r\n        console.log(`  Line ${m.line}: ${m.message} (${m.ruleId})`);\r\n        errCount++;\r\n    });\r\n});\r\nconsole.log('Total Errors:', errCount);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\scripts\\build-mobile.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":12,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":25},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":14,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":3,"column":22,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":3,"endColumn":46}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\nconst { execSync } = require('child_process');\r\n\r\nconst apiDir = path.join(__dirname, '..', 'src', 'app', 'api');\r\nconst apiBackupDir = path.join(__dirname, '..', 'src', 'app', '_api_backup');\r\n\r\n// Ensure API dir is restored even on exit\r\nprocess.on('SIGINT', restoreApi);\r\nprocess.on('SIGTERM', restoreApi);\r\n// process.on('exit', restoreApi); // 'exit' is synchronous only, handled in finally\r\n\r\nfunction restoreApi() {\r\n    if (fs.existsSync(apiBackupDir)) {\r\n        console.log('Restoring API directory...');\r\n        try {\r\n            // Check if apiDir was somehow recreated or locked\r\n            if (fs.existsSync(apiDir)) {\r\n                // If apiDir exists (maybe partial restore), remove it first? \r\n                // Or move backup content back?\r\n                // Safest: if original missing, move backup back.\r\n                // If both exist, this is manual intervention state.\r\n            } else {\r\n                fs.renameSync(apiBackupDir, apiDir);\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to restore API directory:', e);\r\n        }\r\n    }\r\n}\r\n\r\ntry {\r\n    // Clear next cache to avoid stale type errors\r\n    const nextDir = path.join(__dirname, '..', '.next');\r\n    if (fs.existsSync(nextDir)) {\r\n        console.log('Clearing .next cache...');\r\n        try {\r\n            fs.rmSync(nextDir, { recursive: true, force: true });\r\n        } catch (e) {\r\n            console.warn('Warning: Could not clear .next cache. Dev server might be running. Proceeding anyway...');\r\n        }\r\n    }\r\n\r\n    if (fs.existsSync(apiDir)) {\r\n        console.log('Moving API directory for static export...');\r\n        fs.renameSync(apiDir, apiBackupDir);\r\n    } else if (fs.existsSync(apiBackupDir)) {\r\n        console.warn('API directory already moved (found backup). Proceeding...');\r\n    } else {\r\n        console.warn('API directory not found at ' + apiDir + '. Proceeding...');\r\n    }\r\n\r\n    console.log('Running mobile build...');\r\n\r\n    // Set environment variable for the build process\r\n    const env = { ...process.env, MOBILE_BUILD: 'true' };\r\n\r\n    // Run the build command (npm run build -> prisma generate && next build)\r\n    execSync('npm run build', { stdio: 'inherit', env });\r\n\r\n} catch (error) {\r\n    console.error('Build execution failed.');\r\n    console.error(error);\r\n    if (error.stdout) console.log(error.stdout.toString());\r\n    if (error.stderr) console.error(error.stderr.toString());\r\n    process.exit(1);\r\n} finally {\r\n    restoreApi();\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\scripts\\debug-users.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { PrismaClient } = require('@prisma/client');\r\nconst prisma = new PrismaClient();\r\n\r\nasync function main() {\r\n    const users = await prisma.user.findMany({\r\n        include: {\r\n            accounts: true\r\n        }\r\n    });\r\n    console.log(\"Total Users:\", users.length);\r\n    users.forEach(u => {\r\n        console.log(`User: ${u.id} | Email: ${u.email} | Name: ${u.name}`);\r\n        u.accounts.forEach(a => {\r\n            console.log(`  - Account: ${a.provider} (${a.providerAccountId})`);\r\n        });\r\n    });\r\n}\r\n\r\nmain()\r\n    .catch(e => console.error(e))\r\n    .finally(async () => await prisma.$disconnect());\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\scripts\\fix-auth-unlink.js","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const { PrismaClient } = require('@prisma/client');\r\nconst prisma = new PrismaClient();\r\n\r\nasync function main() {\r\n    const email = 'msenel.contact@gmail.com';\r\n    const user = await prisma.user.findUnique({\r\n        where: { email },\r\n        include: { accounts: true }\r\n    });\r\n\r\n    if (!user) {\r\n        console.log(`User not found for email: ${email}`);\r\n        return;\r\n    }\r\n\r\n    console.log(`Found user: ${user.id} with ${user.accounts.length} linked accounts.`);\r\n\r\n    // Delete all accounts for this user\r\n    // This forces re-linking on next login based on email match\r\n    if (user.accounts.length > 0) {\r\n        const deleteResult = await prisma.account.deleteMany({\r\n            where: { userId: user.id }\r\n        });\r\n        console.log(`Deleted ${deleteResult.count} account links.`);\r\n        console.log(\"Please ask the user to Sign Out and Sign In again.\");\r\n    } else {\r\n        console.log(\"No accounts to delete.\");\r\n    }\r\n}\r\n\r\nmain()\r\n    .catch(e => console.error(e))\r\n    .finally(async () => await prisma.$disconnect());\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\seed-badges.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\auth\\[...nextauth]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\auth\\register\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\debug\\test-notification\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\debug\\user\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\messages\\[id]\\comments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\messages\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\messages\\[id]\\vote\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\messages\\clear\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\messages\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\[id]\\friend\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\[id]\\messages\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\ghost-exceptions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\location\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\me\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\onboard\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\privacy\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\push-token\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\search\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\sync\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\api\\users\\update\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\auth\\callback\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\icon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\profile\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":96,"column":37,"nodeType":"JSXOpeningElement","endLine":100,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useSession, signOut } from \"next-auth/react\";\r\nimport { useSearchParams, useRouter } from \"next/navigation\";\r\nimport { ArrowLeft, LogOut, User as UserIcon, MapPin, Crown, Check, Lock } from \"lucide-react\";\r\nimport useSWR from \"swr\";\r\nimport { useUser } from \"@/hooks/useUser\";\r\nimport { Suspense, useState, useEffect } from \"react\";\r\nimport { getApiUrl } from \"@/lib/api\";\r\nimport { BADGE_CONFIGS } from \"@/lib/badgeConfig\";\r\nimport { useTranslation } from \"@/context/LocalizationContext\";\r\nimport BadgeInfoModal from \"@/components/BadgeInfoModal\";\r\n\r\nconst fetcher = (url: string) => fetch(getApiUrl(url), { credentials: 'include' }).then((res) => res.json());\r\n\r\n// Helper for relative time\r\nconst formatRelativeTime = (timestamp: number) => {\r\n    const now = Date.now();\r\n    const diff = now - timestamp;\r\n\r\n    const minutes = Math.floor(diff / 60000);\r\n    if (minutes < 1) return 'just now';\r\n    if (minutes < 60) return `${minutes}m ago`;\r\n\r\n    const hours = Math.floor(minutes / 60);\r\n    if (hours < 24) return `${hours}h ago`;\r\n\r\n    const days = Math.floor(hours / 24);\r\n    return `${days}d ago`;\r\n};\r\n\r\nfunction ProfileContent() {\r\n    const { t } = useTranslation();\r\n    const { data: session } = useSession();\r\n    const searchParams = useSearchParams();\r\n    const router = useRouter();\r\n    const [selectedBadgeId, setSelectedBadgeId] = useState<string | null>(null);\r\n    // Get ID from query param (?id=...)\r\n    const userId = searchParams.get('id');\r\n\r\n    // Currently logged-in user details\r\n    const { user: currentUser } = useUser();\r\n\r\n    // Determine if viewing own profile\r\n    const isOwnProfile = !userId || currentUser?.id === userId || session?.user?.email === userId;\r\n\r\n    // If no userId and dealing with own profile, use current user ID if available\r\n    const effectiveUserId = userId || currentUser?.id;\r\n    const isFriendUser = !isOwnProfile && currentUser?.friends?.some((f: any) => f.id === effectiveUserId);\r\n\r\n    const { data: publicProfile, error, isLoading } = useSWR(\r\n        isOwnProfile || !effectiveUserId ? null : `/api/users/${effectiveUserId}`,\r\n        fetcher\r\n    );\r\n\r\n    // Fetch user's messages\r\n    const { data: userMessages, isLoading: messagesLoading } = useSWR(\r\n        effectiveUserId ? `/api/users/${effectiveUserId}/messages` : null,\r\n        fetcher\r\n    );\r\n\r\n    // Re-fetch profile data to ensure freshness, especially if coming from a mutation\r\n    const { mutate } = useSWR(\r\n        isOwnProfile || !effectiveUserId ? null : `/api/users/${effectiveUserId}`,\r\n        fetcher\r\n    );\r\n\r\n    const displayUser = isOwnProfile ? currentUser : publicProfile;\r\n\r\n    if (isLoading && !isOwnProfile) {\r\n        return <div className=\"p-8 text-white pointer-events-auto flex justify-center mt-20\">Loading profile...</div>;\r\n    }\r\n\r\n    if (!displayUser || (error && !isOwnProfile)) {\r\n        if (!effectiveUserId && isLoading) return <div className=\"p-8 text-white pointer-events-auto flex justify-center mt-20\">Loading...</div>;\r\n        return <div className=\"p-8 text-white pointer-events-auto flex justify-center mt-20\">User not found</div>;\r\n    }\r\n\r\n    return (\r\n        <div className=\"min-h-screen p-4 flex flex-col pointer-events-none pb-24\">\r\n            <div className=\"w-full max-w-lg mx-auto mt-10 pointer-events-auto\">\r\n                <button\r\n                    onClick={() => router.back()}\r\n                    className=\"mb-6 flex items-center px-4 py-2 rounded-full bg-black/40 text-white hover:bg-black/60 transition-all backdrop-blur-md border border-white/10\"\r\n                >\r\n                    <ArrowLeft size={20} className=\"mr-2\" />\r\n                    {t('back_to_map') || 'Back to Map'}\r\n                </button>\r\n\r\n                <div className=\"bg-black/40 backdrop-blur-xl rounded-3xl p-8 border border-white/10 shadow-2xl relative\">\r\n                    <div className=\"flex flex-col items-center\">\r\n                        <div className=\"relative group\">\r\n                            <div className={`absolute inset-0 rounded-full blur opacity-75 group-hover:opacity-100 transition duration-1000 group-hover:duration-200 ${isFriendUser ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-purple-600 to-blue-600'}`}></div>\r\n                            <div className={`relative w-32 h-32 rounded-full p-1 ${isFriendUser ? 'bg-green-500 shadow-[0_0_15px_rgba(34,197,94,0.6)]' : 'bg-black'}`}>\r\n                                {displayUser.image ? (\r\n                                    <img\r\n                                        src={displayUser.image}\r\n                                        alt={displayUser.name || \"User\"}\r\n                                        className=\"w-full h-full rounded-full object-cover\"\r\n                                    />\r\n                                ) : (\r\n                                    <div className=\"w-full h-full rounded-full bg-[#1a1a1a] flex items-center justify-center\">\r\n                                        <UserIcon size={48} className=\"text-gray-400\" />\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                            {displayUser.activeBadgeId && BADGE_CONFIGS[displayUser.activeBadgeId] && (\r\n                                <div\r\n                                    title={t(BADGE_CONFIGS[displayUser.activeBadgeId].nameKey)}\r\n                                    className={`absolute top-0 right-0 z-20 flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[displayUser.activeBadgeId].style} text-3xl shadow-lg transform rotate-12 ring-2 ring-black`}\r\n                                >\r\n                                    {BADGE_CONFIGS[displayUser.activeBadgeId].icon}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center justify-center gap-2 mt-6\">\r\n                            <h1 className=\"text-3xl font-bold text-white drop-shadow-md text-center\">\r\n                                {displayUser.fullName || displayUser.name || \"Anonymous User\"}\r\n                            </h1>\r\n                        </div>\r\n\r\n                        <p className=\"text-cyan-400 text-lg font-medium mb-1\">\r\n                            @{displayUser.username || (displayUser.name ? displayUser.name.replace(/\\s+/g, '').toLowerCase() : \"user\")}\r\n                        </p>\r\n\r\n                        {displayUser.bio && (\r\n                            <p className=\"text-gray-300 text-center mt-4 max-w-sm italic\">\r\n                                &quot;{displayUser.bio}&quot;\r\n                            </p>\r\n                        )}\r\n\r\n                        {/* Badge Collection Section */}\r\n                        {displayUser.badges && displayUser.badges.length > 0 && (\r\n                            <div className=\"w-full mt-8 bg-white/5 rounded-2xl p-4 border border-white/5\">\r\n                                <div className=\"flex items-center gap-2 mb-4 px-1\">\r\n                                    <Crown size={16} className=\"text-yellow-400\" />\r\n                                    <h3 className=\"text-xs font-bold text-white uppercase tracking-wider\">{t('badges_collection') || 'Badge Collection'}</h3>\r\n                                </div>\r\n                                <div className=\"grid grid-cols-4 gap-y-6 gap-x-2\">\r\n                                    {displayUser.badges.map((b: any) => {\r\n                                        const config = BADGE_CONFIGS[b.badgeId];\r\n                                        if (!config) return null;\r\n                                        // On profile page, we usually only see earned badges\r\n                                        // But if we ever show all, we handle lock icon\r\n                                        const isEarned = true; // In current profile logic, badges array only has earned ones\r\n\r\n                                        return (\r\n                                            <div key={b.id} className=\"flex flex-col items-center gap-2\">\r\n                                                <button\r\n                                                    onClick={() => setSelectedBadgeId(b.badgeId)}\r\n                                                    className={`relative w-14 h-14 flex items-center justify-center rounded-full border-2 border-white/20 bg-gradient-to-br ${config.style} shadow-[0_4px_15px_rgba(0,0,0,0.3)] transform transition-transform hover:scale-110 active:scale-95 cursor-pointer`}\r\n                                                    title={t(config.nameKey)}\r\n                                                >\r\n                                                    <span className=\"text-5xl absolute transition-all duration-500 z-10 drop-shadow-2xl\">{config.icon}</span>\r\n                                                </button>\r\n                                                <div className=\"relative mt-[-20px] group z-40 w-full flex justify-center items-center pointer-events-none\">\r\n                                                    {/* Arched Ribbon Wings (Back) */}\r\n                                                    <div\r\n                                                        className={`absolute left-[calc(50%-36px)] top-3 w-8 h-4 -z-20 brightness-[0.3] bg-gradient-to-br ${config.style} [clip-path:polygon(100%_0,0_50%,100%_100%)] group-hover:left-[calc(50%-42px)] transition-all duration-300 shadow-2xl`}\r\n                                                    />\r\n                                                    <div\r\n                                                        className={`absolute right-[calc(50%-36px)] top-3 w-8 h-4 -z-20 brightness-[0.3] bg-gradient-to-br ${config.style} [clip-path:polygon(0_0,100%_50%,0_100%)] group-hover:right-[calc(50%-42px)] transition-all duration-300 shadow-2xl`}\r\n                                                    />\r\n\r\n                                                    {/* Fold Shadows */}\r\n                                                    <div className=\"absolute left-[calc(50%-26px)] top-1 w-3 h-5 -z-10 bg-black/60 skew-y-[30deg]\" />\r\n                                                    <div className=\"absolute right-[calc(50%-26px)] top-1 w-3 h-5 -z-10 bg-black/60 -skew-y-[30deg]\" />\r\n\r\n                                                    {/* Arched Ribbon Body (Front) */}\r\n                                                    <div className={`relative px-4 py-2 bg-gradient-to-br ${config.style} shadow-[0_8px_25px_rgba(0,0,0,0.7)] border-t border-white/50 min-w-[70px] max-w-[90px] flex items-center justify-center overflow-hidden\r\n                                                        [clip-path:polygon(0_15%,_50%_0%,_100%_15%,_100%_85%,_50%_100%,_0_85%)]\r\n                                                        before:absolute before:inset-0 before:bg-gradient-to-b before:from-white/30 before:to-transparent before:opacity-50\r\n                                                        after:absolute after:inset-0 after:bg-gradient-to-r after:from-black/30 after:via-transparent after:to-black/30`}>\r\n                                                        <span className={`relative z-10 text-[11px] font-black uppercase tracking-tight text-center leading-none transition-all duration-500 drop-shadow-[0_2px_4px_rgba(0,0,0,1)] whitespace-nowrap overflow-hidden text-ellipsis px-1 text-white`}>\r\n                                                            {t(config.nameKey)}\r\n                                                        </span>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </div>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            </div>\r\n                        )}\r\n\r\n                        {isOwnProfile && session?.user?.email && (\r\n                            <p className=\"text-gray-400 text-sm mt-2 mb-6\">{session.user.email}</p>\r\n                        )}\r\n\r\n                        {isOwnProfile && (\r\n                            <button\r\n                                onClick={() => signOut({ callbackUrl: \"/login\" })}\r\n                                className=\"flex items-center space-x-2 px-6 py-2 bg-red-500/20 text-red-200 rounded-full hover:bg-red-500/30 transition-colors border border-red-500/30 backdrop-blur-sm mt-4\"\r\n                            >\r\n                                <LogOut size={16} />\r\n                                <span>Sign Out</span>\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"mt-10 border-t border-white/10 pt-8\">\r\n                        <h3 className=\"text-sm font-semibold text-gray-400 uppercase tracking-wider mb-6 text-center\">Recent Activity</h3>\r\n                        {messagesLoading ? (\r\n                            <div className=\"text-center py-12 text-gray-500\">\r\n                                <p>Loading...</p>\r\n                            </div>\r\n                        ) : !userMessages || userMessages.length === 0 ? (\r\n                            <div className=\"text-center py-12 text-gray-500 bg-white/5 rounded-2xl border border-white/5 mx-4\">\r\n                                <p>No recent activity.</p>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"space-y-3 max-h-96 overflow-y-auto overflow-x-hidden pr-2 scrollbar-thin scrollbar-thumb-purple-500/50 scrollbar-track-transparent\">\r\n                                {userMessages.map((message: any) => (\r\n                                    <div\r\n                                        key={message.id}\r\n                                        onClick={() => {\r\n                                            router.push(`/?lat=${message.lat}&lng=${message.lng}`);\r\n                                        }}\r\n                                        className=\"bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl p-4 cursor-pointer transition-all hover:scale-[1.01] overflow-hidden\"\r\n                                    >\r\n                                        <div className=\"flex items-start justify-between\">\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <p className=\"text-white text-sm font-medium mb-1 break-words\">{message.text}</p>\r\n                                                <div className=\"flex items-center gap-2 text-xs text-gray-400 flex-wrap\">\r\n                                                    <MapPin size={12} className=\"flex-shrink-0\" />\r\n                                                    <span className=\"truncate\">{message.lat.toFixed(4)}, {message.lng.toFixed(4)}</span>\r\n                                                    <span>•</span>\r\n                                                    <span className=\"whitespace-nowrap\">{formatRelativeTime(message.timestamp)}</span>\r\n                                                </div>\r\n                                            </div>\r\n                                            {message.visibility === 'friends' && (\r\n                                                <div className=\"ml-2 px-2 py-1 bg-emerald-500/20 text-emerald-300 text-xs rounded-full border border-emerald-500/30 flex-shrink-0\">\r\n                                                    Friends\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <BadgeInfoModal\r\n                badgeId={selectedBadgeId}\r\n                isEarned={isOwnProfile ? (!!currentUser?.badges?.find((b: any) => b.badgeId === selectedBadgeId)) : (!!displayUser.badges?.find((b: any) => b.badgeId === selectedBadgeId))}\r\n                isActive={displayUser.activeBadgeId === selectedBadgeId}\r\n                canActivate={isOwnProfile}\r\n                onClose={() => setSelectedBadgeId(null)}\r\n                onActivate={async (id) => {\r\n                    if (!isOwnProfile) return;\r\n                    // Handle activation logic here for own profile\r\n                    try {\r\n                        const res = await fetch('/api/users/update', {\r\n                            method: 'PUT',\r\n                            headers: { 'Content-Type': 'application/json' },\r\n                            credentials: 'include',\r\n                            body: JSON.stringify({ activeBadgeId: id })\r\n                        });\r\n                        if (res.ok) {\r\n                            if (currentUser) {\r\n                                currentUser.activeBadgeId = id;\r\n                            }\r\n                            setSelectedBadgeId(null);\r\n                        }\r\n                    } catch (e) {\r\n                        console.error(e);\r\n                    }\r\n                }}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function ProfilePage() {\r\n    return (\r\n        <Suspense fallback={<div className=\"p-8 text-white flex justify-center mt-20\">Loading...</div>}>\r\n            <ProfileContent />\r\n        </Suspense>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\register\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\app\\share-test\\page.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":98,"column":37,"nodeType":"JSXOpeningElement","endLine":103,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Share as ShareIcon, ThumbsUp, ThumbsDown } from \"lucide-react\";\r\nimport Map from \"react-map-gl/mapbox\";\r\nimport { customMapStyle } from \"@/lib/mapboxStyle\";\r\n\r\nexport default function ShareTestPage() {\r\n    // Mock Data\r\n    const message = {\r\n        id: \"debug-123\",\r\n        text: \"Lorem ipsum dolor sit amet\",\r\n        userName: \"şenelimm\",\r\n        userImage: \"https://github.com/shadcn.png\", // Placeholder\r\n        timestamp: Date.now() - 1000 * 60 * 60 * 4, // 4 hours ago\r\n        likes: 12,\r\n        lat: 41.0082,\r\n        lng: 28.9784,\r\n    };\r\n\r\n    const isFriend = false; // Toggle to test colors\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-black flex flex-col items-center justify-center p-4 gap-8\">\r\n            <h1 className=\"text-white text-2xl font-bold\">Share Card Template Preview</h1>\r\n            <p className=\"text-white/60\">This is exactly how the hidden share card looks before being captured.</p>\r\n\r\n            {/* THE VISUAL TEMPLATE (Copied from MessageDetails.tsx) */}\r\n            <div\r\n                id={`share-card-${message.id}`}\r\n                className=\"w-[360px] h-[640px] relative bg-[#1a0033] flex flex-col overflow-hidden text-white shadow-2xl border border-white/10\"\r\n            >\r\n                {/* Background Map - Same as App */}\r\n                <div className=\"absolute inset-0 z-0\">\r\n                    <Map\r\n                        initialViewState={{\r\n                            longitude: message.lng,\r\n                            latitude: message.lat,\r\n                            zoom: 10.5\r\n                        }}\r\n                        mapStyle={customMapStyle as any}\r\n                        mapboxAccessToken={process.env.NEXT_PUBLIC_MAPBOX_TOKEN}\r\n                        attributionControl={false}\r\n                        preserveDrawingBuffer={true}\r\n                        style={{ width: '100%', height: '100%' }}\r\n                        interactive={false}\r\n                    />\r\n                </div>\r\n\r\n                {/* Central Content - The Bubble (Exact Replica) */}\r\n                <div className=\"relative z-10 flex-1 flex flex-col items-center justify-center p-8\">\r\n                    <div\r\n                        style={{\r\n                            display: 'flex',\r\n                            flexDirection: 'column',\r\n                            alignItems: 'center',\r\n                            filter: 'drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3))',\r\n                            transform: 'scale(1)',\r\n                            transformOrigin: 'center center'\r\n                        }}\r\n                    >\r\n                        {/* Chat bubble */}\r\n                        <div\r\n                            style={{\r\n                                position: 'relative',\r\n                                maxWidth: '240px',\r\n                                padding: '8px 12px 8px 8px',\r\n                                background: isFriend\r\n                                    ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%)'\r\n                                    : 'linear-gradient(135deg, rgba(123, 44, 191, 0.95) 0%, rgba(157, 78, 221, 0.95) 100%)',\r\n                                backdropFilter: 'blur(12px)',\r\n                                borderRadius: '24px',\r\n                                border: isFriend ? '1px solid rgba(52, 211, 153, 0.3)' : '1px solid rgba(199, 125, 255, 0.3)',\r\n                                boxShadow: isFriend\r\n                                    ? '0 8px 32px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.4)'\r\n                                    : '0 8px 32px rgba(123, 44, 191, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.4)',\r\n                                color: 'white',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: '10px',\r\n                            }}\r\n                        >\r\n                            {/* Shine effect */}\r\n                            <div style={{\r\n                                position: 'absolute',\r\n                                top: 0,\r\n                                left: 0,\r\n                                right: 0,\r\n                                height: '50%',\r\n                                background: 'linear-gradient(to bottom, rgba(255, 255, 255, 0.15), transparent)',\r\n                                borderRadius: '24px 24px 0 0',\r\n                                pointerEvents: 'none',\r\n                                zIndex: 0\r\n                            }} />\r\n\r\n                            {/* Avatar */}\r\n                            <div className=\"relative z-10 w-8 h-8 shrink-0\">\r\n                                {message.userImage ? (\r\n                                    <img\r\n                                        src={message.userImage}\r\n                                        alt={message.userName}\r\n                                        className=\"w-full h-full rounded-full object-cover border-2 border-white/20\"\r\n                                        crossOrigin=\"anonymous\"\r\n                                    />\r\n                                ) : (\r\n                                    <div className=\"w-full h-full rounded-full flex items-center justify-center border-2 border-white/20 text-xs font-bold bg-indigo-500\">\r\n                                        {message.userName.charAt(0).toUpperCase()}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Content */}\r\n                            <div className=\"flex flex-col relative z-10 min-w-0 flex-1\">\r\n                                <span style={{ fontSize: '14px', fontWeight: 500, lineHeight: 1.2 }}>\r\n                                    {message.text}\r\n                                </span>\r\n                                <div className=\"flex items-center mt-0.5 space-x-2\">\r\n                                    <span style={{ fontSize: '10px', color: 'rgba(255,255,255,0.7)', fontWeight: 600 }}>\r\n                                        {message.userName} • 4h ago\r\n                                    </span>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* NEW HEART LIKE BUTTON - Matches Map bubble design */}\r\n                            <div\r\n                                style={{\r\n                                    position: 'absolute',\r\n                                    bottom: '-6px',\r\n                                    right: '-6px',\r\n                                    zIndex: 100,\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    minWidth: '28px',\r\n                                    height: '28px',\r\n                                    padding: '0 8px',\r\n                                    borderRadius: '9999px',\r\n                                    background: 'rgba(0,0,0,0.6)',\r\n                                    border: '1px solid rgba(255,255,255,0.4)',\r\n                                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)',\r\n                                    backdropFilter: 'blur(12px)',\r\n                                    gap: '4px'\r\n                                }}\r\n                            >\r\n                                <svg\r\n                                    style={{ width: '12px', height: '12px', color: 'rgba(255,255,255,0.7)' }}\r\n                                    fill=\"none\"\r\n                                    viewBox=\"0 0 24 24\"\r\n                                    stroke=\"currentColor\"\r\n                                    strokeWidth={2}\r\n                                >\r\n                                    <path d=\"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z\" />\r\n                                </svg>\r\n                                {(message.likes || 0) > 0 && (\r\n                                    <span style={{ fontSize: '9px', fontWeight: 900, color: 'white', letterSpacing: '-0.025em' }}>\r\n                                        {message.likes}\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n\r\n                        </div>\r\n\r\n                        {/* Tail */}\r\n                        <div style={{\r\n                            width: 0,\r\n                            height: 0,\r\n                            borderLeft: '8px solid transparent',\r\n                            borderRight: '8px solid transparent',\r\n                            borderTop: isFriend ? '10px solid rgba(5, 150, 105, 0.95)' : '10px solid rgba(157, 78, 221, 0.95)',\r\n                            marginTop: '-1px',\r\n                            filter: 'drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2))'\r\n                        }} />\r\n\r\n\r\n                    </div>\r\n\r\n                    {/* Download CTA */}\r\n                    <div className=\"absolute bottom-12 w-full text-center z-20\">\r\n                        <div className=\"text-2xl font-bold tracking-tighter lowercase\" style={{\r\n                            background: 'linear-gradient(to right, #c084fc, #e879f9)',\r\n                            WebkitBackgroundClip: 'text',\r\n                            WebkitTextFillColor: 'transparent',\r\n                            filter: 'drop-shadow(0 0 10px rgba(192, 132, 252, 0.5))'\r\n                        }}>\r\n                            geogram\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\ActivePosts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\AppListeners.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\AuthPrompt.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\BadgeEarnedModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'config' and 'onClose'. Either include them or remove the dependency array. If 'onClose' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":50,"column":8,"nodeType":"ArrayExpression","endLine":50,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [badgeId, config, onClose]","fix":{"range":[1744,1753],"text":"[badgeId, config, onClose]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport confetti from \"canvas-confetti\";\r\nimport { useTranslation } from \"@/context/LocalizationContext\";\r\nimport { BADGE_CONFIGS } from \"@/lib/badgeConfig\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\n\r\ninterface BadgeEarnedModalProps {\r\n    badgeId: string;\r\n    onClose: () => void;\r\n}\r\n\r\nexport default function BadgeEarnedModal({ badgeId, onClose }: BadgeEarnedModalProps) {\r\n    const { t } = useTranslation();\r\n    const [show, setShow] = useState(false);\r\n    const config = BADGE_CONFIGS[badgeId];\r\n\r\n    useEffect(() => {\r\n        if (!config) {\r\n            onClose();\r\n            return;\r\n        }\r\n\r\n        // Delay showing slightly to ensure clean animation\r\n        const timer = setTimeout(() => setShow(true), 50);\r\n\r\n        const duration = 3 * 1000;\r\n        const animationEnd = Date.now() + duration;\r\n        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10002 };\r\n\r\n        const randomInRange = (min: number, max: number) => Math.random() * (max - min) + min;\r\n\r\n        const interval: any = setInterval(function () {\r\n            const timeLeft = animationEnd - Date.now();\r\n\r\n            if (timeLeft <= 0) {\r\n                return clearInterval(interval);\r\n            }\r\n\r\n            const particleCount = 50 * (timeLeft / duration);\r\n            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });\r\n            confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });\r\n        }, 250);\r\n\r\n        return () => {\r\n            clearTimeout(timer);\r\n            clearInterval(interval);\r\n        };\r\n    }, [badgeId]);\r\n\r\n    const handleClose = () => {\r\n        setShow(false);\r\n        // Wait for exit animation\r\n        setTimeout(onClose, 400);\r\n    };\r\n\r\n    if (!config) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-[10001] flex items-center justify-center p-4\">\r\n            <AnimatePresence>\r\n                {show && (\r\n                    <>\r\n                        <motion.div\r\n                            key=\"backdrop\"\r\n                            initial={{ opacity: 0 }}\r\n                            animate={{ opacity: 1 }}\r\n                            exit={{ opacity: 0 }}\r\n                            className=\"absolute inset-0 bg-black/90 backdrop-blur-md cursor-pointer\"\r\n                            onClick={handleClose}\r\n                        />\r\n\r\n                        <motion.div\r\n                            key=\"modal\"\r\n                            initial={{ scale: 0.5, opacity: 0, y: 50 }}\r\n                            animate={{ scale: 1, opacity: 1, y: 0 }}\r\n                            exit={{ scale: 0.5, opacity: 0, y: 50 }}\r\n                            transition={{ type: \"spring\", damping: 15, stiffness: 200 }}\r\n                            className=\"relative bg-[#1a0033] border-2 border-white/10 rounded-[40px] p-8 max-w-sm w-full shadow-2xl overflow-hidden pointer-events-auto z-10\"\r\n                            onClick={(e) => e.stopPropagation()}\r\n                        >\r\n                            {/* Background effects */}\r\n                            <div className={`absolute top-0 left-0 w-full h-full bg-gradient-to-br ${config.style} opacity-10`} />\r\n                            <div className=\"absolute -top-24 -right-24 w-48 h-48 bg-white/5 rounded-full blur-3xl opacity-50\" />\r\n\r\n                            <div className=\"relative flex flex-col items-center text-center\">\r\n                                <motion.div\r\n                                    initial={{ rotate: -20, scale: 0 }}\r\n                                    animate={{ rotate: 12, scale: 1 }}\r\n                                    transition={{ delay: 0.2, type: \"spring\" }}\r\n                                    className={`w-28 h-28 rounded-3xl bg-gradient-to-br ${config.style} flex items-center justify-center text-5xl mb-6 shadow-2xl`}\r\n                                >\r\n                                    {config.icon}\r\n                                </motion.div>\r\n\r\n                                <motion.h3\r\n                                    initial={{ opacity: 0, y: 10 }}\r\n                                    animate={{ opacity: 1, y: 0 }}\r\n                                    transition={{ delay: 0.4 }}\r\n                                    className=\"text-white/60 text-xs font-black uppercase tracking-[0.2em] mb-2\"\r\n                                >\r\n                                    NEW BADGE UNLOCKED\r\n                                </motion.h3>\r\n\r\n                                <motion.h2\r\n                                    initial={{ opacity: 0, y: 10 }}\r\n                                    animate={{ opacity: 1, y: 0 }}\r\n                                    transition={{ delay: 0.5 }}\r\n                                    className=\"text-3xl font-black text-white mb-4 leading-tight\"\r\n                                >\r\n                                    {t(config.nameKey)}\r\n                                </motion.h2>\r\n\r\n                                <motion.p\r\n                                    initial={{ opacity: 0 }}\r\n                                    animate={{ opacity: 1 }}\r\n                                    transition={{ delay: 0.6 }}\r\n                                    className=\"text-white/70 text-sm leading-relaxed mb-8\"\r\n                                >\r\n                                    {t(config.descKey)}\r\n                                </motion.p>\r\n\r\n                                <motion.button\r\n                                    initial={{ opacity: 0, y: 20 }}\r\n                                    animate={{ opacity: 1, y: 0 }}\r\n                                    transition={{ delay: 0.8 }}\r\n                                    onClick={handleClose}\r\n                                    className={`w-full py-4 bg-gradient-to-r ${config.style} rounded-2xl text-white font-bold shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all relative z-50 cursor-pointer`}\r\n                                >\r\n                                    {t('understood') || \"Awesome!\"}\r\n                                </motion.button>\r\n                            </div>\r\n                        </motion.div>\r\n                    </>\r\n                )}\r\n            </AnimatePresence>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\BadgeInfoModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\BottomMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\DailyLimitModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\DebugPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\DeepLinkListener.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\DeviceDetector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\FramerMotionProvider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\GeogramLogo.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\InputBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\LevelUpOverlay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\LoginModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\Map.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":85,"column":17,"nodeType":"JSXOpeningElement","endLine":85,"endColumn":95},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":106,"column":21,"nodeType":"JSXOpeningElement","endLine":106,"endColumn":104},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":184,"column":25,"nodeType":"JSXOpeningElement","endLine":184,"endColumn":108},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'latMV' and 'lngMV'. Either include them or remove the dependency array.","line":216,"column":8,"nodeType":"ArrayExpression","endLine":216,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [latMV, latitude, lngMV, longitude]","fix":{"range":[10202,10223],"text":"[latMV, latitude, lngMV, longitude]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":565,"column":33,"nodeType":"JSXOpeningElement","endLine":569,"endColumn":35},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedMessage'. Either include it or remove the dependency array.","line":981,"column":8,"nodeType":"ArrayExpression","endLine":981,"endColumn":39,"suggestions":[{"desc":"Update the dependencies array to be: [messages, selectedMessage, selectedMessage.id]","fix":{"range":[44451,44482],"text":"[messages, selectedMessage, selectedMessage.id]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setMessageDetailsOpen'. Either include it or remove the dependency array.","line":1030,"column":8,"nodeType":"ArrayExpression","endLine":1030,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [triggerLocationFocus, location, setMessageDetailsOpen]","fix":{"range":[46383,46415],"text":"[triggerLocationFocus, location, setMessageDetailsOpen]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setFocusedLocation'. Either include it or remove the dependency array.","line":1053,"column":8,"nodeType":"ArrayExpression","endLine":1053,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [focusedLocation, setFocusedLocation]","fix":{"range":[47265,47282],"text":"[focusedLocation, setFocusedLocation]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'exitingBubbles'. Either include it or remove the dependency array.","line":1308,"column":8,"nodeType":"ArrayExpression","endLine":1308,"endColumn":58,"suggestions":[{"desc":"Update the dependencies array to be: [postsToShowAsBubbles, filteredMessages, messages, exitingBubbles]","fix":{"range":[57737,57787],"text":"[postsToShowAsBubbles, filteredMessages, messages, exitingBubbles]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":2216,"column":53,"nodeType":"JSXOpeningElement","endLine":2216,"endColumn":152}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport MapGL, { Marker, NavigationControl, GeolocateControl, MapRef, Source, Layer } from \"react-map-gl/mapbox\";\r\nimport { useState, useEffect, useRef, useMemo } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { useLocation } from \"@/hooks/useLocation\";\r\nimport { useMessages } from \"@/hooks/useMessages\";\r\nimport { customMapStyle, FOG_CONFIG, COLORS } from \"@/lib/mapboxStyle\";\r\nimport { useConfig } from \"@/context/ConfigContext\";\r\nimport { Message } from \"@/lib/store\";\r\nimport { useSession } from \"next-auth/react\";\r\nimport { useUser } from \"@/hooks/useUser\";\r\nimport { useUI } from \"@/context/UIContext\";\r\nimport { UserPlus, Check, Clock, Search, X, ChevronLeft, ChevronRight } from \"lucide-react\";\r\nimport { m, AnimatePresence, animate, useMotionValue, useSpring, useMotionValueEvent } from \"framer-motion\";\r\nimport { memo } from \"react\";\r\nimport throttle from \"lodash/throttle\";\r\nimport MessageDetails from \"./MessageDetails\";\r\nimport { BADGE_CONFIGS } from \"@/lib/badgeConfig\";\r\n\r\nimport VoteControls from \"./VoteControls\";\r\nimport MapLayers, { FilterMode } from \"./MapLayers\";\r\nimport { useTranslation } from \"@/context/LocalizationContext\";\r\n\r\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_TOKEN;\r\n\r\n// --- PHASE 4: DEVICE PIXEL RATIO (DPI) CLAMPING (MODULE LEVEL) ---\r\n// We execute this immediately upon script load (before React Map GL mounts and reads it).\r\nif (typeof window !== 'undefined') {\r\n    const isAndroid = /android/i.test(navigator.userAgent);\r\n    // Removed `!!window.Capacitor` check because Capacitor might not be fully injected\r\n    // at the very millisecond this file is parsed, but the Android UserAgent is always present.\r\n    if (isAndroid && window.devicePixelRatio > 1.5) {\r\n        console.log(`[Phase 4] EARLY Clamping DPI from ${window.devicePixelRatio} to 1.5 for Mapbox WebView performance`);\r\n        try {\r\n            Object.defineProperty(window, 'devicePixelRatio', {\r\n                get: function () {\r\n                    return 1.5;\r\n                },\r\n                configurable: true // allow re-definition if necessary\r\n            });\r\n        } catch (e) {\r\n            console.error(\"Could not override devicePixelRatio:\", e);\r\n        }\r\n    }\r\n}\r\n// -----------------------------------------------------------------\r\n\r\n// Helper for relative time\r\nconst formatRelativeTime = (timestamp: number) => {\r\n    const now = Date.now();\r\n    const diff = now - timestamp;\r\n\r\n    // Minutes\r\n    const minutes = Math.floor(diff / 60000);\r\n    if (minutes < 1) return 'now';\r\n    if (minutes < 60) return `${minutes}m`;\r\n\r\n    // Hours\r\n    const hours = Math.floor(minutes / 60);\r\n    if (hours < 24) return `${hours}h`;\r\n\r\n    // Days\r\n    const days = Math.floor(hours / 24);\r\n    return `${days}d`;\r\n};\r\n\r\n\r\nconst UserAura = () => (\r\n    <>\r\n        <div className=\"absolute inset-0 bg-green-400/50 rounded-full animate-ping pointer-events-none\"></div>\r\n        <div className=\"absolute inset-0 bg-green-400/20 rounded-full animate-pulse blur-md pointer-events-none\"></div>\r\n        <div className=\"absolute -inset-2 bg-green-500/10 rounded-full animate-pulse blur-xl pointer-events-none\"></div>\r\n    </>\r\n);\r\n\r\n// Custom User Location Marker Component\r\nconst UserLocationMarker = memo(({ image, name }: { image?: string | null, name?: string | null }) => (\r\n    <div className=\"relative flex items-center justify-center w-10 h-10 cursor-default pointer-events-none\">\r\n        <UserAura />\r\n\r\n        {/* Avatar Container */}\r\n        <div className=\"relative w-8 h-8 rounded-full border-2 border-white shadow-[0_0_20px_rgba(34,197,94,0.6)] overflow-hidden bg-green-950 flex items-center justify-center\">\r\n            {image ? (\r\n                <img src={image} alt={name || \"You\"} className=\"w-full h-full object-cover\" />\r\n            ) : (\r\n                <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-green-500 to-emerald-600 text-white font-bold text-sm\">\r\n                    {name?.charAt(0).toUpperCase() || \"U\"}\r\n                </div>\r\n            )}\r\n        </div>\r\n    </div>\r\n));\r\nUserLocationMarker.displayName = 'UserLocationMarker';\r\n\r\nconst FriendMarker = memo(({ friend, onClick, showAura }: { friend: any, onClick?: () => void, showAura?: boolean }) => (\r\n    <div className=\"group relative cursor-pointer\" onClick={(e) => {\r\n        e.stopPropagation();\r\n        onClick?.();\r\n    }}>\r\n        <div className=\"relative flex items-center justify-center w-10 h-10\">\r\n            {showAura && <UserAura />}\r\n\r\n            <div className={`w-10 h-10 rounded-full border-2 ${showAura ? 'border-white shadow-[0_0_20px_rgba(16,185,129,0.5)]' : 'border-green-500'} shadow-lg overflow-hidden bg-black relative transform transition-transform group-hover:scale-110`}>\r\n                {friend.image ? (\r\n                    <img src={friend.image} alt={friend.name} className=\"w-full h-full object-cover\" />\r\n                ) : (\r\n                    <div className={`w-full h-full flex items-center justify-center ${showAura ? 'bg-emerald-600' : 'bg-green-600'} text-white font-bold`}>\r\n                        {friend.name?.charAt(0).toUpperCase() || (showAura ? 'U' : '?')}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {!showAura && (\r\n                <div className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-black ${friend.lastSeen && (Date.now() - new Date(friend.lastSeen).getTime() < 5 * 60 * 1000)\r\n                    ? 'bg-green-500'\r\n                    : 'bg-gray-500'\r\n                    }`}></div>\r\n            )}\r\n        </div>\r\n        {/* Tooltip */}\r\n        <div className=\"absolute top-full mt-1 bg-black/70 backdrop-blur-sm px-2 py-0.5 rounded-full border border-green-500/30 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center whitespace-nowrap pointer-events-none z-[1000]\">\r\n            <span className=\"text-[10px] text-white font-medium\">{isSelf(friend) ? 'You' : friend.name}</span>\r\n            {!isSelf(friend) && friend.lastSeen && (\r\n                <span className=\"text-[9px] text-gray-300\">\r\n                    {Date.now() - new Date(friend.lastSeen).getTime() < 5 * 60 * 1000\r\n                        ? 'Online'\r\n                        : `Seen ${formatRelativeTime(new Date(friend.lastSeen).getTime())} ago`}\r\n                </span>\r\n            )}\r\n        </div>\r\n    </div>\r\n));\r\nFriendMarker.displayName = 'FriendMarker';\r\n\r\nconst isSelf = (point: any) => point.id === 'self' || point.isSelf;\r\n\r\n// Orbital Layout Constants\r\nconst ORBITAL_RADIUS = 32; // Distance from center\r\nconst THRESHOLD_ZOOM_DECLUSTER = 18.2; // Zoom level where we show individual markers instead of just avatars\r\n\r\nconst FriendClusterMarker = memo(({ count, friends, onClick, stackIndex = 0 }: { count: number, friends: any[], onClick?: () => void, stackIndex?: number }) => {\r\n    // Each person is an individual marker. The leader (index 0) stays at center.\r\n    // Others orbit around at a smaller scale.\r\n    const person = friends[0];\r\n    const isUser = isSelf(person);\r\n\r\n    const isLeader = stackIndex === 0;\r\n\r\n    let translateX = 0;\r\n    let translateY = 0;\r\n    let scale = 1.0;\r\n\r\n    if (!isLeader) {\r\n        // Calculate orbital position based on index (offset from leader)\r\n        const followerIndex = stackIndex - 1;\r\n        const totalFollowers = Math.max(count - 1, 1);\r\n\r\n        // Distribute followers evenly around the circle\r\n        // Start from -90deg (top) for better visual balance\r\n        const angle = (followerIndex * (360 / totalFollowers) - 90) * (Math.PI / 180);\r\n\r\n        translateX = Math.cos(angle) * ORBITAL_RADIUS;\r\n        translateY = Math.sin(angle) * ORBITAL_RADIUS;\r\n        scale = 0.8; // Orbital avatars are slightly larger for symmetry\r\n    }\r\n\r\n    return (\r\n        <div\r\n            className=\"group relative cursor-pointer flex items-center justify-center\"\r\n            onClick={(e) => {\r\n                e.stopPropagation();\r\n                onClick?.();\r\n            }}\r\n            style={{\r\n                transform: `translate(${translateX}px, ${translateY}px) scale(${scale})`,\r\n                zIndex: isLeader ? 100 : 10 - stackIndex,\r\n            }}\r\n        >\r\n            <div className={`relative flex items-center justify-center ${isLeader ? 'w-10 h-10' : 'w-8 h-8'}`}>\r\n                {isUser && <UserAura />}\r\n                <div className={`${isLeader ? 'w-10 h-10' : 'w-8 h-8'} rounded-full border-2 ${isUser ? 'border-white shadow-[0_0_20px_rgba(16,185,129,0.5)]' : 'border-green-500'} shadow-lg overflow-hidden bg-black transform transition-transform group-hover:scale-110 ring-4 ring-black/20`}>\r\n                    {person.image ? (\r\n                        <img src={person.image} alt={person.name} className=\"w-full h-full object-cover\" />\r\n                    ) : (\r\n                        <div className={`w-full h-full flex items-center justify-center ${isUser ? 'bg-emerald-600' : 'bg-green-600'} text-white font-bold text-xs`}>\r\n                            {person.name?.charAt(0).toUpperCase() || (isUser ? 'U' : '?')}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n});\r\nFriendClusterMarker.displayName = 'FriendClusterMarker';\r\n\r\n\r\n// Smoothly Animated Marker Wrapper\r\nconst AnimatedMarker = memo(({ latitude, longitude, children, zIndex = 0, layoutId, ...props }: any) => {\r\n    // Motion values for momentum preservation\r\n    const latMV = useMotionValue(latitude);\r\n    const lngMV = useMotionValue(longitude);\r\n\r\n    // Spring configuration for snappy, organic movement\r\n    const springConfig = { stiffness: 400, damping: 40, mass: 1 };\r\n    const latSpring = useSpring(latMV, springConfig);\r\n    const lngSpring = useSpring(lngMV, springConfig);\r\n\r\n    // Current rendered coordinates (synced with spring)\r\n    const [coords, setCoords] = useState({ lat: latitude, lng: longitude });\r\n\r\n    // Update target when props change - useSpring handles the transition smoothly\r\n    useEffect(() => {\r\n        latMV.set(latitude);\r\n        lngMV.set(longitude);\r\n    }, [latitude, longitude]);\r\n\r\n    // Sync spring values back to state for react-map-gl Marker\r\n    useMotionValueEvent(latSpring, \"change\", (latest) => {\r\n        setCoords(prev => ({ ...prev, lat: latest }));\r\n    });\r\n    useMotionValueEvent(lngSpring, \"change\", (latest) => {\r\n        setCoords(prev => ({ ...prev, lng: latest }));\r\n    });\r\n\r\n    return (\r\n        <Marker {...props} latitude={coords.lat} longitude={coords.lng} style={{ transition: 'none', zIndex }}>\r\n            <m.div\r\n                layoutId={layoutId}\r\n                initial={{ scale: 0.5, opacity: 0 }}\r\n                animate={{ scale: 1, opacity: 1 }}\r\n                exit={{ scale: 0, opacity: 0 }}\r\n                style={{ willChange: 'transform' }}\r\n                transition={{\r\n                    type: \"spring\",\r\n                    stiffness: 300,\r\n                    damping: 25,\r\n                    mass: 0.5\r\n                }}\r\n            >\r\n                {children}\r\n            </m.div>\r\n        </Marker>\r\n    );\r\n});\r\nAnimatedMarker.displayName = 'AnimatedMarker';\r\n\r\n\r\n// Helper: Collision Avoidance (Reverse Magnet)\r\n// Represents a point on the map that pushes others away\r\ntype Repellor = {\r\n    lat: number;\r\n    lng: number;\r\n    radiusLat: number;\r\n    radiusLng: number;\r\n    strength: number; // 0 to 1\r\n    id?: string;\r\n};\r\n\r\n// Pushes a coordinate away from multiple repellors with smooth force\r\nconst applyRepulsion = (\r\n    lat: number,\r\n    lng: number,\r\n    originalLat: number,\r\n    originalLng: number,\r\n    repellors: Repellor[],\r\n    zoom: number,\r\n    ignoreExactMatches: boolean = true\r\n) => {\r\n    // Zoom bypass: don't move anything at world scale to preserve geographical integrity\r\n    if (zoom < 8) return { lat: originalLat, lng: originalLng };\r\n\r\n    let finalLat = lat;\r\n    let finalLng = lng;\r\n\r\n    repellors.forEach(r => {\r\n        // Skip repulsion if the point is exactly at the anchor (to keep marker tip locked)\r\n        if (ignoreExactMatches && Math.abs(lat - r.lat) < 0.000001 && Math.abs(lng - r.lng) < 0.000001) {\r\n            return;\r\n        }\r\n\r\n        // Shift repulsion center upwards because bubble/marker is usually anchored at bottom\r\n        // Clusters/Dots use center, but Bubbles (strength=1.0) use a shifted center\r\n        const centerLat = r.strength > 0.8 ? r.lat + (r.radiusLat * 0.7) : r.lat;\r\n\r\n        const dLat = finalLat - centerLat;\r\n        const dLng = finalLng - r.lng;\r\n\r\n        // Normalize by margins to check if inside the \"force field\"\r\n        const normLat = dLat / r.radiusLat;\r\n        const normLng = dLng / r.radiusLng;\r\n        const distSq = normLat * normLat + normLng * normLng;\r\n\r\n        if (distSq < 1.0 && distSq > 0.0000001) {\r\n            const dist = Math.sqrt(distSq);\r\n\r\n            if (r.strength > 0.8) {\r\n                // HARD EXCLUSION for Bubbles: force to edge immediately\r\n                const hardPush = (1.05 / dist);\r\n                finalLat = centerLat + (dLat * hardPush);\r\n                finalLng = r.lng + (dLng * hardPush);\r\n            } else {\r\n                // SOFT PUSH for Clusters/Dots\r\n                const force = (1.1 - dist) * r.strength;\r\n                const pushFactor = Math.min(1.2, force * 0.4);\r\n                finalLat += (dLat / dist) * pushFactor * r.radiusLat;\r\n                finalLng += (dLng / dist) * pushFactor * r.radiusLng;\r\n            }\r\n        }\r\n    });\r\n\r\n    // --- ORIGIN ANCHORING (Max 40px shift from original average) ---\r\n    // 40 pixels at zoom z: 40 * (360 / (512 * 2^z)) = 28.125 / 2^z\r\n    const maxShift = (28.125) / Math.pow(2, zoom);\r\n    const dLatTotal = finalLat - originalLat;\r\n    const dLngTotal = finalLng - originalLng;\r\n    const distTotalSq = dLatTotal * dLatTotal + dLngTotal * dLngTotal;\r\n\r\n    if (distTotalSq > maxShift * maxShift) {\r\n        const distTotal = Math.sqrt(distTotalSq);\r\n        const scale = maxShift / distTotal;\r\n        finalLat = originalLat + dLatTotal * scale;\r\n        finalLng = originalLng + dLngTotal * scale;\r\n    }\r\n\r\n    // --- RE-ENFORCE HARD EXCLUSION (Zero Tolerance) ---\r\n    // Ensure anchoring didn't push us back into a bubble\r\n    repellors.filter(r => r.strength > 0.8).forEach(r => {\r\n        const centerLat = r.lat + (r.radiusLat * 0.7);\r\n        const dLat = finalLat - centerLat;\r\n        const dLng = finalLng - r.lng;\r\n        const normLat = dLat / r.radiusLat;\r\n        const normLng = dLng / r.radiusLng;\r\n        const distSq = normLat * normLat + normLng * normLng;\r\n        if (distSq < 1.0 && distSq > 0.0000001) {\r\n            const dist = Math.sqrt(distSq);\r\n            const hardPush = (1.05 / dist);\r\n            finalLat = centerLat + (dLat * hardPush);\r\n            finalLng = r.lng + (dLng * hardPush);\r\n        }\r\n    });\r\n\r\n    // CRITICAL: Prevent \"Invalid LngLat\" errors by clamping coordinates\r\n    finalLat = Math.max(-89.9999, Math.min(89.9999, finalLat));\r\n\r\n    // Normalize Longitude to [-180, 180] range\r\n    while (finalLng > 180) finalLng -= 360;\r\n    return { lat: finalLat, lng: finalLng };\r\n};\r\n\r\nconst getNotchAngle = (lat: number, lng: number, origLat: number, origLng: number) => {\r\n    const dy = origLat - lat;\r\n    const dx = origLng - lng;\r\n    return (Math.atan2(dy, dx) * 180 / Math.PI) * -1;\r\n};\r\n\r\nconst getPixelDistance = (lat1: number, lng1: number, lat2: number, lng2: number, zoom: number) => {\r\n    const pixelsPerDegree = (512 * Math.pow(2, zoom)) / 360;\r\n    const dy = (lat1 - lat2) * pixelsPerDegree;\r\n    const dx = (lng1 - lng2) * pixelsPerDegree * Math.cos(lat1 * Math.PI / 180);\r\n    return Math.sqrt(dx * dx + dy * dy);\r\n};\r\n\r\n\r\n\r\n\r\n\r\n\r\n// Message Marker Component\r\n// Premium Message Bubble Component\r\n// --- Configuration ---\r\nconst FOCUS_CONFIG = {\r\n    verticalBand: 0.45,   // Total height percentage (0.35 = 35% of screen)\r\n    horizontalBand: 0.45, // Total width percentage (0.20 = 20% of screen)\r\n};\r\n\r\nconst MessageMarker = ({\r\n    message,\r\n    onClick,\r\n    onVote,\r\n    currentUser,\r\n    unlimitedVotes = false,\r\n    isSelected = false,\r\n    isNearCenter = true,\r\n    showActions = false, // Controlled by parent based on screen center proximity\r\n    zoom = 12,\r\n    isExiting = false\r\n}: {\r\n    message: Message & { hiddenCount?: number };\r\n    onClick?: (e?: React.MouseEvent) => void;\r\n    onVote?: (id: string, action: 'like' | 'dislike', unlimited: boolean) => void;\r\n    currentUser?: any;\r\n    unlimitedVotes?: boolean;\r\n    isSelected?: boolean;\r\n    isNearCenter?: boolean;\r\n    showActions?: boolean;\r\n    zoom?: number;\r\n    isExiting?: boolean;\r\n}) => {\r\n    // Animation state to prevent re-triggering classes on every render\r\n    const [isVisible, setIsVisible] = useState(false);\r\n    useEffect(() => {\r\n        setIsVisible(true);\r\n    }, []);\r\n\r\n    const { t } = useTranslation();\r\n\r\n\r\n    // Determine display mode:\r\n    // 1. Rely solely on clustering logic (passed as isNearCenter)\r\n    const shouldShowAsBubble = isNearCenter;\r\n    const showAsDot = !shouldShowAsBubble;\r\n\r\n    if (showAsDot) {\r\n        return (\r\n            <div\r\n                onClick={onClick}\r\n                className=\"cursor-pointer group pointer-events-auto\"\r\n                style={{\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    alignItems: 'center',\r\n                }}\r\n            >\r\n                <div className=\"relative\">\r\n                    {/* Larger, more prominent dot */}\r\n                    <div\r\n                        className=\"w-3.5 h-3.5 rounded-full border-2 border-white shadow-[0_0_10px_rgba(255,255,255,0.4)] transition-all hover:scale-150\"\r\n                        style={{\r\n                            background: message.visibility === 'friends'\r\n                                ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'\r\n                                : 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)'\r\n                        }}\r\n                    />\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    const isFriends = message.visibility === 'friends';\r\n    const isFriendUser = currentUser?.friends?.some((f: any) => f.id === message.userId) || false;\r\n\r\n    // CSS Variables for dynamic coloring\r\n    const isPremium = message.userIsPremium; // Assumes we add this field to message/user store or API response\r\n\r\n    const bubbleStyle = {\r\n        '--bubble-bg': isFriends\r\n            ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%)'\r\n            : isPremium\r\n                ? 'linear-gradient(135deg, rgba(255, 215, 0, 0.9) 0%, rgba(218, 165, 32, 0.9) 100%)' // Premium Gold\r\n                : 'linear-gradient(135deg, rgba(123, 44, 191, 0.95) 0%, rgba(157, 78, 221, 0.95) 100%)',\r\n        '--bubble-border': isFriends\r\n            ? '1px solid rgba(52, 211, 153, 0.3)'\r\n            : isPremium\r\n                ? '1px solid rgba(255, 223, 0, 0.6)' // Premium Gold Border\r\n                : '1px solid rgba(199, 125, 255, 0.3)',\r\n        '--bubble-shadow': isFriends\r\n            ? '0 8px 32px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)'\r\n            : isPremium\r\n                ? '0 8px 32px rgba(255, 215, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.4)' // Gold Glow\r\n                : '0 8px 32px rgba(123, 44, 191, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)',\r\n        '--bubble-shadow-hover': isFriends\r\n            ? '0 12px 40px rgba(16, 185, 129, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3)'\r\n            : isPremium\r\n                ? '0 12px 40px rgba(255, 215, 0, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.5)' // Stronger Gold Glow\r\n                : '0 12px 40px rgba(157, 78, 221, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3)',\r\n        '--tail-color': isFriends\r\n            ? 'rgba(5, 150, 105, 0.95)'\r\n            : isPremium\r\n                ? 'rgba(218, 165, 32, 0.9)'\r\n                : 'rgba(157, 78, 221, 0.95)',\r\n        '--outline': 'none',\r\n        zIndex: (isFriends ? 1000 : isPremium ? 500 : 0) + (message.likes || 0) + 10,\r\n        // Combined Scale/Opacity logic\r\n        opacity: (isVisible && !isExiting) ? 1 : 0,\r\n        transform: (isVisible && !isExiting) ? 'scale(1)' : 'scale(0)',\r\n        transformOrigin: 'bottom center',\r\n        transition: 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease'\r\n    } as React.CSSProperties;\r\n\r\n    return (\r\n        <div\r\n            onClick={(e) => {\r\n                e.stopPropagation();\r\n                onClick?.(e);\r\n            }}\r\n            className=\"cursor-pointer group pointer-events-auto message-container\"\r\n            style={bubbleStyle}\r\n        >\r\n            <div className=\"relative\">\r\n                {/* Own-post 'You' badge - Top Center */}\r\n                {currentUser?.id === message.userId && (\r\n                    <div\r\n                        style={{\r\n                            position: 'absolute',\r\n                            top: '-18px',\r\n                            left: '50%',\r\n                            transform: 'translateX(-50%)',\r\n                            zIndex: 110,\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            gap: '3px',\r\n                            padding: '2px 8px',\r\n                            borderRadius: '999px',\r\n                            background: 'rgba(0,0,0,0.55)',\r\n                            backdropFilter: 'blur(10px)',\r\n                            border: '1px solid rgba(255,255,255,0.35)',\r\n                            boxShadow: '0 2px 8px rgba(0,0,0,0.4)',\r\n                            whiteSpace: 'nowrap',\r\n                            pointerEvents: 'none'\r\n                        }}\r\n                    >\r\n                        <div style={{\r\n                            width: '6px',\r\n                            height: '6px',\r\n                            borderRadius: '50%',\r\n                            background: 'linear-gradient(135deg, #a855f7, #7c3aed)',\r\n                            flexShrink: 0\r\n                        }} />\r\n                        <span style={{\r\n                            fontSize: '9px',\r\n                            fontWeight: 700,\r\n                            color: 'rgba(255,255,255,0.9)',\r\n                            letterSpacing: '0.05em',\r\n                            textTransform: 'uppercase'\r\n                        }}>\r\n                            {t(\"you_badge\") || \"You\"}\r\n                        </span>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Chat bubble */}\r\n                <div className=\"message-bubble\">\r\n                    {/* Clustering Badge - Top Left - Larger */}\r\n                    {(message.hiddenCount ?? 0) > 0 && (\r\n                        <div className=\"absolute -top-3 -left-3 bg-gradient-to-br from-purple-400 to-purple-600 text-white text-sm font-bold w-8 h-8 flex items-center justify-center rounded-full border-2 border-purple-900 shadow-lg z-10\">\r\n                            +{message.hiddenCount}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Shine effect */}\r\n                    <div className=\"bubble-shine\" />\r\n\r\n                    {/* User Avatar - Hide if anonymous */}\r\n                    {!message.isAnonymous && (\r\n                        <div className=\"relative z-10 w-8 h-8 shrink-0 message-avatar\">\r\n                            {/* Premium Crown - Absolute Position Top Right of Avatar */}\r\n                            {isPremium && !message.activeBadgeId && (\r\n                                <div className=\"absolute -top-1.5 -right-1.5 z-20 bg-yellow-400 text-yellow-900 rounded-full w-4 h-4 flex items-center justify-center shadow-md animate-bounce-slow border border-white\">\r\n                                    <span className=\"text-[10px]\">👑</span>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Active User Badge - Absolute Position Top Right of Avatar */}\r\n                            {message.activeBadgeId && BADGE_CONFIGS[message.activeBadgeId] && (\r\n                                <div\r\n                                    title={t(BADGE_CONFIGS[message.activeBadgeId].nameKey)}\r\n                                    className={`absolute -top-2 -right-2 z-20 flex items-center justify-center w-5 h-5 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[message.activeBadgeId].style} text-[10px] shadow-sm transform rotate-12 ring-1 ring-white/20`}\r\n                                >\r\n                                    {BADGE_CONFIGS[message.activeBadgeId].icon}\r\n                                </div>\r\n                            )}\r\n\r\n                            {message.userImage ? (\r\n                                <img\r\n                                    src={message.userImage}\r\n                                    alt={message.userName}\r\n                                    className={`w-full h-full rounded-full object-cover border-2 ${isPremium ? 'border-yellow-400' : isFriendUser ? 'border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'border-white/20'}`}\r\n                                />\r\n                            ) : (\r\n                                <div className={`w-full h-full rounded-full flex items-center justify-center border-2 text-xs font-bold ${isPremium ? 'bg-gradient-to-br from-yellow-500 to-orange-500 border-yellow-300' : isFriendUser ? 'bg-green-600 border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-indigo-500 border-white/20'}`}>\r\n                                    {message.userName.charAt(0).toUpperCase()}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Content */}\r\n                    <div className=\"flex flex-col relative z-10 min-w-0 flex-1 message-content pr-5\">\r\n                        <span className=\"message-text\">\r\n                            {message.text}\r\n                        </span>\r\n                        <div className=\"flex items-center mt-0.5 space-x-2\">\r\n                            <span className=\"message-meta\">\r\n                                {!message.isAnonymous && <>{message.userName} • </>}\r\n                                {formatRelativeTime(message.timestamp)}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* PREMIUM DIRECT LIKE BUTTON - Bottom Right Corner */}\r\n                {showActions && !isExiting && (\r\n                    <div className=\"absolute -bottom-1.5 -right-1.5 z-[100] flex items-center\">\r\n                        <m.button\r\n                            initial={false}\r\n                            whileHover={{ scale: 1.1 }}\r\n                            whileTap={{ scale: 0.9 }}\r\n                            onClick={(e) => {\r\n                                e.stopPropagation();\r\n                                onVote?.(message.id, 'like', unlimitedVotes);\r\n                            }}\r\n                            className={`relative flex items-center justify-center min-w-[28px] h-7 px-2 rounded-full border border-white/40 shadow-[0_4px_12px_rgba(0,0,0,0.3)] backdrop-blur-xl transition-colors duration-500 gap-1 overflow-hidden group ${message.likedBy?.includes(currentUser?.id)\r\n                                ? 'bg-gradient-to-br from-pink-500 to-rose-600 border-white/60 shadow-[0_0_15px_rgba(244,63,94,0.4)]'\r\n                                : 'bg-black/60 hover:bg-black/80'\r\n                                }`}\r\n                        >\r\n                            {/* Splash Ripple Effect */}\r\n                            {message.likedBy?.includes(currentUser?.id) && (\r\n                                <m.div\r\n                                    initial={{ scale: 0, opacity: 0.5 }}\r\n                                    animate={{ scale: 3, opacity: 0 }}\r\n                                    transition={{ duration: 0.6, ease: \"easeOut\" }}\r\n                                    className=\"absolute inset-0 bg-white rounded-full pointer-events-none\"\r\n                                />\r\n                            )}\r\n\r\n                            {/* Heart Icon with Heartbeat */}\r\n                            <m.div\r\n                                animate={message.likedBy?.includes(currentUser?.id) ? {\r\n                                    scale: [1, 1.2, 1],\r\n                                } : { scale: 1 }}\r\n                                transition={{\r\n                                    duration: 0.8,\r\n                                    repeat: Infinity,\r\n                                    repeatDelay: 1\r\n                                }}\r\n                            >\r\n                                <svg\r\n                                    className={`w-3 h-3 transition-colors duration-300 ${message.likedBy?.includes(currentUser?.id) ? 'text-white' : 'text-white/70'}`}\r\n                                    fill={message.likedBy?.includes(currentUser?.id) ? \"white\" : \"none\"}\r\n                                    viewBox=\"0 0 24 24\"\r\n                                    stroke=\"currentColor\"\r\n                                    strokeWidth={message.likedBy?.includes(currentUser?.id) ? 0 : 2}\r\n                                >\r\n                                    <path d=\"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z\" />\r\n                                </svg>\r\n                            </m.div>\r\n\r\n                            {/* Animated Like Count */}\r\n                            <AnimatePresence mode=\"wait\">\r\n                                {(message.likes || 0) > 0 && (\r\n                                    <m.span\r\n                                        key={message.likes}\r\n                                        initial={{ y: 5, opacity: 0 }}\r\n                                        animate={{ y: 0, opacity: 1 }}\r\n                                        exit={{ y: -5, opacity: 0 }}\r\n                                        className=\"text-[9px] font-black text-white pr-0.5 tracking-tight\"\r\n                                    >\r\n                                        {message.likes}\r\n                                    </m.span>\r\n                                )}\r\n                            </AnimatePresence>\r\n                        </m.button>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Tail/pointer */}\r\n            <div className=\"bubble-tail\" />\r\n\r\n            <style jsx>{`\r\n                .message-container {\r\n                    display: flex;\r\n                    flex-direction: column;\r\n                    align-items: center;\r\n                    filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));\r\n                    z-index: var(--zIndex);\r\n                }\r\n\r\n                .message-bubble {\r\n                    position: relative;\r\n                    max-width: 240px;\r\n                    padding: 8px 12px 8px 8px;\r\n                    background: var(--bubble-bg);\r\n                    backdrop-filter: blur(12px);\r\n                    border-radius: 24px;\r\n                    border: var(--bubble-border);\r\n                    box-shadow: var(--bubble-shadow);\r\n                    color: white;\r\n                    display: flex;\r\n                    align-items: center;\r\n                    gap: 10px;\r\n                    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;\r\n                    outline: var(--outline);\r\n                    outline-offset: 2px;\r\n                    /* More visible white outline for contrast against purple map */\r\n                    z-index: 10; /* Ensure bubble is on top of sidebar */\r\n                }\r\n\r\n                /* Disable expensive blur on Android WebViews for major performance boost */\r\n                @supports (-webkit-touch-callout: none) == false {\r\n                    .capacitor-android .message-bubble {\r\n                        backdrop-filter: none;\r\n                        background: rgba(30,30,30,0.9); /* Solid fallback */\r\n                    }\r\n                }\r\n\r\n                .message-bubble:hover {\r\n\r\n                    transform: translateY(-4px) scale(1.05);\r\n                    box-shadow: var(--bubble-shadow-hover);\r\n                }\r\n\r\n                .bubble-shine {\r\n                    position: absolute;\r\n                    top: 0;\r\n                    left: 0;\r\n                    right: 0;\r\n                    height: 50%;\r\n                    background: linear-gradient(to bottom, rgba(255, 255, 255, 0.15), transparent);\r\n                    border-radius: 24px 24px 0 0;\r\n                    pointer-events: none;\r\n                    z-index: 0;\r\n                }\r\n\r\n                .bubble-tail {\r\n                    width: 0;\r\n                    height: 0;\r\n                    border-left: 8px solid transparent;\r\n                    border-right: 8px solid transparent;\r\n                    border-top: 10px solid var(--tail-color);\r\n                    margin-top: -1px;\r\n                    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));\r\n                }\r\n\r\n                .message-text {\r\n                    font-size: 14px;\r\n                    font-weight: 500;\r\n                    line-height: 1.2;\r\n                }\r\n\r\n                .message-meta {\r\n                    font-size: 10px;\r\n                    color: rgba(255,255,255,0.7);\r\n                    font-weight: 600;\r\n                }\r\n\r\n                .vote-animate {\r\n                    animation: voteClick 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);\r\n                }\r\n\r\n                @keyframes voteClick {\r\n                    0% { transform: scale(1); }\r\n                    25% { transform: scale(1.3) rotate(-10deg); }\r\n                    50% { transform: scale(1.1) rotate(5deg); }\r\n                    75% { transform: scale(1.15) rotate(-3deg); }\r\n                    100% { transform: scale(1); }\r\n                }\r\n\r\n                @media (max-width: 768px) {\r\n                    .message-bubble {\r\n                        max-width: 180px !important;\r\n                        padding: 6px 10px 6px 6px !important;\r\n                        gap: 8px !important;\r\n                    }\r\n                    .message-avatar {\r\n                        width: 28px !important;\r\n                        height: 28px !important;\r\n                    }\r\n                    .message-text {\r\n                        font-size: 12px !important;\r\n                    }\r\n                    .message-meta {\r\n                        font-size: 9px !important;\r\n                    }\r\n                    .vote-badge {\r\n                .vote-badge svg {\r\n                        width: 10px !important;\r\n                        height: 10px !important;\r\n                    }\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default function MapComponent() {\r\n    const router = useRouter();\r\n\r\n    // --- MAP PROJECTION (2D / 3D) ---\r\n    // Persisted in localStorage so the setting survives reloads.\r\n    // SettingsView writes 'mercator' or 'globe' to this key.\r\n    const [mapProjection, setMapProjection] = useState<'globe' | 'mercator'>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            const saved = localStorage.getItem('geogram_map_projection');\r\n            return saved === 'mercator' ? 'mercator' : 'globe';\r\n        }\r\n        return 'globe';\r\n    });\r\n\r\n    // Listen for settings changes from SettingsView (same-tab StorageEvent dispatch)\r\n    useEffect(() => {\r\n        const onStorage = (e: StorageEvent) => {\r\n            if (e.key === 'geogram_map_projection') {\r\n                setMapProjection(e.newValue === 'mercator' ? 'mercator' : 'globe');\r\n            }\r\n            if (e.key === 'geogram_map_buildings') {\r\n                setShow3DBuildings(e.newValue !== 'false');\r\n            }\r\n            if (e.key === 'geogram_map_terrain') {\r\n                setShow3DTerrain(e.newValue === 'true');\r\n            }\r\n            if (e.key === 'geogram_map_poi') {\r\n                setShowPOI(e.newValue === 'true');\r\n            }\r\n            if (e.key === 'geogram_map_transit') {\r\n                setShowTransit(e.newValue === 'true');\r\n            }\r\n        };\r\n        window.addEventListener('storage', onStorage);\r\n        return () => window.removeEventListener('storage', onStorage);\r\n    }, []);\r\n\r\n    // 3D Buildings toggle\r\n    const [show3DBuildings, setShow3DBuildings] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_buildings') !== 'false';\r\n        }\r\n        return true;\r\n    });\r\n\r\n    // 3D Terrain toggle\r\n    const [show3DTerrain, setShow3DTerrain] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_terrain') === 'true';\r\n        }\r\n        return false;\r\n    });\r\n\r\n    // POI & Place Labels toggle\r\n    const [showPOI, setShowPOI] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_poi') === 'true';\r\n        }\r\n        return false;\r\n    });\r\n\r\n    // Road & Transit Network toggle\r\n    const [showTransit, setShowTransit] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_transit') === 'true';\r\n        }\r\n        return false;\r\n    });\r\n\r\n    const { t } = useTranslation();\r\n    const { location, error: locationError } = useLocation();\r\n    const { messages, voteMessage, deleteMessage } = useMessages();\r\n    const mapRef = useRef<MapRef>(null);\r\n    const [isMapLoaded, setIsMapLoaded] = useState(false);\r\n\r\n\r\n    // --- CONSOLIDATED MAP SETTINGS SYNC ---\r\n    const syncMapSettings = useMemo(() => {\r\n        return () => {\r\n            const map = mapRef.current?.getMap();\r\n            if (!map || !isMapLoaded) return;\r\n\r\n            try {\r\n                // Projection\r\n                map.setProjection(mapProjection as any);\r\n\r\n                // 3D Buildings\r\n                const buildVis = show3DBuildings ? 'visible' : 'none';\r\n                if (map.getLayer('building-3d')) map.setLayoutProperty('building-3d', 'visibility', buildVis);\r\n\r\n                // POI & Place Labels\r\n                const poiVis = showPOI ? 'visible' : 'none';\r\n                if (map.getLayer('poi-label-general')) map.setLayoutProperty('poi-label-general', 'visibility', poiVis);\r\n\r\n                // Settlement labels should stay visible for navigation\r\n                if (map.getLayer('place-city-major')) map.setLayoutProperty('place-city-major', 'visibility', 'visible');\r\n                if (map.getLayer('place-town')) map.setLayoutProperty('place-town', 'visibility', 'visible');\r\n                if (map.getLayer('place-neighborhood')) map.setLayoutProperty('place-neighborhood', 'visibility', 'visible');\r\n\r\n                // Road & Transit Network\r\n                const transitVis = showTransit ? 'visible' : 'none';\r\n                if (map.getLayer('aeroway-area')) map.setLayoutProperty('aeroway-area', 'visibility', transitVis);\r\n                if (map.getLayer('aeroway-line')) map.setLayoutProperty('aeroway-line', 'visibility', transitVis);\r\n                if (map.getLayer('transit-railway')) map.setLayoutProperty('transit-railway', 'visibility', transitVis);\r\n                if (map.getLayer('airport-label')) map.setLayoutProperty('airport-label', 'visibility', transitVis);\r\n                if (map.getLayer('transit-stop-label')) map.setLayoutProperty('transit-stop-label', 'visibility', transitVis);\r\n\r\n                // Terrain\r\n                if (show3DTerrain) {\r\n                    if (!map.getSource('mapbox-dem')) {\r\n                        map.addSource('mapbox-dem', {\r\n                            type: 'raster-dem',\r\n                            url: 'mapbox://mapbox.mapbox-terrain-dem-v1',\r\n                            tileSize: 512,\r\n                            maxzoom: 14\r\n                        });\r\n                    }\r\n                    map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });\r\n                } else {\r\n                    map.setTerrain(null as any);\r\n                }\r\n            } catch (e) { console.warn(\"Sync map settings error:\", e); }\r\n        };\r\n    }, [isMapLoaded, mapProjection, show3DBuildings, showPOI, showTransit, show3DTerrain]);\r\n\r\n    // Apply sync whenever states or map load status change\r\n    useEffect(() => {\r\n        syncMapSettings();\r\n    }, [syncMapSettings]);\r\n    // ---------------------------------------------------\r\n    const { data: session } = useSession();\r\n\r\n    const [viewState, setViewState] = useState({\r\n        latitude: 20, // World centerish\r\n        longitude: 0,\r\n        zoom: 2, // Start zoomed out (Space/World view)\r\n    });\r\n\r\n    const [showDetails, setShowDetails] = useState<boolean>(false);\r\n    const [detailsMessage, setDetailsMessage] = useState<Message | null>(null);\r\n    const [selectedFriend, setSelectedFriend] = useState<any | null>(null);\r\n\r\n    // Track programmatic movements to avoid closing popup during flyTo\r\n    const isProgrammaticMove = useRef(false);\r\n\r\n    const [selectedMessage, setSelectedMessage] = useState<Message | null>(null);\r\n    const [activeGroupIndex, setActiveGroupIndex] = useState<Record<string, number>>({});\r\n    const [locationName, setLocationName] = useState<string | null>(null);\r\n\r\n    const { expirationHours, minLikesForZoom, isSimulationMode, unlimitedVotes, clusterRadius } = useConfig();\r\n    const { user: currentUserData, handleFriendRequest } = useUser();\r\n    const { isMessageDetailsOpen, setMessageDetailsOpen, triggerLocationFocus, focusedLocation, setFocusedLocation } = useUI();\r\n\r\n    const [filterMode, setFilterMode] = useState<FilterMode>('all');\r\n    const [isLayersOpen, setIsLayersOpen] = useState(false);\r\n\r\n    // Track exiting bubbles for closing animation\r\n    const [exitingBubbles, setExitingBubbles] = useState<Record<string, Message>>({});\r\n    const previousBubblesSet = useRef<Set<string>>(new Set());\r\n\r\n    // Helper to check friend status\r\n    const getFriendStatus = (targetUserId: string) => {\r\n        if (!currentUserData) return 'none';\r\n        if (currentUserData.friends.some(f => f.id === targetUserId)) return 'friend';\r\n        if (currentUserData.friendRequests.outgoing.some(f => f.id === targetUserId)) return 'sent';\r\n        if (currentUserData.friendRequests.incoming.some(f => f.id === targetUserId)) return 'received';\r\n        if (currentUserData.id === targetUserId) return 'self';\r\n        return 'none';\r\n    };\r\n\r\n    const onAddFriend = async (targetUserId: string) => {\r\n        if (!currentUserData) return;\r\n        await handleFriendRequest(targetUserId, 'send');\r\n    };\r\n\r\n\r\n    // Update Location - Use GPS exclusively\r\n    useEffect(() => {\r\n        const interval = setInterval(() => {\r\n            if (currentUserData && location) {\r\n                // Use actual GPS location from useLocation hook\r\n                fetch('/api/users/location', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        lat: location.lat,\r\n                        lng: location.lng\r\n                    })\r\n                }).catch(err => console.error(\"Location update failed\", err));\r\n            }\r\n        }, 10000); // Every 10 seconds\r\n\r\n        return () => clearInterval(interval);\r\n    }, [currentUserData, location]);\r\n\r\n    // Update selected message if it's updated in the global list\r\n    useEffect(() => {\r\n        if (selectedMessage) {\r\n            const updated = messages.find(m => m.id === selectedMessage.id);\r\n            if (updated) {\r\n                setSelectedMessage(updated);\r\n            }\r\n        }\r\n    }, [messages, selectedMessage?.id]);\r\n\r\n    // Viewport bounds for optimization\r\n    const [viewportBounds, setViewportBounds] = useState<mapboxgl.LngLatBounds | null>(null);\r\n\r\n    // Track if we have already centered on user location to prevent loops\r\n    const hasCentered = useRef(false);\r\n\r\n    // REMOVED: Do not restore state from localStorage. Always start from World View.\r\n    // useEffect(() => { ... }, []); \r\n\r\n\r\n    // Force Center on User Location when available (Initial Load Only)\r\n    // AND wait for map to be loaded\r\n    useEffect(() => {\r\n        if (location && isMapLoaded && !hasCentered.current) {\r\n            console.log(\"📍 Centering map on user location (FlyTo):\", location);\r\n\r\n            // Fly down to the user's location from the initial World View\r\n            if (mapRef.current) {\r\n                mapRef.current.flyTo({\r\n                    center: [location.lng, location.lat],\r\n                    zoom: 12, // Target zoom\r\n                    duration: 3500, // Cinematic flight\r\n                    essential: true\r\n                });\r\n                hasCentered.current = true;\r\n            }\r\n        }\r\n    }, [location, isMapLoaded]);\r\n\r\n    // Listen for manual location focus trigger\r\n    useEffect(() => {\r\n        if (triggerLocationFocus > 0 && location && mapRef.current) {\r\n            console.log(\"📍 Manual FlyTo Triggered\");\r\n\r\n            // Close any open message details to reset UI state\r\n            setSelectedMessage(null);\r\n            setMessageDetailsOpen(false);\r\n\r\n            mapRef.current.flyTo({\r\n                center: [location.lng, location.lat],\r\n                zoom: 15, // Closer zoom for manual focus\r\n                padding: { top: 0, bottom: 0, left: 0, right: 0 }, // Reset any padding (especially from message details)\r\n                speed: 1.5,\r\n                curve: 1.42,\r\n                essential: true\r\n            });\r\n        }\r\n    }, [triggerLocationFocus, location]);\r\n\r\n    // Listen for focused location trigger (from ActivePosts etc)\r\n    useEffect(() => {\r\n        if (focusedLocation && mapRef.current) {\r\n            console.log(\"📍 Focused Location FlyTo Triggered:\", focusedLocation);\r\n\r\n            // Close any open message details if necessary, \r\n            // but might want to keep it open if we're flying to a specific post?\r\n            // For now, let's keep it simple.\r\n\r\n            mapRef.current.flyTo({\r\n                center: [focusedLocation.lng, focusedLocation.lat],\r\n                zoom: focusedLocation.zoom || 15,\r\n                padding: { top: 0, bottom: 0, left: 0, right: 0 },\r\n                speed: 1.5,\r\n                curve: 1.42,\r\n                essential: true\r\n            });\r\n\r\n            // Reset after move\r\n            setFocusedLocation(null);\r\n        }\r\n    }, [focusedLocation]);\r\n\r\n    // Save Map State on Move\r\n    const handleMoveStart = (evt: any) => {\r\n        // Reset carousel navigation to leader as soon as the user starts moving the map\r\n        if (!isProgrammaticMove.current) {\r\n            setActiveGroupIndex({});\r\n        }\r\n    };\r\n\r\n    const handleMoveEnd = (evt: any) => {\r\n        if (evt.target) {\r\n            // Immediately save simple state for localStorage\r\n            const newState = evt.viewState;\r\n            setViewState(newState);\r\n\r\n            try {\r\n                localStorage.setItem('geogram_map_view_state', JSON.stringify({\r\n                    latitude: newState.latitude,\r\n                    longitude: newState.longitude,\r\n                    zoom: newState.zoom\r\n                }));\r\n            } catch (e) {\r\n                // Ignore storage errors\r\n            }\r\n\r\n            // Throttle the heavy viewport bounds calculation (used for filtering/clustering)\r\n            // This prevents massive React re-renders on every micro-movement\r\n            throttledSetBounds(evt.target);\r\n        }\r\n    };\r\n\r\n    const throttledSetBounds = useMemo(() => throttle((map: mapboxgl.Map) => {\r\n        setViewportBounds(map.getBounds());\r\n    }, 400, { leading: false, trailing: true }), []);\r\n\r\n    // Initialize bounds once map is ready\r\n    useEffect(() => {\r\n        if (mapRef.current) {\r\n            // Small timeout to ensure map is ready\r\n            setTimeout(() => {\r\n                const map = mapRef.current?.getMap();\r\n                if (map) {\r\n                    setViewportBounds(map.getBounds());\r\n                }\r\n            }, 500);\r\n        }\r\n\r\n        // Cleanup throttle on unmount\r\n        return () => throttledSetBounds.cancel();\r\n    }, [throttledSetBounds]);\r\n\r\n\r\n\r\n    // Filter messages - show all valid messages at their exact locations\r\n    // OPTIMIZED: Only process messages within the viewport (plus buffer)\r\n    const visibleMessages = useMemo(() => {\r\n        const now = Date.now();\r\n        const expirationMs = expirationHours * 60 * 60 * 1000;\r\n\r\n        // Safety check: Ensure messages is an array before filtering\r\n        if (!Array.isArray(messages)) return [];\r\n\r\n        // 1. Filter by expiration\r\n        const activeMessages = messages.filter(msg => {\r\n            const age = now - msg.timestamp;\r\n            return age < expirationMs;\r\n        });\r\n\r\n        // 2. Filter by viewport if available\r\n        if (viewportBounds) {\r\n            // Add a buffer (e.g. 50% of viewport size) to prevent popping at edges\r\n            const lngBuffer = (viewportBounds.getEast() - viewportBounds.getWest()) * 0.5;\r\n            const latBuffer = (viewportBounds.getNorth() - viewportBounds.getSouth()) * 0.5;\r\n\r\n            const west = viewportBounds.getWest() - lngBuffer;\r\n            const east = viewportBounds.getEast() + lngBuffer;\r\n            const south = viewportBounds.getSouth() - latBuffer;\r\n            const north = viewportBounds.getNorth() + latBuffer;\r\n\r\n            return activeMessages.filter(msg =>\r\n                msg.lng >= west && msg.lng <= east &&\r\n                msg.lat >= south && msg.lat <= north\r\n            );\r\n        }\r\n\r\n        return activeMessages;\r\n    }, [messages, expirationHours, viewportBounds]);\r\n\r\n    // Filter messages based on the selected layer mode\r\n    const filteredMessages = useMemo(() => {\r\n        if (filterMode === 'friends-locations') return [];\r\n        if (filterMode === 'friends-posts') {\r\n            return visibleMessages.filter(msg => {\r\n                // Check if user is a friend (or self)\r\n                if (!currentUserData) return false;\r\n                // 'friend' status means accepted friend\r\n                return currentUserData.friends.some(f => f.id === msg.userId) || msg.userId === currentUserData.id;\r\n            });\r\n        }\r\n        return visibleMessages;\r\n    }, [visibleMessages, filterMode, currentUserData]);\r\n\r\n    // Cluster posts into groups for carousel navigation\r\n    const postGroups = useMemo(() => {\r\n        const groups: { leaderId: string, posts: Message[], lat: number, lng: number }[] = [];\r\n        const processed = new Set<string>();\r\n\r\n        // Dynamic cluster radius\r\n        const baseRadius = clusterRadius;\r\n        const zoomFactor = Math.pow(2, 13 - viewState.zoom);\r\n        const clusterRadiusLat = baseRadius * zoomFactor;\r\n        const clusterRadiusLng = clusterRadiusLat / Math.cos(viewState.latitude * Math.PI / 180);\r\n\r\n        // Fixed geographical threshold for carousel grouping (approx 1.5-2 meters)\r\n        // This ensures only truly stacked posts remain in a carousel even at zoom 22.\r\n        const STRICT_OVERLAP_THRESHOLD = 0.00002;\r\n\r\n        // Helper to calculate score for Bubble eligibility\r\n        const getScore = (msg: Message) => {\r\n            let score = (msg.likes || 0);\r\n            if (msg.visibility === 'friends') score += 50;\r\n            const ageHours = (Date.now() - msg.timestamp) / (1000 * 60 * 60);\r\n            if (ageHours < 1) score += 5;\r\n            return score;\r\n        };\r\n\r\n        const sortedMessages = [...filteredMessages].sort((a, b) => {\r\n            const scoreA = getScore(a);\r\n            const scoreB = getScore(b);\r\n            if (scoreA !== scoreB) return scoreB - scoreA;\r\n            // Tie-Breaker 1: Recency\r\n            if (a.timestamp !== b.timestamp) return b.timestamp - a.timestamp;\r\n            // Tie-Breaker 2: Alphabetical ID (guaranteed stable)\r\n            return b.id.localeCompare(a.id);\r\n        });\r\n\r\n        for (const msg of sortedMessages) {\r\n            if (processed.has(msg.id)) continue;\r\n\r\n            const group = {\r\n                leaderId: msg.id,\r\n                posts: [msg],\r\n                lat: msg.lat,\r\n                lng: msg.lng\r\n            };\r\n            processed.add(msg.id);\r\n\r\n            // Collect nearby messages into this group\r\n            for (const other of filteredMessages) {\r\n                if (processed.has(other.id)) continue;\r\n\r\n                const latDiff = Math.abs(other.lat - msg.lat);\r\n                const lngDiff = Math.abs(other.lng - msg.lng);\r\n\r\n                // If within cluster radius, they are hidden from bubble view\r\n                if (latDiff < clusterRadiusLat && lngDiff < clusterRadiusLng) {\r\n                    processed.add(other.id);\r\n\r\n                    // BUT we only add them to the carousel if they are geographically overlapping\r\n                    if (latDiff < STRICT_OVERLAP_THRESHOLD && lngDiff < STRICT_OVERLAP_THRESHOLD) {\r\n                        group.posts.push(other);\r\n                    }\r\n                }\r\n            }\r\n            groups.push(group);\r\n        }\r\n        return groups;\r\n    }, [filteredMessages, viewState.zoom, viewState.latitude, clusterRadius]);\r\n\r\n    const postsToShowAsBubbles = useMemo(() => new Set(postGroups.map(g => g.leaderId)), [postGroups]);\r\n\r\n    // O(1) Lookup Map for Magnet Logic\r\n    const bubbleMap = useMemo(() => {\r\n        const map = new Map<string, Message>();\r\n        filteredMessages.forEach(msg => {\r\n            if (postsToShowAsBubbles.has(msg.id)) {\r\n                map.set(msg.id, msg);\r\n            }\r\n        });\r\n        return map;\r\n    }, [filteredMessages, postsToShowAsBubbles]);\r\n\r\n    const bubblesToRender = useMemo(() => {\r\n        const currentBubbleIds = new Set(postsToShowAsBubbles);\r\n\r\n        // Calculate final list including both current and currently-exiting\r\n        const active = filteredMessages\r\n            .filter(msg => currentBubbleIds.has(msg.id))\r\n            .map(msg => ({ msg, isExiting: false }));\r\n\r\n        // Track which IDs are already in the active list to prevent duplicates\r\n        const renderedIds = new Set(active.map(({ msg }) => msg.id));\r\n\r\n        const exiting = Object.values(exitingBubbles)\r\n            .filter(msg => !currentBubbleIds.has(msg.id) && !renderedIds.has(msg.id))\r\n            .map(msg => ({ msg, isExiting: true }));\r\n\r\n        return [...active, ...exiting];\r\n    }, [filteredMessages, postsToShowAsBubbles, exitingBubbles]);\r\n\r\n    // Detect exiting bubbles and maintain state (Safely in useEffect)\r\n    useEffect(() => {\r\n        const currentBubbleIds = postsToShowAsBubbles;\r\n        const prevIds = previousBubblesSet.current;\r\n\r\n        const newlyExiting: Record<string, Message> = {};\r\n        let hasNewExiting = false;\r\n\r\n        prevIds.forEach(id => {\r\n            if (!currentBubbleIds.has(id) && !exitingBubbles[id]) {\r\n                const msg = filteredMessages.find(m => m.id === id) ||\r\n                    // Fallback if not found in filteredMessages (might have been removed from there too)\r\n                    (messages as Message[]).find(m => m.id === id);\r\n\r\n                if (msg) {\r\n                    // SMART CHECK: Is this message being replaced by an identical one with a different ID?\r\n                    // (e.g. optimistic temp-ID -> real DB ID)\r\n                    const isBeingReplaced = Array.from(postsToShowAsBubbles).some(newId => {\r\n                        const newMsg = (messages as Message[]).find(m => m.id === newId);\r\n                        if (!newMsg) return false;\r\n\r\n                        const nLat = newMsg.lat;\r\n                        const nLng = newMsg.lng;\r\n                        const mLat = msg.lat;\r\n                        const mLng = msg.lng;\r\n\r\n                        // Match by location (fixed to 6 decimals) - identical to bubbleLayoutId logic\r\n                        return nLat?.toFixed(6) === mLat?.toFixed(6) &&\r\n                            nLng?.toFixed(6) === mLng?.toFixed(6);\r\n                    });\r\n\r\n                    if (!isBeingReplaced) {\r\n                        newlyExiting[id] = msg;\r\n                        hasNewExiting = true;\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        if (hasNewExiting) {\r\n            setExitingBubbles(prev => ({ ...prev, ...newlyExiting }));\r\n\r\n            // Clean up after animation duration\r\n            setTimeout(() => {\r\n                setExitingBubbles(prev => {\r\n                    const next = { ...prev };\r\n                    Object.keys(newlyExiting).forEach(id => delete next[id]);\r\n                    return next;\r\n                });\r\n            }, 600); // Matches animation duration\r\n        }\r\n\r\n        // Update ref for next comparison\r\n        previousBubblesSet.current = new Set(currentBubbleIds);\r\n    }, [postsToShowAsBubbles, filteredMessages, messages]);\r\n\r\n    // Remove the old useEffect-based exiting logic\r\n\r\n    // Remove obsolete spiderfy transition effects\r\n\r\n    // Identify Dots (Messages that are NOT Bubbles)\r\n    const visibleDots = useMemo(() => {\r\n        return filteredMessages.filter(msg => !postsToShowAsBubbles.has(msg.id));\r\n    }, [filteredMessages, postsToShowAsBubbles]);\r\n\r\n\r\n    // Repellors derived from active Bubbles (Level 1 Priority)\r\n    const bubbleRepellors = useMemo(() => {\r\n        const zoomFactor = Math.pow(2, 13 - viewState.zoom);\r\n        const radiusLat = 0.006 * zoomFactor;\r\n\r\n        const reps: Repellor[] = [];\r\n        bubbleMap.forEach(bubble => {\r\n            const lat = bubble.lat;\r\n            const rLat = radiusLat * 1.1; // 10% safety buffer for bubble \"hard shell\"\r\n            reps.push({\r\n                lat: bubble.lat,\r\n                lng: bubble.lng,\r\n                radiusLat: rLat,\r\n                radiusLng: rLat / Math.cos(lat * Math.PI / 180),\r\n                strength: 1.0,\r\n                id: bubble.id\r\n            });\r\n        });\r\n        return reps;\r\n    }, [bubbleMap, viewState.zoom]);\r\n\r\n    // Secondary Clustering: Cluster the Dots\r\n    const dotClustersResult = useMemo(() => {\r\n        const clusters: { id: string, lat: number, lng: number, originalLat: number, originalLng: number, count: number, ids: string[], messages: Message[] }[] = [];\r\n        const processed = new Set<string>();\r\n\r\n        const baseRadius = clusterRadius * 0.8;\r\n        const zoomFactor = Math.pow(2, 13 - viewState.zoom);\r\n        const clusterRadiusLat = baseRadius * zoomFactor;\r\n        const clusterRadiusLng = baseRadius * zoomFactor / Math.cos(viewState.latitude * Math.PI / 180);\r\n\r\n        const sortedDots = [...visibleDots].sort((a, b) => a.id.localeCompare(b.id));\r\n\r\n        const clusterRepellors: Repellor[] = [];\r\n\r\n        for (const msg of sortedDots) {\r\n            if (processed.has(msg.id)) continue;\r\n\r\n            const cluster = {\r\n                id: msg.id,\r\n                lat: msg.lat,\r\n                lng: msg.lng,\r\n                originalLat: msg.lat,\r\n                originalLng: msg.lng,\r\n                count: 1,\r\n                ids: [msg.id],\r\n                messages: [msg]\r\n            };\r\n            processed.add(msg.id);\r\n\r\n            for (const other of sortedDots) {\r\n                if (other.id === msg.id || processed.has(other.id)) continue;\r\n\r\n                const latDiff = Math.abs(other.lat - msg.lat);\r\n                const lngDiff = Math.abs(other.lng - msg.lng);\r\n\r\n                if (latDiff < clusterRadiusLat && lngDiff < clusterRadiusLng) {\r\n                    cluster.count++;\r\n                    cluster.ids.push(other.id);\r\n                    cluster.messages.push(other);\r\n                    cluster.originalLat = (cluster.originalLat * (cluster.count - 1) + other.lat) / cluster.count;\r\n                    cluster.originalLng = (cluster.originalLng * (cluster.count - 1) + other.lng) / cluster.count;\r\n                    cluster.lat = cluster.originalLat;\r\n                    cluster.lng = cluster.originalLng;\r\n                    processed.add(other.id);\r\n                }\r\n            }\r\n\r\n            if (cluster.count > 1) {\r\n                // APPLY REPULSION TO CLUSTER (From Bubbles + previous Clusters)\r\n                const finalPos = applyRepulsion(\r\n                    cluster.lat,\r\n                    cluster.lng,\r\n                    cluster.originalLat,\r\n                    cluster.originalLng,\r\n                    [...bubbleRepellors, ...clusterRepellors],\r\n                    viewState.zoom,\r\n                    true // Lock to marker tip if exactly overlapping\r\n                );\r\n                cluster.lat = finalPos.lat;\r\n                cluster.lng = finalPos.lng;\r\n\r\n                // Add this cluster as a repellor for subsequent elements\r\n                clusterRepellors.push({\r\n                    lat: cluster.lat,\r\n                    lng: cluster.lng,\r\n                    radiusLat: clusterRadiusLat * 0.6, // Smaller collision zone for clusters\r\n                    radiusLng: clusterRadiusLng * 0.6,\r\n                    strength: 0.4, // Lower strength to prevent aggressive chain reactions\r\n                    id: cluster.id\r\n                });\r\n\r\n                clusters.push(cluster);\r\n            }\r\n        }\r\n        return { clusters, clusterRepellors };\r\n    }, [visibleDots, viewState.zoom, viewState.latitude, clusterRadius, bubbleRepellors]);\r\n\r\n    const activeDotClusters = useMemo(() => dotClustersResult.clusters, [dotClustersResult]);\r\n    const clusterRepellors = useMemo(() => dotClustersResult.clusterRepellors, [dotClustersResult]);\r\n\r\n    // Remaining Single Dots (Not in any dot cluster)\r\n    const clusteredDotIds = useMemo(() => {\r\n        const ids = new Set<string>();\r\n        activeDotClusters.forEach(c => c.ids.forEach(id => ids.add(id)));\r\n        return ids;\r\n    }, [activeDotClusters]);\r\n\r\n    // Prepare Dots GeoJSON for WebGL Layer vs React Markers\r\n    const dotsProcessingResult = useMemo(() => {\r\n        const unclusteredDots = visibleDots.filter(msg => !clusteredDotIds.has(msg.id));\r\n        const stableFeatures: any[] = [];\r\n        const displaced: any[] = [];\r\n\r\n        unclusteredDots.forEach(msg => {\r\n            // Pushed by Bubbles AND Clusters (Level 3 Priority)\r\n            const finalPos = applyRepulsion(\r\n                msg.lat,\r\n                msg.lng,\r\n                msg.lat,\r\n                msg.lng,\r\n                [...bubbleRepellors, ...clusterRepellors],\r\n                viewState.zoom,\r\n                true\r\n            );\r\n\r\n            const pixelDist = getPixelDistance(finalPos.lat, finalPos.lng, msg.lat, msg.lng, viewState.zoom);\r\n\r\n            if (pixelDist > 2) {\r\n                // DISPLACED: Render as React Marker with Notch\r\n                displaced.push({\r\n                    ...msg,\r\n                    lat: finalPos.lat,\r\n                    lng: finalPos.lng,\r\n                    originalLat: msg.lat,\r\n                    originalLng: msg.lng\r\n                });\r\n            } else {\r\n                // STABLE: Render as WebGL Point (Performance)\r\n                stableFeatures.push({\r\n                    type: 'Feature',\r\n                    geometry: {\r\n                        type: 'Point',\r\n                        coordinates: [finalPos.lng, finalPos.lat]\r\n                    },\r\n                    properties: {\r\n                        ...msg,\r\n                        id: msg.id,\r\n                        visibility: msg.visibility,\r\n                        isDot: true,\r\n                        originalLat: msg.lat,\r\n                        originalLng: msg.lng\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        return {\r\n            dotsGeoJson: {\r\n                type: 'FeatureCollection',\r\n                features: stableFeatures\r\n            },\r\n            displacedDots: displaced\r\n        };\r\n    }, [visibleDots, clusteredDotIds, bubbleRepellors, clusterRepellors, viewState.zoom]);\r\n\r\n    const dotsGeoJson = useMemo(() => dotsProcessingResult.dotsGeoJson, [dotsProcessingResult]);\r\n    const displacedDots = useMemo(() => dotsProcessingResult.displacedDots, [dotsProcessingResult]);\r\n\r\n    const dotLayerStyle: any = {\r\n        id: 'dot-layer',\r\n        type: 'circle',\r\n        filter: ['==', ['get', 'isDot'], true],\r\n        paint: {\r\n            'circle-color': [\r\n                'match',\r\n                ['get', 'visibility'],\r\n                'friends', '#10b981',\r\n                '#a855f7'\r\n            ],\r\n            'circle-radius': 6,\r\n            'circle-stroke-width': 2,\r\n            'circle-stroke-color': '#ffffff',\r\n            'circle-opacity': selectedFriend ? 0.3 : 1,\r\n            'circle-stroke-opacity': selectedFriend ? 0.3 : 1\r\n        }\r\n    };\r\n\r\n\r\n    // Tertiary Clustering: Flocking System (Each person is unique, but targets cluster center)\r\n    const flockPoints = useMemo(() => {\r\n        const pointsMapping: Record<string, { lat: number, lng: number, clusterId: string, friendsInCluster: any[], stackIndex: number }> = {};\r\n        const processed = new Set<string>();\r\n\r\n        const baseRadius = clusterRadius * 1.5;\r\n        const zoomFactor = Math.pow(2, 13 - viewState.zoom);\r\n        const clusterRadiusLat = baseRadius * zoomFactor;\r\n        const clusterRadiusLng = baseRadius * zoomFactor / Math.cos(viewState.latitude * Math.PI / 180);\r\n\r\n        const allPeople = [];\r\n        if (location) {\r\n            allPeople.push({ id: 'self', lastLat: location.lat, lastLng: location.lng, name: session?.user?.name || 'You', image: session?.user?.image, isSelf: true });\r\n        }\r\n        if (currentUserData?.friends) {\r\n            allPeople.push(...currentUserData.friends.filter(f => f.lastLat && f.lastLng));\r\n        }\r\n\r\n        for (const person of allPeople) {\r\n            if (processed.has(person.id)) continue;\r\n\r\n            const cluster = [person];\r\n            processed.add(person.id);\r\n\r\n            for (const other of allPeople) {\r\n                if (other.id === person.id || processed.has(other.id)) continue;\r\n\r\n                const latDiff = Math.abs(other.lastLat! - person.lastLat!);\r\n                const lngDiff = Math.abs(other.lastLng! - person.lastLng!);\r\n\r\n                if (latDiff < clusterRadiusLat && lngDiff < clusterRadiusLng) {\r\n                    cluster.push(other);\r\n                    processed.add(other.id);\r\n                }\r\n            }\r\n\r\n            // If we are in a cluster, we prioritize 'self' as the leader for the visual stack\r\n            if (cluster.some(p => p.id === 'self')) {\r\n                const selfIdx = cluster.findIndex(p => p.id === 'self');\r\n                const self = cluster.splice(selfIdx, 1)[0];\r\n                cluster.unshift(self);\r\n            }\r\n\r\n            const flockLat = cluster.reduce((sum, p) => sum + p.lastLat!, 0) / cluster.length;\r\n            const flockLng = cluster.reduce((sum, p) => sum + p.lastLng!, 0) / cluster.length;\r\n\r\n            cluster.forEach((p, index) => {\r\n                pointsMapping[p.id] = {\r\n                    lat: cluster.length > 1 ? flockLat : p.lastLat!,\r\n                    lng: cluster.length > 1 ? flockLng : p.lastLng!,\r\n                    clusterId: person.id,\r\n                    friendsInCluster: cluster,\r\n                    stackIndex: cluster.length > 1 ? index : -1\r\n                };\r\n            });\r\n        }\r\n        return pointsMapping;\r\n    }, [currentUserData?.friends, location, session?.user, viewState.zoom, viewState.latitude, clusterRadius]);\r\n\r\n    // Convenient list for iterating\r\n    const peopleToRender = useMemo(() => {\r\n        const list = [];\r\n        if (location) list.push({ id: 'self', isSelf: true, lastLat: location.lat, lastLng: location.lng, name: session?.user?.name, image: session?.user?.image });\r\n        if (currentUserData?.friends) {\r\n            list.push(...currentUserData.friends.filter(f => f.lastLat && f.lastLng).map(f => ({ ...f, isSelf: false })));\r\n        }\r\n        return list;\r\n    }, [location, currentUserData?.friends, session?.user]);\r\n\r\n    // Calculate which messages are near screen center for vote button visibility\r\n    // FIXED: Use percentage-based thresholds relative to the actual viewport bounds\r\n    // This ensures consistency across all zoom levels and screen sizes\r\n    const markersNearCenter = useMemo(() => {\r\n        if (!viewportBounds) return new Set<string>();\r\n\r\n        const centerLat = viewState.latitude;\r\n        const centerLng = viewState.longitude;\r\n\r\n        // Calculate actual viewport height and width in degrees\r\n        const viewportLatSpan = Math.abs(viewportBounds.getNorth() - viewportBounds.getSouth());\r\n        const viewportLngSpan = Math.abs(viewportBounds.getEast() - viewportBounds.getWest());\r\n\r\n        // Focus area: Uses centralized percentage config\r\n        const latThreshold = viewportLatSpan * (FOCUS_CONFIG.verticalBand / 2);\r\n        const lngThreshold = viewportLngSpan * (FOCUS_CONFIG.horizontalBand / 2);\r\n\r\n        return new Set(\r\n            filteredMessages\r\n                .filter(msg => {\r\n                    const latDiff = Math.abs(msg.lat - centerLat);\r\n                    const lngDiff = Math.abs(msg.lng - centerLng);\r\n                    return latDiff < latThreshold && lngDiff < lngThreshold;\r\n                })\r\n                .map(msg => msg.id)\r\n        );\r\n    }, [filteredMessages, viewState.latitude, viewState.longitude, viewportBounds]);\r\n\r\n    // Handle voting\r\n    const handleVote = async (id: string, action: 'like' | 'dislike', unlimited: boolean) => {\r\n        await voteMessage(id, action, currentUserData?.id, unlimited);\r\n    };\r\n\r\n    // Fly to marker location on click and select message\r\n    const handleMarkerClick = (msg: Message, fromDot: boolean = false) => {\r\n        setSelectedMessage(msg);\r\n        setLocationName(null);\r\n\r\n        if (!fromDot) {\r\n            setMessageDetailsOpen(true);\r\n        } else {\r\n            setMessageDetailsOpen(false);\r\n        }\r\n\r\n        if (mapRef.current) {\r\n            const targetZoom = viewState.zoom > 16 ? viewState.zoom : 16;\r\n            isProgrammaticMove.current = true;\r\n            mapRef.current.flyTo({\r\n                center: [msg.lng, msg.lat],\r\n                zoom: targetZoom,\r\n                padding: { top: fromDot ? 100 : 450, bottom: 0, left: 0, right: 0 },\r\n                speed: 1.5,\r\n                curve: 1.42,\r\n                essential: true\r\n            });\r\n            setTimeout(() => {\r\n                isProgrammaticMove.current = false;\r\n            }, 800);\r\n        }\r\n    };\r\n\r\n    // CRITICAL FIX: Reset map padding when message details are closed\r\n    // Without this, the map keeps the huge top-padding, making bubbles disappear at the top of the screen\r\n    useEffect(() => {\r\n        if (!selectedMessage && mapRef.current) {\r\n            mapRef.current.easeTo({\r\n                padding: { top: 0, bottom: 0, left: 0, right: 0 },\r\n                duration: 400\r\n            });\r\n        }\r\n    }, [selectedMessage]);\r\n\r\n    // Fetch location name when a message is selected\r\n    useEffect(() => {\r\n        if (selectedMessage && MAPBOX_TOKEN) {\r\n            const fetchLocationName = async () => {\r\n                try {\r\n                    const response = await fetch(\r\n                        `https://api.mapbox.com/geocoding/v5/mapbox.places/${selectedMessage.lng},${selectedMessage.lat}.json?access_token=${MAPBOX_TOKEN}&types=poi,address`\r\n                    );\r\n                    const data = await response.json();\r\n                    if (data.features && data.features.length > 0) {\r\n                        setLocationName(data.features[0].place_name);\r\n                    } else {\r\n                        setLocationName(`${selectedMessage.lat.toFixed(4)}, ${selectedMessage.lng.toFixed(4)}`);\r\n                    }\r\n                } catch (error) {\r\n                    console.error(\"Error fetching location name:\", error);\r\n                    setLocationName(`${selectedMessage.lat.toFixed(4)}, ${selectedMessage.lng.toFixed(4)}`);\r\n                }\r\n            };\r\n            fetchLocationName();\r\n        }\r\n    }, [selectedMessage]);\r\n\r\n    // Search State\r\n    const [searchQuery, setSearchQuery] = useState(\"\");\r\n    const [searchResults, setSearchResults] = useState<any[]>([]);\r\n    const [isSearching, setIsSearching] = useState(false);\r\n    const [showResults, setShowResults] = useState(false);\r\n    const [isSearchOpen, setIsSearchOpen] = useState(false); // New state for toggle\r\n    const searchRef = useRef<HTMLDivElement>(null);\r\n    const layersRef = useRef<HTMLDivElement>(null);\r\n\r\n    // Handle Click Outside Search & Layers\r\n    useEffect(() => {\r\n        const handleClickOutside = (event: MouseEvent | TouchEvent) => {\r\n            const target = event.target as Node;\r\n\r\n            // Close Search if click is outside\r\n            if (isSearchOpen && searchRef.current && !searchRef.current.contains(target)) {\r\n                setIsSearchOpen(false);\r\n            }\r\n\r\n            // Close Layers if click is outside\r\n            if (isLayersOpen && layersRef.current && !layersRef.current.contains(target)) {\r\n                setIsLayersOpen(false);\r\n            }\r\n        };\r\n\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        document.addEventListener('touchstart', handleClickOutside);\r\n\r\n        return () => {\r\n            document.removeEventListener('mousedown', handleClickOutside);\r\n            document.removeEventListener('touchstart', handleClickOutside);\r\n        };\r\n    }, [isSearchOpen, isLayersOpen]);\r\n\r\n    // Handle Search\r\n    const handleSearch = async (query: string) => {\r\n        setSearchQuery(query);\r\n        if (query.length < 3) {\r\n            setSearchResults([]);\r\n            setShowResults(false);\r\n            return;\r\n        }\r\n\r\n        setIsSearching(true);\r\n        try {\r\n            const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json`;\r\n            const params = new URLSearchParams({\r\n                access_token: MAPBOX_TOKEN || '',\r\n                types: 'place,country,poi,address',\r\n                limit: '5',\r\n                language: 'en' // or make this dynamic\r\n            });\r\n\r\n            const response = await fetch(`${endpoint}?${params}`);\r\n            const data = await response.json();\r\n\r\n            if (data.features) {\r\n                setSearchResults(data.features);\r\n                setShowResults(true);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Geocoding error:\", error);\r\n        } finally {\r\n            setIsSearching(false);\r\n        }\r\n    };\r\n\r\n    const handleSelectLocation = (feature: any) => {\r\n        const [lng, lat] = feature.center;\r\n\r\n        mapRef.current?.flyTo({\r\n            center: [lng, lat],\r\n            zoom: feature.bbox ? 12 : 14, // Zoom level depends on result type usually, but generic is fine\r\n            duration: 2000,\r\n            essential: true\r\n        });\r\n\r\n        // If bbox exists and matches viewport roughly, fitBounds might be better, \r\n        // but flyTo center is simpler for now and cleaner.\r\n\r\n        setShowResults(false);\r\n        setSearchQuery(\"\"); // Allow auto-clear\r\n        setIsSearchOpen(false); // Auto-close\r\n    };\r\n\r\n    const clearSearch = () => {\r\n        setSearchQuery(\"\");\r\n        setSearchResults([]);\r\n        setShowResults(false);\r\n    };\r\n\r\n    // Force Static Lighting to prevent \"Black Hemisphere\"\r\n    // We set a high ambient light so everything is visible\r\n    useEffect(() => {\r\n        const map = mapRef.current?.getMap();\r\n        if (map && map.setLights) {\r\n            map.setLights([\r\n                {\r\n                    id: 'ambient_light',\r\n                    type: 'ambient',\r\n                    properties: {\r\n                        color: '#ffffff',\r\n                        intensity: 1.0 // Fully lit, no shadows\r\n                    }\r\n                }\r\n            ]);\r\n        }\r\n    }, []);\r\n\r\n    // Sync with user location once found (ONLY if not already centered/restored)\r\n    useEffect(() => {\r\n        if (location && !hasCentered.current) {\r\n            setViewState((prev) => ({\r\n                ...prev,\r\n                latitude: location.lat,\r\n                longitude: location.lng,\r\n                zoom: 15,\r\n            }));\r\n            hasCentered.current = true;\r\n        }\r\n    }, [location]);\r\n\r\n    if (!MAPBOX_TOKEN) {\r\n        return <div className=\"p-4 text-white\">Mapbox Token Missing</div>;\r\n    }\r\n\r\n    return (\r\n        <div\r\n            className=\"w-full h-screen\"\r\n            style={{\r\n                position: 'relative',\r\n                width: '100vw',\r\n                height: '100vh',\r\n                overflow: 'hidden',\r\n                cursor: isSimulationMode ? 'crosshair' : 'default'\r\n            }}\r\n        >\r\n            {/* Map Layers Filter - Left Side */}\r\n            {/* Map Layers Filter - Left Side */}\r\n            <div ref={layersRef}>\r\n                <MapLayers\r\n                    currentFilter={filterMode}\r\n                    onFilterChange={setFilterMode}\r\n                    isOpen={isLayersOpen}\r\n                    onToggle={() => setIsLayersOpen(!isLayersOpen)}\r\n                />\r\n            </div>\r\n\r\n            {/* Search Bar Overlay - Top Right */}\r\n            <div\r\n                ref={searchRef}\r\n                className={`fixed top-4 right-4 z-50 transition-[width,height,opacity] duration-300 ease-in-out ${isSearchOpen ? 'w-[calc(100vw-32px)] sm:w-[320px]' : 'w-12 h-12'\r\n                    }`}\r\n            >\r\n                <div className=\"relative group flex justify-end\">\r\n                    {/* Collapsed State (Button) */}\r\n                    {!isSearchOpen && (\r\n                        <button\r\n                            onClick={() => {\r\n                                setIsSearchOpen(true);\r\n                                // input will auto-focus via autoFocus prop or ref if rendered\r\n                            }}\r\n                            className=\"bg-gradient-to-br from-purple-600 to-indigo-600 border border-white/20 rounded-full w-12 h-12 flex items-center justify-center text-white hover:scale-110 transition-all shadow-lg shadow-purple-600/40\"\r\n                        >\r\n                            <Search className=\"h-6 w-6\" />\r\n                        </button>\r\n                    )}\r\n\r\n                    {/* Expanded State (Input) */}\r\n                    {/* Expanded State (Input) */}\r\n                    <AnimatePresence>\r\n                        {isSearchOpen && (\r\n                            <m.div\r\n                                initial={{ opacity: 0, scale: 0.9, width: 0 }}\r\n                                animate={{ opacity: 1, scale: 1, width: \"100%\" }}\r\n                                exit={{ opacity: 0, scale: 0.9, width: 0 }}\r\n                                transition={{ duration: 0.2 }}\r\n                                className=\"relative w-full\"\r\n                            >\r\n                                <form\r\n                                    onSubmit={async (e) => {\r\n                                        e.preventDefault();\r\n                                        // Mobile \"Go\" or Desktop \"Enter\"\r\n                                        if (searchResults.length > 0) {\r\n                                            handleSelectLocation(searchResults[0]);\r\n                                        } else if (searchQuery.length > 2) {\r\n                                            // Fallback: Perform search if no results yet (fast typer)\r\n                                            try {\r\n                                                const endpoint = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(searchQuery)}.json`;\r\n                                                const params = new URLSearchParams({\r\n                                                    access_token: MAPBOX_TOKEN || '',\r\n                                                    types: 'place,country,poi,address',\r\n                                                    limit: '1',\r\n                                                    language: 'en'\r\n                                                });\r\n                                                const response = await fetch(`${endpoint}?${params}`);\r\n                                                const data = await response.json();\r\n                                                if (data.features && data.features.length > 0) {\r\n                                                    handleSelectLocation(data.features[0]);\r\n                                                }\r\n                                            } catch (err) {\r\n                                                console.error(\"Fast search failed\", err);\r\n                                            }\r\n                                        }\r\n                                    }}\r\n                                    className=\"relative w-full\"\r\n                                >\r\n                                    <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\r\n                                        <Search className=\"h-4 w-4 text-purple-300\" />\r\n                                    </div>\r\n                                    <input\r\n                                        autoFocus\r\n                                        type=\"text\" // 'search' type might show 'x' on some browsers, keeping text for custom style\r\n                                        enterKeyHint=\"search\"\r\n                                        className=\"block w-full pl-9 pr-9 py-3 bg-[#1a0033]/90 backdrop-blur-xl border border-purple-500/50 rounded-full text-base text-white placeholder-purple-300/50 focus:outline-none focus:ring-2 focus:ring-purple-500/50 shadow-2xl shadow-purple-900/50\"\r\n                                        placeholder={t('search') + \"...\"}\r\n                                        value={searchQuery}\r\n                                        onChange={(e) => handleSearch(e.target.value)}\r\n                                    // onKeyDown handled by form onSubmit\r\n                                    />\r\n                                    <button\r\n                                        type=\"button\"\r\n                                        onClick={() => {\r\n                                            clearSearch();\r\n                                            setIsSearchOpen(false);\r\n                                        }}\r\n                                        className=\"absolute inset-y-0 right-0 pr-3 flex items-center text-purple-300 hover:text-white transition-colors\"\r\n                                    >\r\n                                        <X className=\"h-4 w-4\" />\r\n                                    </button>\r\n                                </form>\r\n                            </m.div>\r\n                        )}\r\n                    </AnimatePresence>\r\n                </div>\r\n\r\n                {/* Search Results Dropdown - Only show if search is OPEN */}\r\n                {isSearchOpen && showResults && searchResults.length > 0 && (\r\n                    <div className=\"absolute mt-2 w-full bg-[#1a0033]/90 backdrop-blur-xl border border-purple-500/30 rounded-xl shadow-xl overflow-hidden animate-in fade-in slide-in-from-top-2\">\r\n                        <ul>\r\n                            {searchResults.map((result) => (\r\n                                <li\r\n                                    key={result.id}\r\n                                    onClick={() => handleSelectLocation(result)}\r\n                                    className=\"px-4 py-3 hover:bg-purple-900/50 cursor-pointer text-white border-b border-purple-500/10 last:border-none transition-colors\"\r\n                                >\r\n                                    <div className=\"font-medium text-sm text-purple-100\">{result.text}</div>\r\n                                    <div className=\"text-xs text-purple-400 truncate\">{result.place_name}</div>\r\n                                </li>\r\n                            ))}\r\n                        </ul>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            <MapGL\r\n                ref={mapRef}\r\n                {...viewState}\r\n                // light prop removed to fix deprecation warning\r\n                onMove={(evt) => {\r\n                    const previousZoom = viewState.zoom;\r\n                    setViewState(evt.viewState);\r\n                    console.log(\"🔍 Current Zoom:\", evt.viewState.zoom.toFixed(2));\r\n\r\n                    // Update viewport bounds in real-time for clustering/magnet logic\r\n                    if (evt.target) {\r\n                        setViewportBounds(evt.target.getBounds());\r\n                    }\r\n\r\n                    // Close details on any zoom change (slow or fast) - ONLY IF USER INITIATED\r\n                    // We check evt.originalEvent and specifically allow only direct interactions\r\n                    const originalEvent = (evt as any).originalEvent;\r\n                    const isUserInteraction = originalEvent &&\r\n                        ['mousedown', 'mouseup', 'mousemove', 'touchstart', 'touchend', 'touchmove', 'wheel', 'keydown'].includes(originalEvent.type);\r\n\r\n                    if (isUserInteraction && !isProgrammaticMove.current && selectedMessage && Math.abs(evt.viewState.zoom - previousZoom) > 0.01) {\r\n                        setSelectedMessage(null);\r\n                        setMessageDetailsOpen(false);\r\n                    }\r\n\r\n                    // Close search on map move\r\n                    if (isUserInteraction && !isProgrammaticMove.current && isSearchOpen) {\r\n                        setIsSearchOpen(false);\r\n                        // Optional: Clear search if desired, but just closing is less destructive\r\n                        // clearSearch(); \r\n                    }\r\n\r\n                    // Close layers on map move\r\n                    if (isUserInteraction && !isProgrammaticMove.current && isLayersOpen) {\r\n                        setIsLayersOpen(false);\r\n                    }\r\n\r\n                    // Close friend popup only on user-initiated movement, not programmatic flyTo\r\n                    if (isUserInteraction && !isProgrammaticMove.current && selectedFriend) {\r\n                        setSelectedFriend(null);\r\n                    }\r\n                }}\r\n                onMoveStart={(evt) => {\r\n                    // Only close on user interaction (drag start), not resize or flyTo\r\n                    const originalEvent = (evt as any).originalEvent;\r\n                    const isUserInteraction = originalEvent &&\r\n                        ['mousedown', 'mouseup', 'mousemove', 'touchstart', 'touchend', 'touchmove', 'wheel', 'keydown'].includes(originalEvent.type);\r\n\r\n                    if (isUserInteraction && !isProgrammaticMove.current) {\r\n                        // Reset carousel navigation\r\n                        setActiveGroupIndex({});\r\n\r\n                        // Close friend popup\r\n                        if (selectedFriend) {\r\n                            setSelectedFriend(null);\r\n                        }\r\n                    }\r\n\r\n                    if (isUserInteraction && !isProgrammaticMove.current && selectedMessage) {\r\n                        setSelectedMessage(null);\r\n                        setMessageDetailsOpen(false);\r\n                    }\r\n\r\n                    if (isUserInteraction && !isProgrammaticMove.current && isSearchOpen) {\r\n                        setIsSearchOpen(false); // Also closes results via conditional rendering\r\n                        // setShowResults(false); // Redundant if parent checks isSearchOpen\r\n                    }\r\n\r\n                    if (isUserInteraction && !isProgrammaticMove.current && isLayersOpen) {\r\n                        setIsLayersOpen(false);\r\n                    }\r\n                }}\r\n                onMoveEnd={handleMoveEnd}\r\n                style={{\r\n                    width: \"100%\",\r\n                    height: \"100%\",\r\n                    position: 'absolute',\r\n                    top: 0,\r\n                    left: 0\r\n                }}\r\n                mapStyle={customMapStyle as any}\r\n                mapboxAccessToken={MAPBOX_TOKEN}\r\n                attributionControl={false}\r\n                projection=\"globe\"\r\n                logoPosition=\"bottom-left\"\r\n                fog={FOG_CONFIG as any}\r\n                // --- PHASE 2 & 3 ANDROID WEBVIEW OPTIMIZATIONS ---\r\n                // Disable cross-source collisions to save CPU cycles during pans\r\n                crossSourceCollisions={false}\r\n                fadeDuration={0} // Disable label/icon fade-in for snappy render\r\n                preserveDrawingBuffer={false} // Phase 3: Prevent WebGL from holding frame buffers\r\n                // ---------------------------------------------\r\n\r\n\r\n                onLoad={() => {\r\n\r\n                    console.log(\"🗺️ Map Loaded\");\r\n                    setIsMapLoaded(true);\r\n                }}\r\n                onClick={async (evt) => {\r\n                    if (isSimulationMode) {\r\n                        const { lng, lat } = evt.lngLat;\r\n                        const randomMessages = [\r\n                            \"Wow, what a view!\",\r\n                            \"Anyone else here?\",\r\n                            \"Exploring the city!\",\r\n                            \"Found a cool spot!\",\r\n                            \"Hidden gem right here.\",\r\n                            \"Traffic is crazy...\",\r\n                            \"Beautiful sunset.\",\r\n                            \"Best coffee in town!\",\r\n                            \"Love this neighborhood.\",\r\n                            \"Walking the dog.\"\r\n                        ];\r\n                        const randomText = randomMessages[Math.floor(Math.random() * randomMessages.length)];\r\n\r\n                        // Optimistic update or direct call? using hook logic\r\n                        // We need access to sendMessage from useMessages.\r\n                        // It is already imported.\r\n\r\n                        await fetch(\"/api/messages\", {\r\n                            method: \"POST\",\r\n                            headers: { \"Content-Type\": \"application/json\" },\r\n                            body: JSON.stringify({ text: randomText, lat, lng }),\r\n                        });\r\n\r\n                        // We rely on SWR revalidation or we can trigger it\r\n                        // Since useMessages is in parent scope, we might need to trigger re-fetch\r\n                        // But for now let's just let the poll interval catch it or if we can access mutate\r\n                    } else {\r\n                        setSelectedMessage(null);\r\n                        setMessageDetailsOpen(false);\r\n                        setIsLayersOpen(false); // Close layers on map click\r\n                    }\r\n                }}\r\n            >\r\n                {/* Unified Location Rendering (User + Friends + Clusters) */}\r\n                {/* Unified Flocking Rendering (User + Friends + Clusters) */}\r\n                {(filterMode === 'all' || filterMode === 'friends-locations') && peopleToRender.map((person) => {\r\n                    const flockInfo = flockPoints[person.id];\r\n                    if (!flockInfo) return null;\r\n\r\n                    const isHighZoom = viewState.zoom >= THRESHOLD_ZOOM_DECLUSTER;\r\n\r\n                    // Dynamic Radius: Beyond threshold, markers push further away as you zoom closer\r\n                    const dynamicRadius = isHighZoom\r\n                        ? ORBITAL_RADIUS + (viewState.zoom - THRESHOLD_ZOOM_DECLUSTER) * 25\r\n                        : ORBITAL_RADIUS;\r\n\r\n                    return (\r\n                        <AnimatedMarker\r\n                            key={`person-${person.id}`}\r\n                            longitude={flockInfo.lng}\r\n                            latitude={flockInfo.lat}\r\n                            anchor={flockInfo.stackIndex !== -1 ? \"center\" : \"bottom\"}\r\n                            zIndex={flockInfo.stackIndex !== -1 ? 1000 - flockInfo.stackIndex : 800}\r\n                        >\r\n                            {flockInfo.stackIndex !== -1 ? (\r\n                                isHighZoom ? (\r\n                                    // High zoom: Show individual markers with expanded orbital offset\r\n                                    <div style={{\r\n                                        transform: (() => {\r\n                                            const isLeader = flockInfo.stackIndex === 0;\r\n                                            if (isLeader) return 'scale(1.0)';\r\n                                            const followerIndex = flockInfo.stackIndex - 1;\r\n                                            const totalFollowers = Math.max(flockInfo.friendsInCluster.length - 1, 1);\r\n                                            const angle = (followerIndex * (360 / totalFollowers) - 90) * (Math.PI / 180);\r\n                                            const tx = Math.cos(angle) * dynamicRadius;\r\n                                            const ty = Math.sin(angle) * dynamicRadius;\r\n                                            return `translate(${tx}px, ${ty}px) scale(0.85)`;\r\n                                        })(),\r\n                                        zIndex: flockInfo.stackIndex === 0 ? 100 : 10 - flockInfo.stackIndex\r\n                                    }}>\r\n                                        <FriendMarker\r\n                                            friend={person}\r\n                                            showAura={isSelf(person)}\r\n                                            onClick={() => {\r\n                                                if (person.lastLat && person.lastLng) {\r\n                                                    setSelectedFriend(person);\r\n\r\n                                                    // Center with offset even at high zoom\r\n                                                    const currentZoom = viewState.zoom;\r\n                                                    const latOffset = 0.0035 * Math.pow(2, 13 - currentZoom);\r\n\r\n                                                    isProgrammaticMove.current = true;\r\n                                                    mapRef.current?.flyTo({\r\n                                                        center: [person.lastLng, person.lastLat + latOffset],\r\n                                                        zoom: currentZoom,\r\n                                                        speed: 1.5,\r\n                                                        curve: 1.42\r\n                                                    });\r\n                                                    setTimeout(() => {\r\n                                                        isProgrammaticMove.current = false;\r\n                                                    }, 800);\r\n                                                }\r\n                                            }}\r\n                                        />\r\n                                    </div>\r\n                                ) : (\r\n                                    // Normal zoom: Show simple avatar clusters\r\n                                    <FriendClusterMarker\r\n                                        count={flockInfo.friendsInCluster.length}\r\n                                        friends={[person]}\r\n                                        stackIndex={flockInfo.stackIndex}\r\n                                        onClick={() => {\r\n                                            if (mapRef.current) {\r\n                                                isProgrammaticMove.current = true;\r\n                                                mapRef.current.flyTo({\r\n                                                    center: [flockInfo.lng, flockInfo.lat],\r\n                                                    zoom: Math.max(viewState.zoom + 2, THRESHOLD_ZOOM_DECLUSTER),\r\n                                                    speed: 1.5,\r\n                                                    curve: 1.42\r\n                                                });\r\n                                                setTimeout(() => {\r\n                                                    isProgrammaticMove.current = false;\r\n                                                }, 1000);\r\n                                            }\r\n                                        }}\r\n                                    />\r\n                                )\r\n                            ) : (\r\n                                <FriendMarker\r\n                                    friend={person}\r\n                                    showAura={isSelf(person)}\r\n                                    onClick={() => {\r\n                                        if (person.lastLat && person.lastLng) {\r\n                                            setSelectedFriend(person);\r\n                                            isProgrammaticMove.current = true;\r\n\r\n                                            // Dynamic latitude offset based on zoom for perfect centering\r\n                                            const zoom = 15;\r\n                                            const latOffset = 0.0035 * Math.pow(2, 13 - zoom);\r\n\r\n                                            mapRef.current?.flyTo({\r\n                                                center: [person.lastLng, person.lastLat + latOffset],\r\n                                                zoom: zoom,\r\n                                                speed: 1.5,\r\n                                                curve: 1.42\r\n                                            });\r\n                                            setTimeout(() => {\r\n                                                isProgrammaticMove.current = false;\r\n                                            }, 1000);\r\n                                        }\r\n                                    }}\r\n                                />\r\n                            )}\r\n                        </AnimatedMarker>\r\n                    );\r\n                })}\r\n\r\n                {/* Friend Popup */}\r\n                <AnimatePresence>\r\n                    {selectedFriend && selectedFriend.lastLat && selectedFriend.lastLng && (\r\n                        <Marker\r\n                            latitude={selectedFriend.lastLat}\r\n                            longitude={selectedFriend.lastLng}\r\n                            anchor=\"bottom\"\r\n                            style={{ zIndex: 10000 }} // Ensure it's always on top of other markers\r\n                        >\r\n                            <m.div\r\n                                initial={{\r\n                                    scale: 0.9,\r\n                                    opacity: 0,\r\n                                    y: -10,\r\n                                    backdropFilter: 'blur(0px) saturate(100%)'\r\n                                }}\r\n                                animate={{\r\n                                    scale: 1,\r\n                                    opacity: 1,\r\n                                    y: -20, // Float above the marker\r\n                                    backdropFilter: 'blur(6px) saturate(100%) hue-rotate(250deg)'\r\n                                }}\r\n                                exit={{\r\n                                    scale: 0.9,\r\n                                    opacity: 0,\r\n                                    y: -10,\r\n                                    backdropFilter: 'blur(0px) saturate(100%)'\r\n                                }}\r\n                                transition={{ type: \"spring\", stiffness: 450, damping: 32 }}\r\n                                className=\"pointer-events-auto p-3.5 min-w-[200px] relative group/popup rounded-2xl border-2 border-emerald-400/40 shadow-[0_20px_50px_rgba(0,0,0,0.5),0_0_20px_rgba(16,185,129,0.2)] bg-emerald-950/45\"\r\n                                style={{ transformStyle: 'preserve-3d' }}\r\n                                onClick={(e) => e.stopPropagation()}\r\n                            >\r\n                                <div className=\"relative z-10\">\r\n                                    <div className=\"flex items-center gap-3 mb-3\">\r\n                                        <div className=\"relative\">\r\n                                            <div className=\"w-14 h-14 rounded-full border-2 border-emerald-300 shadow-xl overflow-hidden bg-black ring-2 ring-emerald-500/20\">\r\n                                                {selectedFriend.image ? (\r\n                                                    <img src={selectedFriend.image} alt={selectedFriend.name} className=\"w-full h-full object-cover\" />\r\n                                                ) : (\r\n                                                    <div className=\"w-full h-full rounded-full bg-emerald-600 flex items-center justify-center border-2 border-black/10 font-bold text-xl text-white\">\r\n                                                        {selectedFriend.name.charAt(0).toUpperCase()}\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                            <div className={`absolute bottom-0.5 right-0.5 w-4 h-4 rounded-full border-2 border-emerald-950 ${selectedFriend.lastSeen && (Date.now() - new Date(selectedFriend.lastSeen).getTime() < 5 * 60 * 1000)\r\n                                                ? 'bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.8)]'\r\n                                                : 'bg-gray-500'\r\n                                                }`}></div>\r\n                                        </div>\r\n                                        <div className=\"flex-1\">\r\n                                            <h3 className=\"text-white font-bold text-base tracking-tight leading-tight\">{selectedFriend.name}</h3>\r\n                                            <p className=\"text-emerald-400/90 font-medium text-xs\">@{selectedFriend.username || selectedFriend.name.toLowerCase().replace(/\\s/g, '')}</p>\r\n                                        </div>\r\n                                        <button\r\n                                            onClick={(e) => { e.stopPropagation(); setSelectedFriend(null); }}\r\n                                            className=\"absolute -top-1.5 -right-1.5 w-7 h-7 flex items-center justify-center bg-emerald-500/15 hover:bg-emerald-500/40 backdrop-blur-md border border-emerald-400/20 rounded-full transition-all text-emerald-100 hover:scale-110 shadow-md\"\r\n                                        >\r\n                                            <X size={14} strokeWidth={3} />\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    {selectedFriend.lastSeen && (\r\n                                        <div className=\"flex items-center gap-2 text-[10px] text-emerald-50 bg-emerald-400/10 rounded-lg px-3 py-2 border border-emerald-400/15 relative z-10\">\r\n                                            <Clock size={12} className=\"text-emerald-300\" />\r\n                                            <span className=\"font-semibold\">\r\n                                                {Date.now() - new Date(selectedFriend.lastSeen).getTime() < 5 * 60 * 1000\r\n                                                    ? 'Online Now'\r\n                                                    : `Seen ${formatRelativeTime(new Date(selectedFriend.lastSeen).getTime())} ago`}\r\n                                            </span>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n\r\n                                {/* Glass reflection effect */}\r\n                                <div className=\"absolute inset-0 rounded-2xl overflow-hidden pointer-events-none opacity-40 z-10\">\r\n                                    <div className=\"absolute top-[-50%] left-[-50%] w-[200%] h-[200%] bg-gradient-to-br from-white/10 via-transparent to-transparent rotate-45\" />\r\n                                </div>\r\n                            </m.div>\r\n                        </Marker>\r\n                    )}\r\n                </AnimatePresence>\r\n\r\n                {/* 3a. STABLE DOTS: Single lowlight posts (WebGL Optimized) */}\r\n                <Source id=\"dots-source\" type=\"geojson\" data={dotsGeoJson as any}>\r\n                    <Layer\r\n                        {...dotLayerStyle}\r\n                        onClick={(e: any) => {\r\n                            const features = e.features;\r\n                            if (features && features.length > 0) {\r\n                                const msg = features[0].properties as any;\r\n                                handleMarkerClick(msg, true);\r\n                            }\r\n                        }}\r\n                    />\r\n                </Source>\r\n\r\n                {/* 3b. DISPLACED DOTS: Active Markers with SVG Notches */}\r\n                <AnimatePresence mode=\"popLayout\">\r\n                    {displacedDots.map((dot) => (\r\n                        <AnimatedMarker\r\n                            key={`displaced-dot-${dot.id}`}\r\n                            latitude={dot.lat}\r\n                            longitude={dot.lng}\r\n                            anchor=\"center\"\r\n                            zIndex={15}\r\n                        >\r\n                            <div className=\"relative\">\r\n                                {/* Displacement Notch (Points back to original location) */}\r\n                                <div\r\n                                    style={{\r\n                                        position: 'absolute',\r\n                                        top: '50%',\r\n                                        left: '50%',\r\n                                        transform: `translate(-50%, -50%) rotate(${getNotchAngle(dot.lat, dot.lng, dot.originalLat, dot.originalLng)}deg)`,\r\n                                        width: '40px',\r\n                                        height: '40px',\r\n                                        pointerEvents: 'none',\r\n                                        zIndex: -1,\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        justifyContent: 'center'\r\n                                    }}\r\n                                >\r\n                                    <svg width=\"40\" height=\"40\" viewBox=\"0 0 40 40\" style={{ overflow: 'visible' }}>\r\n                                        {/* Dashed line to source */}\r\n                                        <line\r\n                                            x1=\"20\" y1=\"20\"\r\n                                            x2=\"40\" y2=\"20\"\r\n                                            stroke=\"white\"\r\n                                            strokeWidth=\"1.5\"\r\n                                            strokeDasharray=\"3,2\"\r\n                                            opacity=\"0.5\"\r\n                                        />\r\n                                        {/* Arrow head at source end */}\r\n                                        <path\r\n                                            d=\"M 40 20 L 36 18 M 40 20 L 36 22\"\r\n                                            stroke=\"white\"\r\n                                            strokeWidth=\"1.5\"\r\n                                            opacity=\"0.7\"\r\n                                        />\r\n                                    </svg>\r\n                                </div>\r\n\r\n                                {/* The Dot itself */}\r\n                                <div\r\n                                    onClick={() => handleMarkerClick(dot, true)}\r\n                                    className=\"w-3.5 h-3.5 rounded-full border-2 border-white shadow-[0_0_10px_rgba(255,255,255,0.4)] cursor-pointer hover:scale-150 transition-all\"\r\n                                    style={{\r\n                                        background: dot.visibility === 'friends'\r\n                                            ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'\r\n                                            : 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)'\r\n                                    }}\r\n                                />\r\n                            </div>\r\n                        </AnimatedMarker>\r\n                    ))}\r\n                </AnimatePresence>\r\n\r\n                {/* 2. CLUSTERS: Groups of dots (lowlights) */}\r\n                <AnimatePresence mode=\"popLayout\">\r\n                    {activeDotClusters.map((cluster) => (\r\n                        // Cluster rendering (simplified, no spiderfy)\r\n                        <AnimatedMarker\r\n                            key={`cluster-${cluster.id}`}\r\n                            latitude={cluster.lat}\r\n                            longitude={cluster.lng}\r\n                            anchor=\"center\"\r\n                            zIndex={20}\r\n                        >\r\n                            <div className=\"relative\">\r\n                                {/* Displacement Notch (Points back to original location) */}\r\n                                {getPixelDistance(cluster.lat, cluster.lng, cluster.originalLat, cluster.originalLng, viewState.zoom) > 2 && (\r\n                                    <div\r\n                                        style={{\r\n                                            position: 'absolute',\r\n                                            top: '50%',\r\n                                            left: '50%',\r\n                                            transform: `translate(-50%, -50%) rotate(${getNotchAngle(cluster.lat, cluster.lng, cluster.originalLat, cluster.originalLng)}deg)`,\r\n                                            width: '40px',\r\n                                            height: '40px',\r\n                                            pointerEvents: 'none',\r\n                                            zIndex: -1,\r\n                                            display: 'flex',\r\n                                            alignItems: 'center',\r\n                                            justifyContent: 'center'\r\n                                        }}\r\n                                    >\r\n                                        <svg width=\"40\" height=\"40\" viewBox=\"0 0 40 40\" style={{ overflow: 'visible' }}>\r\n                                            {/* Dashed line to source */}\r\n                                            <line\r\n                                                x1=\"20\" y1=\"20\"\r\n                                                x2=\"40\" y2=\"20\"\r\n                                                stroke=\"white\"\r\n                                                strokeWidth=\"2\"\r\n                                                strokeDasharray=\"3,2\"\r\n                                                opacity=\"0.5\"\r\n                                            />\r\n                                            {/* Arrow head at source end */}\r\n                                            <path\r\n                                                d=\"M 40 20 L 35 17 M 40 20 L 35 23\"\r\n                                                stroke=\"white\"\r\n                                                strokeWidth=\"2\"\r\n                                                opacity=\"0.7\"\r\n                                            />\r\n                                        </svg>\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div\r\n                                    className=\"flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 border-[1.5px] border-white/80 shadow-[0_0_15px_rgba(124,58,237,0.5)] text-white font-bold text-sm cursor-pointer hover:scale-110 transition-transform\"\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation();\r\n                                        const children = cluster.messages || [];\r\n                                        if (children.length === 0) return;\r\n\r\n                                        if (mapRef.current) {\r\n                                            isProgrammaticMove.current = true;\r\n\r\n                                            // 1. Calculate spread (RMS Distance from weighted center)\r\n                                            let sumSqDistLat = 0;\r\n                                            let sumSqDistLng = 0;\r\n\r\n                                            children.forEach(dot => {\r\n                                                const dLat = dot.lat - cluster.originalLat;\r\n                                                const dLng = dot.lng - cluster.originalLng;\r\n                                                sumSqDistLat += dLat * dLat;\r\n                                                sumSqDistLng += dLng * dLng;\r\n                                            });\r\n\r\n                                            const rmsLat = Math.sqrt(sumSqDistLat / children.length);\r\n                                            const rmsLng = Math.sqrt(sumSqDistLng / children.length);\r\n\r\n                                            // 2. Define \"Core Population\" bounds (WeightedCenter ± 1.5 * Spread)\r\n                                            // Add tiny epsilon to avoid zero-size bounds\r\n                                            const spreadFactor = 1.5;\r\n                                            const marginLat = Math.max(rmsLat * spreadFactor, 0.0001);\r\n                                            const marginLng = Math.max(rmsLng * spreadFactor, 0.0001);\r\n\r\n                                            const coreBounds: [[number, number], [number, number]] = [\r\n                                                [cluster.originalLng - marginLng, cluster.originalLat - marginLat],\r\n                                                [cluster.originalLng + marginLng, cluster.originalLat + marginLat]\r\n                                            ];\r\n\r\n                                            // 3. Find camera settings to fit the core population\r\n                                            const camera = mapRef.current.cameraForBounds(coreBounds, { padding: 60 });\r\n\r\n                                            // 4. Stepped Zoom Delta: Limit how much we jump in one click (Max +3.0)\r\n                                            // This prevents \"teleporting\" from zoom 2 directly into a deep city view\r\n                                            const MAX_ZOOM_JUMP = 3.0;\r\n                                            const targetZoom = camera?.zoom || (viewState.zoom + 2);\r\n                                            const cappedZoom = Math.min(targetZoom, viewState.zoom + MAX_ZOOM_JUMP);\r\n\r\n                                            // 5. Fly specifically to the weighted center\r\n                                            mapRef.current.flyTo({\r\n                                                center: [cluster.originalLng, cluster.originalLat],\r\n                                                zoom: Math.min(cappedZoom, 18),\r\n                                                speed: 1.5,\r\n                                                curve: 1.42,\r\n                                                essential: true\r\n                                            });\r\n\r\n                                            setTimeout(() => { isProgrammaticMove.current = false; }, 1200);\r\n                                        }\r\n                                    }}\r\n                                >\r\n                                    +{cluster.count}\r\n                                </div>\r\n                            </div>\r\n                        </AnimatedMarker>\r\n                    ))}\r\n                </AnimatePresence>\r\n\r\n                {/* 1. BUBBLES: Posts to show as full bubbles (RENDER LAST) */}\r\n                <AnimatePresence mode=\"popLayout\">\r\n                    {bubblesToRender.map(({ msg, isExiting }) => {\r\n                        const isPremium = msg.userIsPremium;\r\n                        const isFriends = msg.visibility === 'friends';\r\n                        const zIndex = (isFriends ? 1000 : isPremium ? 500 : 100) + (msg.likes || 0);\r\n\r\n                        // Find the group for this bubble\r\n                        const group = postGroups.find(g => g.leaderId === msg.id);\r\n                        const groupPosts = group?.posts || [msg];\r\n                        const currentIndex = activeGroupIndex[msg.id] || 0;\r\n                        const displayMsg = groupPosts[currentIndex % groupPosts.length];\r\n\r\n                        const bubbleLayoutId = `bubble-${msg.lat?.toFixed(6)}-${msg.lng?.toFixed(6)}`;\r\n\r\n                        const handlePrev = (e: React.MouseEvent) => {\r\n                            e.stopPropagation();\r\n                            setActiveGroupIndex(prev => ({\r\n                                ...prev,\r\n                                [msg.id]: (currentIndex - 1 + groupPosts.length) % groupPosts.length\r\n                            }));\r\n                        };\r\n\r\n                        const handleNext = (e: React.MouseEvent) => {\r\n                            e.stopPropagation();\r\n                            setActiveGroupIndex(prev => ({\r\n                                ...prev,\r\n                                [msg.id]: (currentIndex + 1) % groupPosts.length\r\n                            }));\r\n                        };\r\n\r\n                        return (\r\n                            <AnimatedMarker\r\n                                key={msg.id}\r\n                                latitude={msg.lat}\r\n                                longitude={msg.lng}\r\n                                anchor=\"bottom\"\r\n                                zIndex={zIndex}\r\n                                layoutId={bubbleLayoutId}\r\n                            >\r\n                                {!(selectedMessage?.id === msg.id && isMessageDetailsOpen) && (\r\n                                    <div className=\"relative group/bubble flex items-center justify-center\">\r\n                                        {/* Carousel Arrows */}\r\n                                        {groupPosts.length > 1 && !isExiting && (\r\n                                            <>\r\n                                                <button\r\n                                                    onClick={handlePrev}\r\n                                                    className={`absolute -left-10 w-8 h-8 rounded-full bg-white/20 backdrop-blur-md border border-white/30 flex items-center justify-center text-white transition-all hover:bg-white/40 active:scale-95 shadow-lg z-50 ${viewState.zoom > 16 ? 'opacity-100' : 'opacity-0 group-hover/bubble:opacity-100'}`}\r\n                                                >\r\n                                                    <ChevronLeft size={18} strokeWidth={2.5} />\r\n                                                </button>\r\n                                                <button\r\n                                                    onClick={handleNext}\r\n                                                    className={`absolute -right-10 w-8 h-8 rounded-full bg-white/20 backdrop-blur-md border border-white/30 flex items-center justify-center text-white transition-all hover:bg-white/40 active:scale-95 shadow-lg z-50 ${viewState.zoom > 16 ? 'opacity-100' : 'opacity-0 group-hover/bubble:opacity-100'}`}\r\n                                                >\r\n                                                    <ChevronRight size={18} strokeWidth={2.5} />\r\n                                                </button>\r\n\r\n                                                {/* Page indicator */}\r\n                                                <div className={`absolute -bottom-8 left-1/2 -translate-x-1/2 flex gap-1 transition-opacity whitespace-nowrap px-2 py-0.5 rounded-full bg-purple-600/90 backdrop-blur-md text-[10px] text-white font-bold border border-white/20 shadow-lg pointer-events-none lowercase ${viewState.zoom > 16 ? 'opacity-100' : 'opacity-0 group-hover/bubble:opacity-100'}`}>\r\n                                                    {currentIndex + 1} / {groupPosts.length}\r\n                                                </div>\r\n                                            </>\r\n                                        )}\r\n\r\n                                        <div className={`transition-all duration-300 ${selectedFriend ? 'blur-sm opacity-50' : ''}`}>\r\n                                            <MessageMarker\r\n                                                message={displayMsg}\r\n                                                onVote={handleVote}\r\n                                                onClick={() => handleMarkerClick(displayMsg)}\r\n                                                currentUser={currentUserData}\r\n                                                unlimitedVotes={unlimitedVotes}\r\n                                                isSelected={selectedMessage?.id === displayMsg.id}\r\n                                                isNearCenter={true}\r\n                                                showActions={!isExiting && markersNearCenter.has(msg.id)}\r\n                                                zoom={viewState.zoom}\r\n                                                isExiting={isExiting}\r\n                                            />\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </AnimatedMarker>\r\n                        );\r\n                    })}\r\n                </AnimatePresence>\r\n\r\n                {/* Message Details Overlay - Expanded from Bubble AS A MARKER */}\r\n                {selectedMessage && isMessageDetailsOpen && (\r\n                    <Marker\r\n                        latitude={selectedMessage.lat}\r\n                        longitude={selectedMessage.lng}\r\n                        anchor=\"bottom\"\r\n                        style={{ zIndex: 100 }} // Ensure it's on top\r\n                    >\r\n                        <MessageDetails\r\n                            message={selectedMessage}\r\n                            layoutId={`message-container-${selectedMessage.id}`}\r\n                            onClose={() => {\r\n                                setSelectedMessage(null);\r\n                                setMessageDetailsOpen(false);\r\n                            }}\r\n                            onVote={handleVote}\r\n                            onAddFriend={onAddFriend}\r\n                            getFriendStatus={getFriendStatus}\r\n                            currentUser={session}\r\n                            unlimitedVotes={unlimitedVotes}\r\n                            locationName={locationName}\r\n                            onDelete={async (id) => {\r\n                                const result = await deleteMessage(id);\r\n                                if (result?.success) {\r\n                                    setSelectedMessage(null);\r\n                                    setMessageDetailsOpen(false);\r\n                                }\r\n                                return result || { success: false };\r\n                            }}\r\n                        />\r\n                    </Marker>\r\n                )}\r\n            </MapGL>\r\n\r\n            {/* DEBUG FOCUS AREA VISUALIZER - Commented out for production */}\r\n            {/* \r\n            <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none z-[5] overflow-hidden\">\r\n                <div \r\n                    className=\"border-2 border-white/10 bg-white/5 rounded-2xl backdrop-blur-[1px] shadow-[0_0_20px_rgba(255,255,255,0.05)]\"\r\n                    style={{\r\n                        width: `${FOCUS_CONFIG.horizontalBand * 100}%`,\r\n                        height: `${FOCUS_CONFIG.verticalBand * 100}%`,\r\n                        transition: 'all 0.3s ease'\r\n                    }}\r\n                >\r\n                    <div className=\"absolute top-2 left-1/2 -translate-x-1/2 px-2 py-0.5 bg-black/40 rounded-full border border-white/10\">\r\n                        <span className=\"text-[9px] text-white/40 font-bold uppercase tracking-widest\">Focus Zone</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            */}\r\n\r\n\r\n            {\r\n                locationError && (\r\n                    <div className=\"absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded shadow-md z-10 text-xs\">\r\n                        Location Error: {locationError.message}\r\n                    </div>\r\n                )\r\n            }\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\MapLayers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\MessageDetails.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":332,"column":45,"nodeType":"JSXOpeningElement","endLine":336,"endColumn":47},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":484,"column":49,"nodeType":"JSXOpeningElement","endLine":488,"endColumn":51},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":649,"column":41,"nodeType":"JSXOpeningElement","endLine":654,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { formatRelativeTime } from \"@/lib/utils\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport VoteControls from \"./VoteControls\";\r\nimport { customMapStyle } from \"@/lib/mapboxStyle\"; // Import Style\r\nimport Map from \"react-map-gl/mapbox\"; // Import Map\r\nimport { Capacitor, registerPlugin } from \"@capacitor/core\";\r\nimport { useTranslation } from \"@/context/LocalizationContext\";\r\n\r\ninterface InstagramStoriesPlugin {\r\n    shareToStory(options: { base64: string; attributionLink?: string }): Promise<void>;\r\n    shareToWhatsApp(options: { base64: string }): Promise<void>;\r\n}\r\nconst InstagramStories = registerPlugin<InstagramStoriesPlugin>('InstagramStories');\r\nimport { toPng } from \"html-to-image\";\r\nimport { Filesystem, Directory } from \"@capacitor/filesystem\";\r\nimport { Share } from \"@capacitor/share\";\r\nimport { X, Heart, MessageCircle, Share2, ThumbsUp, ThumbsDown, Check, UserPlus, Clock, Share as ShareIcon, Shield, Send, Crown, Instagram, MoreHorizontal, MoreVertical, Flag, Ban, Trash2 } from \"lucide-react\";\r\nimport { BADGE_CONFIGS } from \"@/lib/badgeConfig\";\r\nimport { m, AnimatePresence } from \"framer-motion\";\r\nimport { memo } from \"react\";\r\nimport { Message, Comment } from \"@/lib/store\";\r\nimport BadgeEarnedModal from \"./BadgeEarnedModal\";\r\n\r\n// Consolidating icons to avoid conflicts\r\nconst Icons = {\r\n    Instagram: Instagram,\r\n    WhatsApp: MessageCircle, // Use MessageCircle as placeholder or custom SVG\r\n    More: MoreHorizontal,\r\n    Share: ShareIcon,\r\n    Close: X\r\n};\r\n\r\ninterface MessageDetailsProps {\r\n    message: Message;\r\n    layoutId: string;\r\n    onClose: () => void;\r\n    onVote: (id: string, action: 'like' | 'dislike', unlimited: boolean) => void;\r\n    onAddFriend: (id: string) => void;\r\n    getFriendStatus: (id: string) => string;\r\n    currentUser: any;\r\n    unlimitedVotes: boolean;\r\n    locationName?: string | null;\r\n    onDelete?: (id: string) => Promise<{ success: boolean }>;\r\n}\r\n\r\nconst MessageDetails = memo(({\r\n    message,\r\n    layoutId,\r\n    onClose,\r\n    onVote,\r\n    onAddFriend,\r\n    getFriendStatus,\r\n    currentUser,\r\n    unlimitedVotes,\r\n    locationName,\r\n    onDelete\r\n}: MessageDetailsProps) => {\r\n    const { t } = useTranslation();\r\n    const router = useRouter();\r\n    const [comments, setComments] = useState<Comment[]>([]);\r\n    const [newComment, setNewComment] = useState(\"\");\r\n    const [isLoadingComments, setIsLoadingComments] = useState(true);\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [earnedBadges, setEarnedBadges] = useState<string[]>([]);\r\n    const [isDeleting, setIsDeleting] = useState(false);\r\n    const [confirmDelete, setConfirmDelete] = useState(false);\r\n\r\n    // currentUser passed from Map.tsx is a NextAuth session object: { user: { id, name, email } }\r\n    const currentUserId = currentUser?.user?.id ?? currentUser?.id;\r\n    const isOwner = !!(currentUserId && message.userId && currentUserId === message.userId);\r\n\r\n\r\n    const handleDelete = async () => {\r\n        if (!confirmDelete) {\r\n            setConfirmDelete(true);\r\n            // Auto-cancel after 3s\r\n            setTimeout(() => setConfirmDelete(false), 3000);\r\n            return;\r\n        }\r\n        if (!onDelete || isDeleting) return;\r\n        setIsDeleting(true);\r\n        const result = await onDelete(message.id);\r\n        if (result.success) {\r\n            onClose();\r\n        } else {\r\n            setIsDeleting(false);\r\n            setConfirmDelete(false);\r\n        }\r\n    };\r\n\r\n    const isFriend = getFriendStatus(message.userId) === 'friend';\r\n\r\n    // Fetch comments\r\n    useEffect(() => {\r\n        const fetchComments = async () => {\r\n            try {\r\n                const response = await fetch(`/api/messages/${message.id}/comments`);\r\n                if (response.ok) {\r\n                    const data = await response.json();\r\n                    setComments(data);\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error fetching comments:\", error);\r\n            } finally {\r\n                setIsLoadingComments(false);\r\n            }\r\n        };\r\n        fetchComments();\r\n    }, [message.id]);\r\n\r\n    // Submit comment\r\n    const handleSubmitComment = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!newComment.trim() || isSubmitting) return;\r\n\r\n        setIsSubmitting(true);\r\n        try {\r\n            const response = await fetch(`/api/messages/${message.id}/comments`, {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify({ content: newComment.trim() })\r\n            });\r\n\r\n            if (response.ok) {\r\n                const data = await response.json();\r\n                // Comment API now returns { ...comment, userUpdates: { earnedBadges } }\r\n                const comment = data.userUpdates ? data : data; // Fallback if structure varies\r\n\r\n                if (data.userUpdates?.earnedBadges?.length > 0) {\r\n                    setEarnedBadges(data.userUpdates.earnedBadges);\r\n                }\r\n\r\n                // Add to list\r\n                setComments(prev => [...prev, data]);\r\n                setNewComment(\"\");\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error submitting comment:\", error);\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n\r\n    // Share Functionality\r\n    const [isSharing, setIsSharing] = useState(false);\r\n    const [showShareMenu, setShowShareMenu] = useState(false);\r\n    const [generatedImage, setGeneratedImage] = useState<string | null>(null);\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n\r\n    // Initial Share Click -> Open Menu AND Start Generating\r\n    const handleShareClick = () => {\r\n        if (!Capacitor.isNativePlatform()) {\r\n            handleShareAction('system');\r\n            return;\r\n        }\r\n\r\n        setShowShareMenu(true);\r\n        // Start generating immediately if not already done\r\n        if (!generatedImage && !isGenerating) {\r\n            generateShareImage();\r\n        }\r\n    };\r\n\r\n    const generateShareImage = async (): Promise<string | null> => {\r\n        if (generatedImage) return generatedImage;\r\n        setIsGenerating(true);\r\n\r\n        try {\r\n            await new Promise(resolve => setTimeout(resolve, 100)); // Small UI yield\r\n\r\n            // Allow map to settle if needed, but since we start early, this is less blocking for the user\r\n            await new Promise(resolve => setTimeout(resolve, 500));\r\n\r\n            const shareElement = document.getElementById(`share-card-${message.id}`);\r\n            if (!shareElement) {\r\n                console.error(\"Share element not found\");\r\n                return null;\r\n            }\r\n\r\n            const dataUrl = await toPng(shareElement, {\r\n                quality: 0.95,\r\n                pixelRatio: 2,\r\n                filter: (node) => true,\r\n            });\r\n\r\n            setGeneratedImage(dataUrl);\r\n            return dataUrl;\r\n        } catch (error) {\r\n            console.error(\"Error generating image:\", error);\r\n            return null;\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n    const handleShareAction = async (platform: 'instagram' | 'whatsapp' | 'system') => {\r\n        if (isSharing) return;\r\n        setIsSharing(true);\r\n\r\n        try {\r\n            // Get Image: Reuse pre-generated or generate now\r\n            let dataUrl = generatedImage;\r\n            if (!dataUrl) {\r\n                console.log(\"Image not ready, generating now...\");\r\n                dataUrl = await generateShareImage();\r\n            }\r\n\r\n            if (!dataUrl) {\r\n                alert(\"Failed to generate image. Please try again.\");\r\n                return;\r\n            }\r\n\r\n            // 2. Platform Specific Handling\r\n            if (Capacitor.isNativePlatform()) {\r\n                if (platform === 'instagram') {\r\n                    // Native Instagram Story\r\n                    try {\r\n                        await InstagramStories.shareToStory({\r\n                            base64: dataUrl,\r\n                            attributionLink: \"https://geogramapp.vercel.app\"\r\n                        });\r\n                        console.log(\"Instagram share initiated\");\r\n                    } catch (err: any) {\r\n                        console.error(\"Instagram Native Failed:\", err);\r\n                        genericShare(dataUrl);\r\n                    }\r\n                } else if (platform === 'whatsapp') {\r\n                    // Native WhatsApp (Action Send)\r\n                    try {\r\n                        await InstagramStories.shareToWhatsApp({ base64: dataUrl });\r\n                        console.log(\"WhatsApp share initiated\");\r\n                    } catch (err: any) {\r\n                        console.error(\"WhatsApp Native Failed:\", err);\r\n                        genericShare(dataUrl);\r\n                    }\r\n                } else {\r\n                    // System / Fallback\r\n                    await genericShare(dataUrl);\r\n                }\r\n            } else {\r\n                // Web Share\r\n                await genericShare(dataUrl);\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error(\"Error sharing:\", error);\r\n        } finally {\r\n            setIsSharing(false);\r\n        }\r\n    };\r\n\r\n    const genericShare = async (dataUrl: string) => {\r\n        try {\r\n            if (Capacitor.isNativePlatform()) {\r\n                // Native generic share\r\n                const fileName = `share-${Date.now()}.png`;\r\n                const file = await Filesystem.writeFile({\r\n                    path: fileName,\r\n                    data: dataUrl,\r\n                    directory: Directory.Cache\r\n                });\r\n\r\n                await Share.share({\r\n                    files: [file.uri],\r\n                });\r\n            } else {\r\n                // Web Share\r\n                const blob = await (await fetch(dataUrl)).blob();\r\n                const file = new File([blob], \"share.png\", { type: blob.type });\r\n                const shareData = {\r\n                    files: [file],\r\n                    title: t('share_post_title'),\r\n                    text: t('share_post_text').replace('{name}', message.userName),\r\n                };\r\n\r\n                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {\r\n                    await navigator.share(shareData);\r\n                } else {\r\n                    // Fallback to download\r\n                    const link = document.createElement('a');\r\n                    link.download = 'share.png';\r\n                    link.href = dataUrl;\r\n                    link.click();\r\n                }\r\n            }\r\n        } catch (err) {\r\n            console.error(\"Generic share failed\", err);\r\n        } finally {\r\n            setIsSharing(false);\r\n        }\r\n    };\r\n\r\n    // Static Map URL for background\r\n    const staticMapUrl = `https://api.mapbox.com/styles/v1/mapbox/dark-v11/static/${message.lng},${message.lat},15,0/600x1200?access_token=${process.env.NEXT_PUBLIC_MAPBOX_TOKEN}&logo=false&attribution=false`;\r\n\r\n\r\n    return (\r\n        <m.div\r\n            className=\"w-[85vw] max-w-[320px] md:w-80 pointer-events-auto\"\r\n            initial={{ opacity: 0, scale: 0.95, y: 10 }}\r\n            animate={{ opacity: 1, scale: 1, y: 0 }}\r\n            exit={{ opacity: 0, scale: 0.95, y: 10 }}\r\n            transition={{\r\n                duration: 0.2,\r\n                ease: \"easeOut\"\r\n            }}\r\n            onClick={(e) => e.stopPropagation()}\r\n            style={{\r\n                transformOrigin: \"bottom center\",\r\n                paddingBottom: \"20px\" // Use padding so the element include the space for the pointer\r\n            }}\r\n        >\r\n            <div className={`backdrop-blur-3xl border rounded-[1.5rem] p-3 md:p-5 overflow-hidden relative group transition-colors duration-300 ${isFriend\r\n                ? 'bg-[#051a0d]/95 border-green-500/40 shadow-[0_8px_32px_rgba(34,197,94,0.2)]'\r\n                : 'bg-[#120024]/95 border-white/10 shadow-[0_8px_32px_rgba(0,0,0,0.5)]'\r\n                }`}>\r\n                {/* Content Container */}\r\n                <div className=\"space-y-4\">\r\n                    {/* Header: User Info with integrated close button */}\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div\r\n                            className=\"flex items-center gap-3 cursor-pointer group/user flex-1 min-w-0\"\r\n                            onClick={() => message.userId && router.push(`/profile?id=${message.userId}`)}\r\n                        >\r\n                            <div className=\"relative\">\r\n                                <div className={`w-10 h-10 rounded-full p-[2px] ${isFriend ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-gradient-to-br from-purple-500 to-indigo-500'}`}>\r\n                                    <div className=\"w-full h-full rounded-full bg-black overflow-hidden relative\">\r\n                                        {message.userImage ? (\r\n                                            <img\r\n                                                src={message.userImage}\r\n                                                alt={message.userName}\r\n                                                className=\"w-full h-full object-cover\"\r\n                                            />\r\n                                        ) : (\r\n                                            <div className=\"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-800 to-black text-white font-bold text-xs\">\r\n                                                {message.userName.charAt(0).toUpperCase()}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                {message.activeBadgeId && BADGE_CONFIGS[message.activeBadgeId] && (\r\n                                    <div\r\n                                        title={t(BADGE_CONFIGS[message.activeBadgeId].nameKey)}\r\n                                        className={`absolute -top-1 -right-1 z-20 flex items-center justify-center w-6 h-6 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[message.activeBadgeId].style} text-xs shadow-sm transform rotate-12 ring-1 ring-white/20`}\r\n                                    >\r\n                                        {BADGE_CONFIGS[message.activeBadgeId].icon}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div className=\"flex-1 min-w-0\">\r\n                                <div className=\"flex items-center gap-1.5 min-w-0\">\r\n                                    <h3 className=\"text-white font-bold text-base leading-tight truncate group-hover/user:text-purple-300 transition-colors\">\r\n                                        {message.userName}\r\n                                    </h3>\r\n                                </div>\r\n                                <p className=\"text-white/40 text-[10px] font-medium truncate\">\r\n                                    {message.isAnonymous ? t('anonymous_user') : t('view_profile_action')}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Action Buttons - properly aligned */}\r\n                        <div className=\"flex items-center gap-2 shrink-0\">\r\n                            {/* Share Button (New) */}\r\n                            <button\r\n                                onClick={handleShareClick}\r\n                                disabled={isSharing}\r\n                                className=\"p-2 bg-purple-600/20 hover:bg-purple-600/40 rounded-xl text-purple-300 transition-all border border-purple-500/30 disabled:opacity-50\"\r\n                            >\r\n                                {isSharing ? (\r\n                                    <div className=\"w-4 h-4 rounded-full border-2 border-purple-300 border-t-transparent animate-spin\" />\r\n                                ) : (\r\n                                    <ShareIcon size={16} />\r\n                                )}\r\n                            </button>\r\n\r\n                            {/* Add Friend Button */}\r\n                            {currentUser && !message.isAnonymous && getFriendStatus(message.userId) !== 'self' && (\r\n                                <button\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation();\r\n                                        onAddFriend(message.userId);\r\n                                    }}\r\n                                    disabled={getFriendStatus(message.userId) !== 'none'}\r\n                                    className={`p-2 rounded-xl transition-all shadow-lg ${getFriendStatus(message.userId) === 'friend' ? 'bg-green-500/20 text-green-400 border border-green-500/30' :\r\n                                        getFriendStatus(message.userId) === 'sent' ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' :\r\n                                            'bg-purple-600 text-white hover:bg-purple-500 hover:scale-105 hover:shadow-purple-500/25'\r\n                                        }`}\r\n                                >\r\n                                    {getFriendStatus(message.userId) === 'friend' ? <Check size={16} /> :\r\n                                        getFriendStatus(message.userId) === 'sent' ? <Clock size={16} /> :\r\n                                            <UserPlus size={16} />}\r\n                                </button>\r\n                            )}\r\n\r\n                            {/* Delete Button - owner only */}\r\n                            {isOwner && onDelete && (\r\n                                <button\r\n                                    onClick={(e) => { e.stopPropagation(); handleDelete(); }}\r\n                                    disabled={isDeleting}\r\n                                    className={`p-2 rounded-xl transition-all border disabled:opacity-50 ${confirmDelete\r\n                                        ? 'bg-red-500/30 text-red-400 border-red-500/50 animate-pulse'\r\n                                        : 'bg-white/5 hover:bg-red-500/20 text-white/40 hover:text-red-400 border-white/5'\r\n                                        }`}\r\n                                    title={confirmDelete ? t('confirm_delete') || 'Sil?' : t('delete_post') || 'Sil'}\r\n                                >\r\n                                    {isDeleting\r\n                                        ? <div className=\"w-4 h-4 rounded-full border-2 border-red-400 border-t-transparent animate-spin\" />\r\n                                        : <Trash2 size={16} />}\r\n                                </button>\r\n                            )}\r\n\r\n                            {/* Close Button */}\r\n                            <button\r\n                                onClick={(e) => {\r\n                                    e.stopPropagation();\r\n                                    onClose();\r\n                                }}\r\n                                className=\"p-2 bg-white/5 hover:bg-white/10 rounded-xl text-white/40 hover:text-white transition-all border border-white/5\"\r\n                            >\r\n                                <X size={16} />\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Message Body */}\r\n                    <div className=\"bg-white/5 rounded-xl p-3 border border-white/5\">\r\n                        <p className=\"text-white text-sm leading-relaxed font-medium\">\r\n                            &quot;{message.text}&quot;\r\n                        </p>\r\n                    </div>\r\n\r\n                    {/* Voting & Meta */}\r\n                    <div className=\"flex items-center justify-between pt-2\">\r\n                        <VoteControls\r\n                            message={message}\r\n                            onVote={onVote}\r\n                            currentUser={currentUser}\r\n                            unlimitedVotes={unlimitedVotes}\r\n                            orientation=\"horizontal\"\r\n                        />\r\n\r\n                        <div className=\"text-right space-y-0.5\">\r\n                            <div className=\"flex items-center justify-end text-xs text-white/40 gap-1.5\">\r\n                                <span>{formatRelativeTime(message.timestamp)} {t('ago')}</span>\r\n                            </div>\r\n                            {locationName && (\r\n                                <div className=\"text-[10px] text-purple-300/60 font-medium truncate max-w-[120px]\">\r\n                                    {locationName}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Comments Section */}\r\n                    <div className=\"space-y-2 mt-3 border-t border-white/10 pt-3 pointer-events-auto\">\r\n                        <h4 className=\"text-white/60 text-[10px] font-semibold uppercase tracking-wider\">{t('comments_count')} ({comments.length})</h4>\r\n\r\n                        {/* Comments List */}\r\n                        <div\r\n                            className=\"space-y-1.5 max-h-32 overflow-y-auto pointer-events-auto\"\r\n                            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\r\n                            onWheel={(e) => e.stopPropagation()}\r\n                            onTouchMove={(e) => e.stopPropagation()}\r\n                        >\r\n                            <style jsx>{`\r\n                                div::-webkit-scrollbar {\r\n                                    display: none;\r\n                                }\r\n                            `}</style>\r\n                            {isLoadingComments ? (\r\n                                <div className=\"text-white/40 text-[10px] text-center py-2\">{t('loading_comments')}</div>\r\n                            ) : comments.length === 0 ? (\r\n                                <div className=\"text-white/40 text-[10px] text-center py-2\">{t('no_comments_yet')}</div>\r\n                            ) : (\r\n                                comments.map((comment) => (\r\n                                    <div key={comment.id} className=\"bg-white/5 rounded-lg p-2 border border-white/5\">\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            {comment.authorImage ? (\r\n                                                <img\r\n                                                    src={comment.authorImage}\r\n                                                    alt={comment.authorName}\r\n                                                    className=\"w-5 h-5 rounded-full object-cover shrink-0\"\r\n                                                />\r\n                                            ) : (\r\n                                                <div className=\"w-5 h-5 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white text-[10px] font-bold shrink-0\">\r\n                                                    {comment.authorName.charAt(0).toUpperCase()}\r\n                                                </div>\r\n                                            )}\r\n                                            <div className=\"min-w-0 text-[12px] leading-snug break-all\">\r\n                                                <span className=\"font-bold text-white mr-2\">{comment.authorName}</span>\r\n                                                <span className=\"text-white/90\">{comment.content}</span>\r\n                                                <span className=\"text-white/30 text-[10px] ml-2 inline-block\">\r\n                                                    {formatRelativeTime(new Date(comment.createdAt).getTime())}\r\n                                                </span>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                ))\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Comment Input */}\r\n                        {currentUser && (\r\n                            <form\r\n                                onSubmit={handleSubmitComment}\r\n                                className=\"flex gap-2 pointer-events-auto mt-2\" // Reduced margin\r\n                                onClick={(e) => e.stopPropagation()}\r\n                                onMouseDown={(e) => e.stopPropagation()}\r\n                                onPointerDown={(e) => e.stopPropagation()}\r\n                            >\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={newComment}\r\n                                    onChange={(e) => setNewComment(e.target.value)}\r\n                                    onKeyDown={(e) => e.stopPropagation()}\r\n                                    onMouseDown={(e) => e.stopPropagation()}\r\n                                    onPointerDown={(e) => e.stopPropagation()}\r\n                                    onClick={(e) => {\r\n                                        e.stopPropagation();\r\n                                        e.currentTarget.focus();\r\n                                    }}\r\n                                    onTouchStart={(e) => e.stopPropagation()}\r\n                                    placeholder={t('write_comment')}\r\n                                    className=\"flex-1 bg-white/5 border border-white/10 rounded-lg px-2.5 py-1.5 text-xs text-white placeholder:text-white/40 focus:outline-none focus:ring-1 focus:ring-purple-500/50 pointer-events-auto cursor-text select-text z-50\"\r\n                                    style={{ pointerEvents: 'auto' }}\r\n                                    disabled={isSubmitting}\r\n                                    autoComplete=\"off\"\r\n                                />\r\n                                <button\r\n                                    type=\"submit\"\r\n                                    disabled={!newComment.trim() || isSubmitting}\r\n                                    className=\"p-1.5 bg-purple-600 hover:bg-purple-500 disabled:bg-white/10 disabled:text-white/30 text-white rounded-lg transition-all disabled:cursor-not-allowed pointer-events-auto flex items-center justify-center\"\r\n                                    onClick={(e) => e.stopPropagation()}\r\n                                >\r\n                                    <Send size={14} />\r\n                                </button>\r\n                            </form>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Decorative Background Elements */}\r\n                <div className=\"absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none\"></div>\r\n                <div className=\"absolute bottom-0 left-0 w-24 h-24 bg-indigo-500/10 rounded-full blur-2xl -ml-12 -mb-12 pointer-events-none\"></div>\r\n            </div>\r\n\r\n            {/* Map Pointer/Triangle */}\r\n            <div\r\n                style={{\r\n                    position: 'absolute',\r\n                    bottom: '0', // Align to bottom of the padded container\r\n                    left: '50%',\r\n                    transform: 'translateX(-50%)',\r\n                    width: 0,\r\n                    height: 0,\r\n                    borderLeft: '20px solid transparent',\r\n                    borderRight: '20px solid transparent',\r\n                    borderTopWidth: '20px',\r\n                    borderTopStyle: 'solid',\r\n                    borderTopColor: isFriend ? '#051a0d' : '#120024',\r\n                    filter: isFriend\r\n                        ? 'drop-shadow(0 4px 4px rgba(34,197,94,0.1))'\r\n                        : 'drop-shadow(0 4px 4px rgba(0,0,0,0.5))',\r\n                    zIndex: -1\r\n                }}\r\n            />\r\n\r\n            {/* Hidden Share Card Template */}\r\n            <div className=\"absolute -z-50 top-0 left-0 overflow-hidden pointer-events-none opacity-0\" aria-hidden=\"true\">\r\n                <div\r\n                    id={`share-card-${message.id}`}\r\n                    className=\"w-[360px] h-[640px] relative bg-[#1a0033] flex flex-col overflow-hidden text-white\"\r\n                >\r\n                    {/* Background Map - Real Mapbox Style */}\r\n                    <div className=\"absolute inset-0 z-0\">\r\n                        <Map\r\n                            initialViewState={{\r\n                                longitude: message.lng,\r\n                                latitude: message.lat,\r\n                                zoom: 10.5 // Zoomed out ~2x (from 12.5) as requested\r\n                            }}\r\n                            mapStyle={customMapStyle as any}\r\n                            mapboxAccessToken={process.env.NEXT_PUBLIC_MAPBOX_TOKEN}\r\n                            attributionControl={false}\r\n                            preserveDrawingBuffer={true} // Essential for html-to-image capture\r\n                            style={{ width: '100%', height: '100%' }}\r\n                            interactive={false}\r\n                        />\r\n                    </div>\r\n\r\n                    {/* Central Content - The Bubble (Correctly Positioned) */}\r\n                    <div className=\"absolute inset-0 z-10 pointer-events-none\">\r\n                        <div\r\n                            style={{\r\n                                position: 'absolute',\r\n                                top: '50%',\r\n                                left: '50%',\r\n                                transform: 'translate(-50%, -100%)', // Anchors bottom-center (tail tip) to map center\r\n                                display: 'flex',\r\n                                flexDirection: 'column',\r\n                                alignItems: 'center',\r\n                                filter: 'drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3))',\r\n                                transformOrigin: 'bottom center',\r\n                                paddingBottom: '0px' // Ensure no extra padding at bottom\r\n                            }}\r\n                        >\r\n                            {/* Chat bubble */}\r\n                            <div\r\n                                style={{\r\n                                    position: 'relative',\r\n                                    maxWidth: '240px', // Exact match\r\n                                    padding: '8px 12px 8px 8px', // Exact match\r\n                                    background: isFriend\r\n                                        ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%)'\r\n                                        : 'linear-gradient(135deg, rgba(123, 44, 191, 0.95) 0%, rgba(157, 78, 221, 0.95) 100%)',\r\n                                    backdropFilter: 'blur(12px)',\r\n                                    borderRadius: '24px',\r\n                                    border: isFriend ? '1px solid rgba(52, 211, 153, 0.3)' : '1px solid rgba(199, 125, 255, 0.3)',\r\n                                    boxShadow: isFriend\r\n                                        ? '0 8px 32px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.4)'\r\n                                        : '0 8px 32px rgba(123, 44, 191, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.4)',\r\n                                    color: 'white',\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    gap: '10px',\r\n                                }}\r\n                            >\r\n                                {/* Shine effect */}\r\n                                <div style={{\r\n                                    position: 'absolute',\r\n                                    top: 0,\r\n                                    left: 0,\r\n                                    right: 0,\r\n                                    height: '50%',\r\n                                    background: 'linear-gradient(to bottom, rgba(255, 255, 255, 0.15), transparent)',\r\n                                    borderRadius: '24px 24px 0 0',\r\n                                    pointerEvents: 'none',\r\n                                    zIndex: 0\r\n                                }} />\r\n\r\n                                {/* Avatar */}\r\n                                <div className=\"relative z-10 w-8 h-8 shrink-0\">\r\n                                    {message.userImage ? (\r\n                                        <img\r\n                                            src={message.userImage}\r\n                                            alt={message.userName}\r\n                                            className=\"w-full h-full rounded-full object-cover border-2 border-white/20\"\r\n                                            crossOrigin=\"anonymous\"\r\n                                        />\r\n                                    ) : (\r\n                                        <div className=\"w-full h-full rounded-full flex items-center justify-center border-2 border-white/20 text-xs font-bold bg-indigo-500\">\r\n                                            {message.userName.charAt(0).toUpperCase()}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n\r\n                                {/* Content */}\r\n                                <div className=\"flex flex-col relative z-10 min-w-0 flex-1\">\r\n                                    <span style={{ fontSize: '14px', fontWeight: 500, lineHeight: 1.2 }}>\r\n                                        {message.text}\r\n                                    </span>\r\n                                    <div className=\"flex items-center mt-0.5 space-x-2\">\r\n                                        <span style={{ fontSize: '10px', color: 'rgba(255,255,255,0.7)', fontWeight: 600 }}>\r\n                                            {message.userName} • {formatRelativeTime(message.timestamp)}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* NEW HEART LIKE BUTTON - Matches Map bubble design */}\r\n                                <div\r\n                                    style={{\r\n                                        position: 'absolute',\r\n                                        bottom: '-6px',\r\n                                        right: '-6px',\r\n                                        zIndex: 100,\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        minWidth: '28px',\r\n                                        height: '28px',\r\n                                        padding: '0 8px',\r\n                                        borderRadius: '9999px',\r\n                                        background: 'rgba(0,0,0,0.6)',\r\n                                        border: '1px solid rgba(255,255,255,0.4)',\r\n                                        boxShadow: '0 4px 12px rgba(0,0,0,0.3)',\r\n                                        backdropFilter: 'blur(12px)',\r\n                                        gap: '4px'\r\n                                    }}\r\n                                >\r\n                                    <svg\r\n                                        style={{ width: '12px', height: '12px', color: 'rgba(255,255,255,0.7)' }}\r\n                                        fill=\"none\"\r\n                                        viewBox=\"0 0 24 24\"\r\n                                        stroke=\"currentColor\"\r\n                                        strokeWidth={2}\r\n                                    >\r\n                                        <path d=\"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z\" />\r\n                                    </svg>\r\n                                    {(message.likes || 0) > 0 && (\r\n                                        <span style={{ fontSize: '9px', fontWeight: 900, color: 'white', letterSpacing: '-0.025em' }}>\r\n                                            {message.likes}\r\n                                        </span>\r\n                                    )}\r\n                                </div>\r\n\r\n                            </div>\r\n\r\n                            {/* Tail */}\r\n                            <div style={{\r\n                                width: 0,\r\n                                height: 0,\r\n                                borderLeft: '8px solid transparent',\r\n                                borderRight: '8px solid transparent',\r\n                                borderTop: isFriend ? '10px solid rgba(5, 150, 105, 0.95)' : '10px solid rgba(157, 78, 221, 0.95)',\r\n                                marginTop: '-1px',\r\n                                filter: 'drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2))'\r\n                            }} />\r\n\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Download CTA */}\r\n                    <div className=\"absolute bottom-12 w-full text-center z-20\">\r\n                        <div className=\"text-2xl font-bold tracking-tighter lowercase\" style={{\r\n                            background: 'linear-gradient(to right, #c084fc, #e879f9)',\r\n                            WebkitBackgroundClip: 'text',\r\n                            WebkitTextFillColor: 'transparent',\r\n                            filter: 'drop-shadow(0 0 10px rgba(192, 132, 252, 0.5))'\r\n                        }}>\r\n                            geogram\r\n                        </div>\r\n                    </div>\r\n\r\n                </div>\r\n            </div>\r\n\r\n            {/* Custom Share Menu Bottom Sheet */}\r\n            {\r\n                showShareMenu && typeof document !== 'undefined' && createPortal(\r\n                    <AnimatePresence mode=\"wait\">\r\n                        <m.div\r\n                            key=\"backdrop\"\r\n                            className=\"fixed inset-0 z-[2147483647] bg-black/60 pointer-events-auto\"\r\n                            initial={{ opacity: 0 }}\r\n                            animate={{ opacity: 1 }}\r\n                            exit={{ opacity: 0 }}\r\n                            onClick={() => {\r\n                                setShowShareMenu(false);\r\n                                setGeneratedImage(null);\r\n                                setIsGenerating(false);\r\n                            }}\r\n                        />\r\n                        <m.div\r\n                            key=\"sheet\"\r\n                            className=\"fixed bottom-0 left-0 right-0 z-[2147483647] pointer-events-none flex justify-center\"\r\n                            initial={{ y: \"100%\" }}\r\n                            animate={{ y: 0 }}\r\n                            exit={{ y: \"100%\" }}\r\n                            transition={{ type: \"spring\", damping: 25, stiffness: 300 }}\r\n                        >\r\n                            <div\r\n                                className=\"relative w-full max-w-md bg-[#1a0033] rounded-t-3xl p-6 pb-10 ring-1 ring-white/20 shadow-2xl animate-in slide-in-from-bottom duration-200 pointer-events-auto\"\r\n                                onClick={(e) => e.stopPropagation()}\r\n                            >\r\n                                <div className=\"flex flex-col gap-4\">\r\n                                    <div className=\"w-12 h-1 bg-white/20 rounded-full mx-auto mb-2\" />\r\n                                    <h3 className=\"text-white text-center font-bold mb-2\">{t('share_to')}</h3>\r\n\r\n                                    <div className=\"grid grid-cols-4 gap-4 justify-items-center\">\r\n                                        {/* Instagram Option */}\r\n                                        <button\r\n                                            onClick={() => handleShareAction('instagram')}\r\n                                            className=\"flex flex-col items-center gap-2 group w-full\"\r\n                                        >\r\n                                            <div className=\"w-14 h-14 rounded-full bg-gradient-to-tr from-yellow-500 via-red-500 to-purple-500 flex items-center justify-center shadow-lg group-active:scale-95 transition-transform\">\r\n                                                <Icons.Instagram className=\"w-7 h-7 text-white\" />\r\n                                            </div>\r\n                                            <span className=\"text-xs text-white/80\">{t('stories')}</span>\r\n                                        </button>\r\n\r\n                                        {/* WhatsApp Option */}\r\n                                        <button\r\n                                            onClick={() => handleShareAction('whatsapp')}\r\n                                            className=\"flex flex-col items-center gap-2 group w-full\"\r\n                                        >\r\n                                            <div className=\"w-14 h-14 rounded-full bg-[#25D366] flex items-center justify-center shadow-lg group-active:scale-95 transition-transform\">\r\n                                                <Icons.WhatsApp className=\"w-7 h-7 text-white\" />\r\n                                            </div>\r\n                                            <span className=\"text-xs text-white/80\">WhatsApp</span>\r\n                                        </button>\r\n\r\n                                        {/* System Option */}\r\n                                        <button\r\n                                            onClick={() => handleShareAction('system')}\r\n                                            className=\"flex flex-col items-center gap-2 group w-full\"\r\n                                        >\r\n                                            <div className=\"w-14 h-14 rounded-full bg-white/10 border border-white/10 flex items-center justify-center shadow-lg group-active:scale-95 transition-transform\">\r\n                                                <Icons.More className=\"w-7 h-7 text-white\" />\r\n                                            </div>\r\n                                            <span className=\"text-xs text-white/80\">{t('more')}</span>\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    <button\r\n                                        onClick={() => setShowShareMenu(false)}\r\n                                        className=\"mt-4 w-full py-3 bg-white/5 rounded-xl text-white font-medium hover:bg-white/10 active:scale-[0.98] transition-all\"\r\n                                    >\r\n                                        {t('cancel')}\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        </m.div>\r\n                    </AnimatePresence>,\r\n                    document.body\r\n                )\r\n            }\r\n\r\n            {/* Badge Celebration Overlay */}\r\n            {\r\n                earnedBadges.length > 0 && (\r\n                    <BadgeEarnedModal\r\n                        badgeId={earnedBadges[0]}\r\n                        onClose={() => setEarnedBadges(prev => prev.slice(1))}\r\n                    />\r\n                )\r\n            }\r\n        </m.div>\r\n    );\r\n});\r\n\r\nMessageDetails.displayName = 'MessageDetails';\r\nexport default MessageDetails;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\MobileGoogleSignIn.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\OnboardingModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\PushNotificationManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\VoteControls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\views\\FriendsView.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":169,"column":57,"nodeType":"JSXOpeningElement","endLine":169,"endColumn":140},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":247,"column":49,"nodeType":"JSXOpeningElement","endLine":247,"endColumn":139},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":311,"column":49,"nodeType":"JSXOpeningElement","endLine":311,"endColumn":150},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":371,"column":49,"nodeType":"JSXOpeningElement","endLine":371,"endColumn":145}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useUser } from \"@/hooks/useUser\";\r\nimport { useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport AuthPrompt from \"@/components/AuthPrompt\";\r\nimport { Share } from \"@capacitor/share\";\r\nimport { Users, Search, UserPlus, UserCheck, X, UserMinus, Loader2, Share2, Star } from \"lucide-react\";\r\nimport { useTranslation } from \"@/context/LocalizationContext\";\r\nimport { BADGE_CONFIGS } from \"@/lib/badgeConfig\";\r\n\r\nexport default function FriendsView() {\r\n    const { user, searchUsers, handleFriendRequest, toggleGhostException, isLoading } = useUser();\r\n    const { t } = useTranslation();\r\n    const router = useRouter();\r\n    const [searchQuery, setSearchQuery] = useState(\"\");\r\n    const [searchResults, setSearchResults] = useState<any[]>([]);\r\n    const [isSearching, setIsSearching] = useState(false);\r\n    const [confirmRemove, setConfirmRemove] = useState<{ id: string; name: string } | null>(null);\r\n    const [isSearchFocused, setIsSearchFocused] = useState(false);\r\n    const [loadingAction, setLoadingAction] = useState<string | null>(null);\r\n    const [isExceptionUpdating, setIsExceptionUpdating] = useState<string | null>(null);\r\n\r\n    const handleSearch = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!searchQuery.trim()) return;\r\n\r\n        setIsSearching(true);\r\n        const results = await searchUsers(searchQuery);\r\n        setSearchResults(results);\r\n        setIsSearching(false);\r\n    };\r\n\r\n    const handleRemoveFriend = async (friendId: string) => {\r\n        setLoadingAction(`remove-${friendId}`);\r\n        await handleFriendRequest(friendId, 'remove');\r\n        setConfirmRemove(null);\r\n        setLoadingAction(null);\r\n    };\r\n\r\n    const handleFriendAction = async (userId: string, action: 'send' | 'accept' | 'reject' | 'cancel') => {\r\n        setLoadingAction(`${action}-${userId}`);\r\n        await handleFriendRequest(userId, action);\r\n        setLoadingAction(null);\r\n    };\r\n\r\n    const handleInvite = async () => {\r\n        const text = t('invite_text');\r\n        const title = t('invite_title');\r\n\r\n        if (typeof navigator !== 'undefined' && navigator.share) {\r\n            try {\r\n                await navigator.share({\r\n                    title: title,\r\n                    text: text,\r\n                });\r\n                return;\r\n            } catch (error) {\r\n                console.log('Web Share Error:', error);\r\n            }\r\n        }\r\n\r\n        try {\r\n            await Share.share({\r\n                title: title,\r\n                text: text,\r\n                dialogTitle: title,\r\n            });\r\n        } catch (error) {\r\n            console.log('Capacitor Share Error:', error);\r\n            try {\r\n                await navigator.clipboard.writeText(text);\r\n                alert(t('link_copied'));\r\n            } catch (err) {\r\n                console.error(\"Clipboard failed\", err);\r\n            }\r\n        }\r\n    };\r\n\r\n    const hasPendingRequest = (userId: string) => {\r\n        return user?.friendRequests.outgoing.some((req: any) => req.id === userId);\r\n    };\r\n\r\n    if (isLoading) {\r\n        return <div className=\"text-white text-center p-8\">Loading...</div>;\r\n    }\r\n\r\n    if (!user) {\r\n        return (\r\n            <div className=\"w-full h-full flex flex-col p-4 pt-20 pb-24 pointer-events-auto bg-black/80 backdrop-blur-md\">\r\n                <AuthPrompt\r\n                    icon={Users}\r\n                    title={t('friends')}\r\n                    description={t('ghost_mode_desc')}\r\n                />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"w-full h-full flex flex-col p-4 pt-20 pb-24 overflow-y-auto pointer-events-auto bg-[#120024]/80 backdrop-blur-2xl\">\r\n            <div className=\"max-w-md mx-auto w-full space-y-8\">\r\n                <h1 className=\"text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-indigo-300 drop-shadow-sm mb-6 pl-1\">\r\n                    {t('community')}\r\n                </h1>\r\n\r\n                {/* Invite Friend Button */}\r\n                <button\r\n                    onClick={handleInvite}\r\n                    className=\"w-full mb-6 bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-500/30 hover:border-green-500/50 rounded-2xl p-4 flex items-center justify-between group transition-all duration-300 hover:shadow-lg hover:shadow-green-900/20 active:scale-98\"\r\n                >\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center text-green-400 group-hover:scale-110 transition-transform\">\r\n                            <Share2 size={20} />\r\n                        </div>\r\n                        <div className=\"text-left\">\r\n                            <div className=\"text-white font-semibold\">{t('invite_friends')}</div>\r\n                            <div className=\"text-green-200/60 text-xs\">{t('share_geogram_desc')}</div>\r\n                        </div>\r\n                    </div>\r\n                </button>\r\n\r\n                {/* Search */}\r\n                <form onSubmit={handleSearch} className=\"relative group\">\r\n                    <div className={`absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl blur opacity-20 group-hover:opacity-60 transition duration-500 ${isSearchFocused ? 'opacity-70 blur-md' : ''}`}></div>\r\n                    <div className=\"relative\">\r\n                        <input\r\n                            type=\"text\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                            onFocus={() => setIsSearchFocused(true)}\r\n                            onBlur={() => setIsSearchFocused(false)}\r\n                            placeholder={t('find_friends')}\r\n                            className=\"w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-base text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-purple-500/50 transition-all shadow-inner\"\r\n                            style={isSearchFocused ? { paddingLeft: '68px', color: 'white' } : { paddingLeft: '48px' }}\r\n                        />\r\n                        <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 text-white/50 group-hover:text-white/80 transition-colors\" size={20} />\r\n                        {isSearchFocused && (\r\n                            <div className=\"absolute left-12 top-1/2 -translate-y-1/2 text-purple-400 font-medium pointer-events-none animate-in fade-in slide-in-from-left-2 duration-200\" style={{ fontSize: '16px', textShadow: '0 0 10px rgba(168, 85, 247, 0.5)', marginTop: '-1px' }}>@</div>\r\n                        )}\r\n                        <button\r\n                            type=\"submit\"\r\n                            disabled={isSearching}\r\n                            className={`absolute right-2 top-2 h-[calc(100%-16px)] px-4 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center gap-1.5 shadow-lg ${isSearchFocused || searchQuery ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:shadow-purple-500/25 hover:scale-105' : 'bg-white/5 text-white/30 cursor-not-allowed'}`}\r\n                        >\r\n                            {isSearching ? <Loader2 size={16} className=\"animate-spin\" /> : t('search')}\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n\r\n                {/* Search Results */}\r\n                {searchResults.length > 0 && (\r\n                    <div className=\"space-y-3 animate-in fade-in slide-in-from-bottom-4 duration-500\">\r\n                        <h3 className=\"text-xs font-bold text-purple-300/80 uppercase tracking-widest pl-1\">{t('found_users')}</h3>\r\n                        {searchResults.map((result) => {\r\n                            const isPending = hasPendingRequest(result.id);\r\n                            const isFriend = user.friends.some((f: any) => f.id === result.id);\r\n\r\n                            return (\r\n                                <div key={result.id} className=\"group bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/20 rounded-2xl p-4 flex items-center justify-between transition-all duration-300 shadow-lg hover:shadow-purple-500/10\">\r\n                                    <div\r\n                                        className=\"flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity\"\r\n                                        onClick={() => router.push(`/profile?id=${result.id}`)}\r\n                                    >\r\n                                        <div className=\"relative w-12 h-12\">\r\n                                            <div className=\"w-12 h-12 rounded-full p-[2px] bg-gradient-to-br from-purple-500/50 to-indigo-500/50\">\r\n                                                <div className=\"w-full h-full rounded-full bg-black/50 overflow-hidden flex items-center justify-center text-white font-bold text-lg backdrop-blur-sm\">\r\n                                                    {result.image ? (\r\n                                                        <img src={result.image} alt={result.name} className=\"w-full h-full object-cover\" />\r\n                                                    ) : (\r\n                                                        result.name.charAt(0).toUpperCase()\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n                                            {result.activeBadgeId && BADGE_CONFIGS[result.activeBadgeId] && (\r\n                                                <div\r\n                                                    title={t(BADGE_CONFIGS[result.activeBadgeId].nameKey)}\r\n                                                    className={`absolute -top-1 -right-1 z-20 flex items-center justify-center w-6 h-6 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[result.activeBadgeId].style} text-xs shadow-sm transform rotate-12 ring-1 ring-white/20`}\r\n                                                >\r\n                                                    {BADGE_CONFIGS[result.activeBadgeId].icon}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                        <div>\r\n                                            <div className=\"text-white font-semibold text-lg leading-tight group-hover:text-purple-200 transition-colors\">{result.name}</div>\r\n                                            {result.username && (\r\n                                                <div className=\"text-white/40 text-sm\">@{result.username}</div>\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                    {isFriend ? (\r\n                                        <div className=\"px-3 py-1 bg-green-500/20 text-green-400 text-xs font-bold rounded-full border border-green-500/30\">\r\n                                            {t('following')}\r\n                                        </div>\r\n                                    ) : isPending ? (\r\n                                        <button\r\n                                            onClick={() => handleFriendAction(result.id, 'cancel')}\r\n                                            disabled={loadingAction === `cancel-${result.id}`}\r\n                                            className=\"px-4 py-2 bg-white/5 hover:bg-white/10 text-white/60 rounded-xl text-xs font-medium transition-all border border-white/5 hover:border-white/20\"\r\n                                        >\r\n                                            {loadingAction === `cancel-${result.id}` ? (\r\n                                                <Loader2 size={16} className=\"animate-spin\" />\r\n                                            ) : (\r\n                                                t('pending')\r\n                                            )}\r\n                                        </button>\r\n                                    ) : (\r\n                                        <button\r\n                                            onClick={() => handleFriendAction(result.id, 'send')}\r\n                                            disabled={loadingAction === `send-${result.id}`}\r\n                                            className=\"p-3 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl text-white shadow-lg shadow-purple-900/40 hover:scale-105 active:scale-95 transition-all\"\r\n                                        >\r\n                                            {loadingAction === `send-${result.id}` ? (\r\n                                                <Loader2 size={20} className=\"animate-spin\" />\r\n                                            ) : (\r\n                                                <UserPlus size={20} />\r\n                                            )}\r\n                                        </button>\r\n                                    )}\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Friend Requests */}\r\n                {user.friendRequests.incoming.length > 0 && (\r\n                    <div className=\"space-y-3 animate-in fade-in slide-in-from-bottom-4 duration-500 delay-100\">\r\n                        <div className=\"flex items-center gap-2 pl-1\">\r\n                            <span className=\"relative flex h-2 w-2\">\r\n                                <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-400 opacity-75\"></span>\r\n                                <span className=\"relative inline-flex rounded-full h-2 w-2 bg-purple-500\"></span>\r\n                            </span>\r\n                            <h3 className=\"text-xs font-bold text-white/80 uppercase tracking-widest\">{t('requests')}</h3>\r\n                        </div>\r\n\r\n                        {user.friendRequests.incoming.map((req) => (\r\n                            <div key={req.id} className=\"relative overflow-hidden bg-gradient-to-r from-purple-900/40 to-black/40 border border-purple-500/30 rounded-2xl p-4 flex items-center justify-between shadow-lg shadow-purple-900/20\">\r\n                                <div className=\"absolute top-0 left-0 w-1 h-full bg-purple-500\"></div>\r\n                                <div\r\n                                    className=\"flex items-center gap-4 overflow-hidden cursor-pointer hover:opacity-80 transition-opacity\"\r\n                                    onClick={() => router.push(`/profile?id=${req.id}`)}\r\n                                >\r\n                                    <div className=\"relative w-10 h-10 shrink-0\">\r\n                                        <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white font-bold shadow-inner\">\r\n                                            {req.image ? (\r\n                                                <img src={req.image} alt={req.name} className=\"w-full h-full rounded-full object-cover\" />\r\n                                            ) : (\r\n                                                req.name.charAt(0).toUpperCase()\r\n                                            )}\r\n                                        </div>\r\n                                        {req.activeBadgeId && BADGE_CONFIGS[req.activeBadgeId] && (\r\n                                            <div\r\n                                                title={t(BADGE_CONFIGS[req.activeBadgeId].nameKey)}\r\n                                                className={`absolute -top-1 -right-1 z-20 flex items-center justify-center w-5 h-5 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[req.activeBadgeId].style} text-[10px] shadow-sm transform rotate-12 ring-1 ring-white/20`}\r\n                                            >\r\n                                                {BADGE_CONFIGS[req.activeBadgeId].icon}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"min-w-0\">\r\n                                        <div className=\"text-white font-semibold truncate\">{req.name}</div>\r\n                                        <div className=\"text-purple-300 text-xs truncate\">{t('wants_to_connect')}</div>\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"flex gap-2 shrink-0 ml-2\">\r\n                                    <button\r\n                                        onClick={() => handleFriendAction(req.id, 'accept')}\r\n                                        disabled={loadingAction === `accept-${req.id}`}\r\n                                        className=\"p-2.5 bg-green-500/80 hover:bg-green-500 text-white rounded-xl shadow-lg hover:scale-105 transition-all\"\r\n                                    >\r\n                                        {loadingAction === `accept-${req.id}` ? (\r\n                                            <Loader2 size={18} className=\"animate-spin\" />\r\n                                        ) : (\r\n                                            <UserCheck size={18} strokeWidth={2.5} />\r\n                                        )}\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => handleFriendAction(req.id, 'reject')}\r\n                                        disabled={loadingAction === `reject-${req.id}`}\r\n                                        className=\"p-2.5 bg-white/10 hover:bg-white/20 text-white/60 hover:text-red-400 rounded-xl transition-all\"\r\n                                    >\r\n                                        {loadingAction === `reject-${req.id}` ? (\r\n                                            <Loader2 size={18} className=\"animate-spin\" />\r\n                                        ) : (\r\n                                            <X size={18} />\r\n                                        )}\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Sent Requests */}\r\n                {user.friendRequests.outgoing.length > 0 && (\r\n                    <div className=\"space-y-3 animate-in fade-in slide-in-from-bottom-4 duration-500 delay-150\">\r\n                        <div className=\"flex items-center gap-2 pl-1\">\r\n                            <h3 className=\"text-xs font-bold text-white/40 uppercase tracking-widest\">{t('sent_requests')}</h3>\r\n                        </div>\r\n\r\n                        {user.friendRequests.outgoing.map((req) => (\r\n                            <div key={req.id} className=\"bg-white/[0.03] border border-white/5 rounded-2xl p-4 flex items-center justify-between transition-all duration-300\">\r\n                                <div\r\n                                    className=\"flex items-center gap-4 overflow-hidden cursor-pointer hover:opacity-80 transition-opacity\"\r\n                                    onClick={() => router.push(`/profile?id=${req.id}`)}\r\n                                >\r\n                                    <div className=\"relative w-10 h-10 shrink-0\">\r\n                                        <div className=\"w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-white/20 font-bold shrink-0\">\r\n                                            {req.image ? (\r\n                                                <img src={req.image} alt={req.name} className=\"w-full h-full rounded-full object-cover opacity-50\" />\r\n                                            ) : (\r\n                                                req.name.charAt(0).toUpperCase()\r\n                                            )}\r\n                                        </div>\r\n                                        {req.activeBadgeId && BADGE_CONFIGS[req.activeBadgeId] && (\r\n                                            <div\r\n                                                title={t(BADGE_CONFIGS[req.activeBadgeId].nameKey)}\r\n                                                className={`absolute -top-1 -right-1 z-20 flex items-center justify-center w-5 h-5 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[req.activeBadgeId].style} text-[10px] shadow-sm transform rotate-12 ring-1 ring-white/20 opacity-50`}\r\n                                            >\r\n                                                {BADGE_CONFIGS[req.activeBadgeId].icon}\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"min-w-0\">\r\n                                        <div className=\"text-white/60 font-medium truncate\">{req.name}</div>\r\n                                        <div className=\"text-white/20 text-xs truncate\">{t('waiting_response')}</div>\r\n                                    </div>\r\n                                </div>\r\n                                <button\r\n                                    onClick={() => handleFriendAction(req.id, 'cancel')}\r\n                                    disabled={loadingAction === `cancel-${req.id}`}\r\n                                    className=\"px-4 py-2 bg-white/5 hover:bg-white/10 text-white/40 hover:text-white/80 rounded-xl text-xs font-semibold transition-all border border-white/5 hover:border-white/20\"\r\n                                >\r\n                                    {loadingAction === `cancel-${req.id}` ? (\r\n                                        <Loader2 size={16} className=\"animate-spin\" />\r\n                                    ) : (\r\n                                        t('cancel')\r\n                                    )}\r\n                                </button>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Friends List */}\r\n                <div className=\"space-y-3\">\r\n                    <h3 className=\"text-xs font-bold text-white/40 uppercase tracking-widest pl-1 mt-6\">{t('my_circle')} ({user.friends.length})</h3>\r\n                    {user.friends.length === 0 ? (\r\n                        <div className=\"bg-white/5 border border-white/5 rounded-2xl p-8 text-center backdrop-blur-sm\">\r\n                            <div className=\"w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n                                <Users className=\"text-white/20\" size={32} />\r\n                            </div>\r\n                            <p className=\"text-white/40 font-medium\">{t('no_friends_yet')}</p>\r\n                            <p className=\"text-white/20 text-sm mt-1\">{t('search_for_people_desc')}</p>\r\n                        </div>\r\n                    ) : (\r\n                        user.friends.map((friend) => (\r\n                            <div key={friend.id} className=\"group bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/10 rounded-2xl p-3 flex items-center justify-between transition-all duration-300\">\r\n                                <div\r\n                                    className=\"flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity\"\r\n                                    onClick={() => router.push(`/profile?id=${friend.id}`)}\r\n                                >\r\n                                    <div className=\"relative\">\r\n                                        <div className={`w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-white font-bold shrink-0 ring-2 transition-all\r\n                                            ${user.ghostExceptions.includes(friend.id)\r\n                                                ? 'ring-emerald-500/50 shadow-[0_0_15px_rgba(16,185,129,0.3)]'\r\n                                                : 'ring-transparent group-hover:ring-purple-500/30'}`}\r\n                                        >\r\n                                            {friend.image ? (\r\n                                                <img src={friend.image} alt={friend.name} className=\"w-full h-full rounded-full object-cover\" />\r\n                                            ) : (\r\n                                                friend.name.charAt(0).toUpperCase()\r\n                                            )}\r\n                                        </div>\r\n                                        {friend.activeBadgeId && BADGE_CONFIGS[friend.activeBadgeId] && (\r\n                                            <div\r\n                                                title={t(BADGE_CONFIGS[friend.activeBadgeId].nameKey)}\r\n                                                className={`absolute -top-1 -right-1 z-20 flex items-center justify-center w-5 h-5 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[friend.activeBadgeId].style} text-[10px] shadow-sm transform rotate-12 ring-1 ring-white/20`}\r\n                                            >\r\n                                                {BADGE_CONFIGS[friend.activeBadgeId].icon}\r\n                                            </div>\r\n                                        )}\r\n                                        <div className=\"absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#120024] rounded-full\"></div>\r\n                                    </div>\r\n                                    <div className=\"min-w-0\">\r\n                                        <div className=\"flex items-center gap-1.5\">\r\n                                            <div className=\"text-white font-medium truncate group-hover:text-purple-200 transition-colors\">{friend.name}</div>\r\n                                            {user.ghostExceptions.includes(friend.id) && (\r\n                                                <Star size={10} className=\"fill-emerald-400 text-emerald-400 drop-shadow-[0_0_5px_rgba(52,211,153,0.8)]\" />\r\n                                            )}\r\n                                        </div>\r\n                                        {friend.username && <div className=\"text-white/30 text-xs truncate\">@{friend.username}</div>}\r\n                                    </div>\r\n                                </div>\r\n                                <div className=\"flex items-center gap-1\">\r\n                                    <button\r\n                                        onClick={async (e) => {\r\n                                            e.stopPropagation();\r\n                                            const isException = user.ghostExceptions.includes(friend.id);\r\n                                            setIsExceptionUpdating(friend.id);\r\n                                            await toggleGhostException(friend.id, isException ? 'remove' : 'add');\r\n                                            setIsExceptionUpdating(null);\r\n                                        }}\r\n                                        disabled={isExceptionUpdating === friend.id}\r\n                                        className={`p-2.5 rounded-xl transition-all active:scale-90 ${user.ghostExceptions.includes(friend.id)\r\n                                            ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20'\r\n                                            : 'text-white/20 hover:text-white/60 hover:bg-white/5'\r\n                                            }`}\r\n                                        title={user.ghostExceptions.includes(friend.id) ? t('remove_close_friend') : t('add_close_friend')}\r\n                                    >\r\n                                        {isExceptionUpdating === friend.id ? (\r\n                                            <Loader2 size={16} className=\"animate-spin\" />\r\n                                        ) : (\r\n                                            <Star\r\n                                                size={18}\r\n                                                className={user.ghostExceptions.includes(friend.id) ? \"fill-emerald-400\" : \"\"}\r\n                                            />\r\n                                        )}\r\n                                    </button>\r\n                                    <button\r\n                                        onClick={() => setConfirmRemove({ id: friend.id, name: friend.name })}\r\n                                        className=\"p-2.5 text-white/20 hover:text-red-400 hover:bg-red-500/10 rounded-xl transition-all opacity-0 group-hover:opacity-100\"\r\n                                    >\r\n                                        <UserMinus size={18} />\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n                        ))\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Confirmation Dialog */}\r\n            {confirmRemove && (\r\n                <div className=\"fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-in fade-in duration-200\">\r\n                    <div className=\"bg-[#1a0033] border border-white/10 rounded-3xl p-6 max-w-sm w-full shadow-2xl scale-100 animate-in zoom-in-95 duration-200\">\r\n                        <div className=\"w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center mb-4\">\r\n                            <UserMinus className=\"text-red-500\" size={24} />\r\n                        </div>\r\n                        <h3 className=\"text-xl font-bold text-white mb-2\">{t('unfriend_confirm_title').replace('{name}', confirmRemove.name)}</h3>\r\n                        <p className=\"text-white/60 mb-8 text-sm leading-relaxed\">\r\n                            {t('unfriend_confirm_desc')}\r\n                        </p>\r\n                        <div className=\"flex gap-3\">\r\n                            <button\r\n                                onClick={() => setConfirmRemove(null)}\r\n                                disabled={loadingAction === `remove-${confirmRemove.id}`}\r\n                                className=\"flex-1 px-4 py-3 bg-white/5 hover:bg-white/10 text-white rounded-xl font-medium transition-colors border border-white/5\"\r\n                            >\r\n                                {t('cancel')}\r\n                            </button>\r\n                            <button\r\n                                onClick={() => handleRemoveFriend(confirmRemove.id)}\r\n                                disabled={loadingAction === `remove-${confirmRemove.id}`}\r\n                                className=\"flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors shadow-lg shadow-red-900/20 flex items-center justify-center gap-2\"\r\n                            >\r\n                                {loadingAction === `remove-${confirmRemove.id}` ? (\r\n                                    <>\r\n                                        <Loader2 size={18} className=\"animate-spin\" />\r\n                                        {t('removing')}\r\n                                    </>\r\n                                ) : (\r\n                                    t('remove_friend')\r\n                                )}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\components\\views\\SettingsView.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":361,"column":37,"nodeType":"JSXOpeningElement","endLine":365,"endColumn":39},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":450,"column":41,"nodeType":"JSXOpeningElement","endLine":450,"endColumn":133}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\n\r\nimport { useUser } from \"@/hooks/useUser\";\r\nimport { User, Shield, LogOut, Settings, Settings2, Globe, Check, Loader2, X, Crown, Lock } from \"lucide-react\";\r\nimport { signOut } from \"next-auth/react\";\r\nimport AuthPrompt from \"@/components/AuthPrompt\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { getLevelProgress, getXPForNextLevel, getLevelTitle } from \"@/lib/gameLogic\";\r\nimport { useTranslation } from \"@/context/LocalizationContext\";\r\nimport { Language } from \"@/lib/translations\";\r\nimport { BADGE_CONFIGS } from \"@/lib/badgeConfig\";\r\nimport BadgeInfoModal from \"@/components/BadgeInfoModal\";\r\n\r\nconst LANGUAGES = [\r\n    { code: 'en', name: 'English', native: 'English', flag: '🇺🇸' },\r\n    { code: 'tr', name: 'Turkish', native: 'Türkçe', flag: '🇹🇷' },\r\n    { code: 'es', name: 'Spanish', native: 'Español', flag: '🇪🇸' },\r\n    { code: 'de', name: 'German', native: 'Deutsch', flag: '🇩🇪' },\r\n    { code: 'fr', name: 'French', native: 'Français', flag: '🇫🇷' },\r\n    { code: 'ru', name: 'Russian', native: 'Русский', flag: '🇷🇺' },\r\n    { code: 'zh-Hans', name: 'Chinese (Simplified)', native: '简体中文', flag: '🇨🇳' },\r\n    { code: 'zh-Hant', name: 'Chinese (Traditional)', native: '繁體中文', flag: '🇭🇰' },\r\n    // { code: 'ar', name: 'Arabic', native: 'العربية', flag: '🇸🇦' },\r\n    { code: 'ja', name: 'Japanese', native: '日本語', flag: '🇯🇵' },\r\n    { code: 'id', name: 'Indonesian', native: 'Bahasa Indonesia', flag: '🇮🇩' },\r\n    { code: 'th', name: 'Thai', native: 'ไทย', flag: '🇹🇭' },\r\n    { code: 'hi', name: 'Hindi', native: 'हिन्दी', flag: '🇮🇳' },\r\n    { code: 'it', name: 'Italian', native: 'Italiano', flag: '🇮🇹' },\r\n    { code: 'pt', name: 'Portuguese', native: 'Português', flag: '🇵🇹' },\r\n    { code: 'pl', name: 'Polish', native: 'Polski', flag: '🇵🇱' },\r\n    { code: 'ko', name: 'Korean', native: '한국어', flag: '🇰🇷' }\r\n];\r\n\r\nfunction LanguageDropdown({ lang, setLanguage }: { lang: string, setLanguage: (l: Language) => void }) {\r\n    const [isOpen, setIsOpen] = useState(false);\r\n    const selectedLang = LANGUAGES.find(l => l.code === lang) || LANGUAGES[0];\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-2\">\r\n            <button\r\n                onClick={() => setIsOpen(!isOpen)}\r\n                className={`w-full bg-white/5 border transition-all rounded-2xl p-4 flex items-center justify-between group shadow-lg active:scale-95 duration-200 ${isOpen ? 'border-purple-500/50 bg-purple-500/10' : 'border-white/10 hover:bg-white/10'\r\n                    }`}\r\n            >\r\n                <div className=\"flex items-center gap-3\">\r\n                    <span className=\"text-2xl drop-shadow-sm\">{selectedLang.flag}</span>\r\n                    <div className=\"text-left\">\r\n                        <div className=\"text-white font-bold\">{selectedLang.native}</div>\r\n                        <div className=\"text-white/40 text-[10px] uppercase tracking-widest\">{selectedLang.name}</div>\r\n                    </div>\r\n                </div>\r\n                <motion.div\r\n                    animate={{ rotate: isOpen ? 180 : 0 }}\r\n                    transition={{ type: \"spring\", stiffness: 300, damping: 20 }}\r\n                >\r\n                    <Settings2 size={18} className={`transition-colors ${isOpen ? 'text-purple-400' : 'text-white/40 group-hover:text-purple-400'}`} />\r\n                </motion.div>\r\n            </button>\r\n\r\n            <AnimatePresence initial={false}>\r\n                {isOpen && (\r\n                    <motion.div\r\n                        initial={{ height: 0, opacity: 0 }}\r\n                        animate={{ height: 'auto', opacity: 1 }}\r\n                        exit={{ height: 0, opacity: 0 }}\r\n                        transition={{ type: \"spring\", stiffness: 300, damping: 30, opacity: { duration: 0.2 } }}\r\n                        className=\"overflow-hidden\"\r\n                    >\r\n                        <div className=\"bg-[#1a0033]/40 border border-white/5 rounded-2xl p-2 mt-1 max-h-[220px] overflow-y-auto custom-scrollbar shadow-inner\">\r\n                            <style>{`\r\n                                .custom-scrollbar::-webkit-scrollbar {\r\n                                    width: 4px;\r\n                                }\r\n                                .custom-scrollbar::-webkit-scrollbar-track {\r\n                                    background: rgba(255, 255, 255, 0.05);\r\n                                    border-radius: 10px;\r\n                                }\r\n                                .custom-scrollbar::-webkit-scrollbar-thumb {\r\n                                    background: rgba(168, 85, 247, 0.4);\r\n                                    border-radius: 10px;\r\n                                }\r\n                                .custom-scrollbar::-webkit-scrollbar-thumb:hover {\r\n                                    background: rgba(168, 85, 247, 0.6);\r\n                                }\r\n                            `}</style>\r\n                            <div className=\"grid grid-cols-1 gap-1\">\r\n                                {LANGUAGES.map((l) => (\r\n                                    <button\r\n                                        key={l.code}\r\n                                        onClick={() => {\r\n                                            setLanguage(l.code as Language);\r\n                                            setIsOpen(false);\r\n                                        }}\r\n                                        className={`flex items-center gap-4 p-2.5 rounded-xl transition-all duration-200 active:scale-98 ${lang === l.code\r\n                                            ? 'bg-purple-600/30 border border-purple-500/40 text-white shadow-[0_0_15px_rgba(168,85,247,0.15)]'\r\n                                            : 'text-white/60 hover:bg-white/5 border border-transparent'\r\n                                            }`}\r\n                                    >\r\n                                        <span className=\"text-2xl drop-shadow-sm\">{l.flag}</span>\r\n                                        <div className=\"flex-1 text-left\">\r\n                                            <div className=\"font-bold text-sm\">{l.native}</div>\r\n                                            <div className=\"text-[10px] text-white/40 uppercase tracking-widest leading-none mt-1\">{l.name}</div>\r\n                                        </div>\r\n                                        {lang === l.code && <Check size={16} className=\"text-purple-400 animate-in zoom-in duration-300\" />}\r\n                                    </button>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default function SettingsView() {\r\n    const { user, toggleAnonymity, toggleLocationPrivacy, isLoading, mutate } = useUser();\r\n    const { t, lang, setLanguage } = useTranslation();\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editData, setEditData] = useState({ name: \"\", username: \"\", bio: \"\", image: \"\" });\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    // 2D / 3D map toggle — persisted in localStorage, read by Map.tsx\r\n    const [is3DMap, setIs3DMap] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_projection') !== 'mercator';\r\n        }\r\n        return true;\r\n    });\r\n\r\n    const toggle3DMap = (value: boolean) => {\r\n        setIs3DMap(value);\r\n        localStorage.setItem('geogram_map_projection', value ? 'globe' : 'mercator');\r\n        window.dispatchEvent(new StorageEvent('storage', {\r\n            key: 'geogram_map_projection',\r\n            newValue: value ? 'globe' : 'mercator',\r\n        }));\r\n    };\r\n\r\n    // 3D Buildings toggle\r\n    const [show3DBuildings, setShow3DBuildings] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_buildings') !== 'false';\r\n        }\r\n        return true;\r\n    });\r\n\r\n    const toggle3DBuildings = (value: boolean) => {\r\n        setShow3DBuildings(value);\r\n        localStorage.setItem('geogram_map_buildings', String(value));\r\n        window.dispatchEvent(new StorageEvent('storage', {\r\n            key: 'geogram_map_buildings',\r\n            newValue: String(value),\r\n        }));\r\n    };\r\n\r\n    // 3D Terrain toggle\r\n    const [show3DTerrain, setShow3DTerrain] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_terrain') === 'true';\r\n        }\r\n        return false;\r\n    });\r\n\r\n    const toggle3DTerrain = (value: boolean) => {\r\n        setShow3DTerrain(value);\r\n        localStorage.setItem('geogram_map_terrain', String(value));\r\n        window.dispatchEvent(new StorageEvent('storage', {\r\n            key: 'geogram_map_terrain',\r\n            newValue: String(value),\r\n        }));\r\n    };\r\n\r\n    // POI / Places toggle\r\n    const [showPOI, setShowPOI] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_poi') === 'true';\r\n        }\r\n        return false;\r\n    });\r\n\r\n    const togglePOI = (value: boolean) => {\r\n        setShowPOI(value);\r\n        localStorage.setItem('geogram_map_poi', String(value));\r\n        window.dispatchEvent(new StorageEvent('storage', {\r\n            key: 'geogram_map_poi',\r\n            newValue: String(value),\r\n        }));\r\n    };\r\n\r\n    // Road & Transit Network toggle\r\n    const [showTransit, setShowTransit] = useState<boolean>(() => {\r\n        if (typeof window !== 'undefined') {\r\n            return localStorage.getItem('geogram_map_transit') === 'true';\r\n        }\r\n        return false;\r\n    });\r\n\r\n    const toggleTransit = (value: boolean) => {\r\n        setShowTransit(value);\r\n        localStorage.setItem('geogram_map_transit', String(value));\r\n        window.dispatchEvent(new StorageEvent('storage', {\r\n            key: 'geogram_map_transit',\r\n            newValue: String(value),\r\n        }));\r\n    };\r\n\r\n    const startEditing = () => {\r\n        if (!user) return;\r\n        setEditData({\r\n            name: user.fullName || user.name || \"\",\r\n            username: user.username || \"\",\r\n            bio: user.bio || \"\",\r\n            image: user.image || \"\"\r\n        });\r\n        setIsEditing(true);\r\n    };\r\n\r\n    const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (!file) return;\r\n\r\n        setIsUploading(true);\r\n        try {\r\n            // Create a unique file name\r\n            const fileExt = file.name.split('.').pop();\r\n            const fileName = `${user?.id || 'unknown'}/${Date.now()}.${fileExt}`;\r\n            const filePath = `${fileName}`;\r\n\r\n            // Upload\r\n            const { error: uploadError } = await supabase.storage\r\n                .from('avatars')\r\n                .upload(filePath, file);\r\n\r\n            if (uploadError) {\r\n                throw uploadError;\r\n            }\r\n\r\n            // Get Public URL\r\n            const { data } = supabase.storage\r\n                .from('avatars')\r\n                .getPublicUrl(filePath);\r\n\r\n            setEditData(prev => ({ ...prev, image: data.publicUrl }));\r\n        } catch (error) {\r\n            console.error('Error uploading image:', error);\r\n            alert('Failed to upload image. Please try again.');\r\n        } finally {\r\n            setIsUploading(false);\r\n        }\r\n    };\r\n\r\n    const [selectedBadgeId, setSelectedBadgeId] = useState<string | null>(null);\r\n\r\n    const handleSelectBadge = async (badgeId: string) => {\r\n        try {\r\n            const res = await fetch('/api/users/update', {\r\n                method: 'PUT',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                credentials: 'include',\r\n                body: JSON.stringify({ activeBadgeId: badgeId })\r\n            });\r\n            if (res.ok) {\r\n                mutate(); // Refresh user state from SWR without page reload\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to select badge:\", error);\r\n        }\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        setIsSaving(true);\r\n        try {\r\n            const res = await fetch(\"/api/users/update\", {\r\n                method: \"PUT\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify(editData),\r\n            });\r\n\r\n            if (res.ok) {\r\n                mutate(); // Revalidate user data\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to save\", error);\r\n        } finally {\r\n            setIsSaving(false);\r\n            setIsEditing(false);\r\n        }\r\n    };\r\n\r\n    if (isLoading) {\r\n        return <div className=\"text-white text-center p-8\">Loading...</div>;\r\n    }\r\n\r\n    if (!user) {\r\n        return (\r\n            <div className=\"w-full h-full flex flex-col p-4 pt-20 pointer-events-auto bg-black/80 backdrop-blur-md\">\r\n                <AuthPrompt\r\n                    icon={Settings}\r\n                    title={t('manage_your_experience')}\r\n                    description={t('ghost_mode_desc')}\r\n                />\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"w-full h-full flex flex-col p-4 pt-20 pb-24 pointer-events-auto bg-[#120024]/80 backdrop-blur-2xl overflow-y-auto\">\r\n            <div className=\"max-w-md mx-auto w-full space-y-8\">\r\n                <h1 className=\"text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-indigo-300 drop-shadow-sm mb-6 pl-1\">\r\n                    {t('settings')}\r\n                </h1>\r\n\r\n                {/* Profile Card & Settings */}\r\n                <div className={`relative overflow-hidden border rounded-3xl p-6 shadow-2xl backdrop-blur-md group transition-all duration-500\r\n                    ${user.isPremium\r\n                        ? 'bg-gradient-to-br from-yellow-900/40 via-black to-black border-yellow-500/50 shadow-yellow-500/10'\r\n                        : 'bg-gradient-to-br from-white/5 to-white/[0.02] border-white/10'\r\n                    }`}\r\n                >\r\n                    {user.isPremium && (\r\n                        <>\r\n                            <div className=\"absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none\"></div>\r\n                            <div className=\"absolute top-0 right-0 w-40 h-40 bg-yellow-500/20 rounded-full blur-[60px] -mr-10 -mt-10 pointer-events-none animate-pulse\"></div>\r\n                            <div className=\"absolute bottom-0 left-0 w-32 h-32 bg-orange-500/10 rounded-full blur-[50px] -ml-10 -mb-10 pointer-events-none\"></div>\r\n                        </>\r\n                    )}\r\n\r\n                    {!user.isPremium && (\r\n                        <>\r\n                            <div className=\"absolute top-0 right-0 w-32 h-32 bg-purple-500/20 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none\"></div>\r\n                            <div className=\"absolute bottom-0 left-0 w-24 h-24 bg-indigo-500/20 rounded-full blur-2xl -ml-10 -mb-10 pointer-events-none\"></div>\r\n                        </>\r\n                    )}\r\n\r\n                    {!isEditing && (\r\n                        <button\r\n                            onClick={startEditing}\r\n                            className={`absolute top-4 right-4 p-2.5 rounded-xl transition-all border shadow-lg active:scale-95 z-40\r\n                                ${user.isPremium\r\n                                    ? 'bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-200 border-yellow-500/30 hover:border-yellow-500/50 hover:shadow-yellow-500/10'\r\n                                    : 'bg-white/10 hover:bg-white/20 text-white border-white/10 hover:border-white/20 hover:shadow-purple-500/10'\r\n                                }`}\r\n                            title={t('edit_profile')}\r\n                        >\r\n                            <Settings2 size={18} />\r\n                        </button>\r\n                    )}\r\n\r\n                    {isEditing ? (\r\n                        <div className=\"space-y-5 relative z-10 animate-in fade-in slide-in-from-bottom-2 duration-300\">\r\n                            <div className=\"flex justify-center mb-2\">\r\n                                <div className=\"relative w-28 h-28 group cursor-pointer transition-transform hover:scale-105\">\r\n                                    <div className={`absolute -inset-1 rounded-full blur opacity-40 group-hover:opacity-75 transition duration-500\r\n                                        ${user.isPremium ? 'bg-gradient-to-tr from-yellow-500 to-orange-500' : 'bg-gradient-to-tr from-purple-500 to-indigo-500'}`}\r\n                                    ></div>\r\n                                    <img\r\n                                        src={editData.image || user.image || \"https://via.placeholder.com/150\"}\r\n                                        alt=\"Preview\"\r\n                                        className=\"relative w-full h-full rounded-full object-cover opacity-60 border-2 border-white/20 z-10\"\r\n                                    />\r\n                                    <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none z-20\">\r\n                                        {isUploading ? (\r\n                                            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-white\"></div>\r\n                                        ) : (\r\n                                            <div className=\"flex flex-col items-center drop-shadow-md\">\r\n                                                <User className=\"text-white mb-1\" size={24} />\r\n                                                <span className=\"text-[10px] text-white font-bold text-center leading-tight uppercase tracking-wide\">Photo</span>\r\n                                            </div>\r\n                                        )}\r\n                                    </div>\r\n                                    <input\r\n                                        type=\"file\"\r\n                                        accept=\"image/*\"\r\n                                        onChange={handleImageUpload}\r\n                                        disabled={isUploading}\r\n                                        className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed z-30\"\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"space-y-4\">\r\n                                <div>\r\n                                    <label className={`block text-sm font-bold uppercase tracking-wider mb-2 ml-1 ${user.isPremium ? 'text-yellow-500' : 'text-purple-300'}`}>{t('full_name')}</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={editData.name}\r\n                                        onChange={e => setEditData({ ...editData, name: e.target.value })}\r\n                                        className=\"w-full px-4 py-3 bg-black/40 border border-white/10 rounded-xl text-white text-sm focus:outline-none focus:border-white/20 focus:ring-1 focus:ring-white/20 transition-all shadow-inner\"\r\n                                        placeholder={t('full_name')}\r\n                                        maxLength={16}\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className={`block text-sm font-bold uppercase tracking-wider mb-2 ml-1 ${user.isPremium ? 'text-yellow-500' : 'text-purple-300'}`}>{t('username')}</label>\r\n                                    <input\r\n                                        type=\"text\"\r\n                                        value={editData.username}\r\n                                        onChange={e => setEditData({ ...editData, username: e.target.value.toLowerCase().replace(/[^a-z0-9.]/g, '') })}\r\n                                        className=\"w-full px-4 py-3 bg-black/40 border border-white/10 rounded-xl text-white text-sm focus:outline-none focus:border-white/20 focus:ring-1 focus:ring-white/20 transition-all shadow-inner\"\r\n                                        placeholder={t('username')}\r\n                                        maxLength={16}\r\n                                    />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <label className={`block text-sm font-bold uppercase tracking-wider mb-2 ml-1 ${user.isPremium ? 'text-yellow-500' : 'text-purple-300'}`}>{t('bio')}</label>\r\n                                    <textarea\r\n                                        value={editData.bio}\r\n                                        onChange={e => setEditData({ ...editData, bio: e.target.value })}\r\n                                        className=\"w-full px-4 py-3 bg-black/40 border border-white/10 rounded-xl text-white text-sm focus:outline-none focus:border-white/20 focus:ring-1 focus:ring-white/20 transition-all shadow-inner min-h-[100px] resize-none\"\r\n                                        placeholder={t('bio')}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div className=\"flex gap-3 pt-2\">\r\n                                <button\r\n                                    onClick={() => setIsEditing(false)}\r\n                                    className=\"flex-1 py-3 bg-white/5 hover:bg-white/10 text-white rounded-xl text-sm font-semibold transition-colors border border-white/5\"\r\n                                >\r\n                                    {t('cancel')}\r\n                                </button>\r\n                                <button\r\n                                    onClick={handleSave}\r\n                                    disabled={isSaving || isUploading}\r\n                                    className={`flex-1 py-3 text-white rounded-xl text-sm font-semibold transition-all shadow-lg disabled:opacity-50\r\n                                        ${user.isPremium\r\n                                            ? 'bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 shadow-orange-900/40'\r\n                                            : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 shadow-purple-900/40'\r\n                                        }`}\r\n                                >\r\n                                    {isSaving ? <Loader2 className=\"animate-spin mx-auto\" size={20} /> : t('save')}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"flex items-center gap-6 relative z-10\">\r\n                            <div className=\"relative w-24 h-24 shrink-0\">\r\n                                <div className={`absolute -inset-1 rounded-full blur opacity-75\r\n                                    ${user.isPremium ? 'bg-gradient-to-tr from-yellow-500 to-orange-500 animate-pulse' : 'bg-gradient-to-tr from-purple-500 to-cyan-500'}`}\r\n                                ></div>\r\n                                <div className=\"relative w-full h-full rounded-full bg-black p-[3px] overflow-hidden\">\r\n                                    {user.image ? (\r\n                                        <img src={user.image} alt={user.name} className=\"w-full h-full rounded-full object-cover\" />\r\n                                    ) : (\r\n                                        <div className=\"w-full h-full rounded-full bg-gradient-to-br from-gray-800 to-black flex items-center justify-center text-white font-bold text-3xl\">\r\n                                            {user.name.charAt(0).toUpperCase()}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                                {user.isPremium && !user.activeBadgeId && (\r\n                                    <div className=\"absolute -bottom-2 -right-2 bg-gradient-to-r from-yellow-400 to-orange-500 text-black text-[10px] font-black w-8 h-8 flex items-center justify-center rounded-full border-2 border-black shadow-lg z-20\" title=\"Premium Member\">\r\n                                        👑\r\n                                    </div>\r\n                                )}\r\n                                {user.activeBadgeId && BADGE_CONFIGS[user.activeBadgeId] && (\r\n                                    <div\r\n                                        title={t(BADGE_CONFIGS[user.activeBadgeId].nameKey)}\r\n                                        className={`absolute top-0 right-0 z-20 flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br ${BADGE_CONFIGS[user.activeBadgeId].style} text-2xl shadow-lg transform rotate-12 ring-2 ring-[#120024]`}\r\n                                    >\r\n                                        {BADGE_CONFIGS[user.activeBadgeId].icon}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                            <div className=\"min-w-0 flex-1\">\r\n                                <div className=\"flex items-center gap-2 mb-1\">\r\n                                    <h2 className=\"text-2xl font-bold text-white truncate leading-tight\">{user.fullName || user.name}</h2>\r\n                                    {user.isPremium && (\r\n                                        <span className=\"bg-yellow-500/20 border border-yellow-500/50 text-yellow-300 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider\">\r\n                                            Premium\r\n                                        </span>\r\n                                    )}\r\n                                </div>\r\n                                <p className={`text-sm font-medium truncate mb-3 ${user.isPremium ? 'text-yellow-200/80' : 'text-purple-300/80'}`}>@{user.username || user.name.replace(/\\s+/g, '').toLowerCase()}</p>\r\n                                {user.bio && (\r\n                                    <p className=\"text-white/60 text-xs line-clamp-2 leading-relaxed font-light\">\r\n                                        {user.bio}\r\n                                    </p>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Level & XP Section */}\r\n                <div className=\"bg-white/5 border border-white/10 rounded-3xl p-6 shadow-xl backdrop-blur-md relative overflow-hidden group\">\r\n                    <div className=\"absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-yellow-500/20 to-orange-500/0 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none\"></div>\r\n\r\n                    <div className=\"flex justify-between items-end mb-2\">\r\n                        <div>\r\n                            <div className=\"text-white/80 text-sm font-bold uppercase tracking-wider mb-1\">{t('level')}</div>\r\n                            <div className=\"flex items-baseline gap-2\">\r\n                                <div className=\"text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-400 flex items-center gap-2\">\r\n                                    {user.level || 1}\r\n                                    {user.isPremium && <span className=\"text-2xl pt-1\">👑</span>}\r\n                                </div>\r\n                                <div className=\"text-lg font-bold text-purple-300/80\">\r\n                                    {getLevelTitle(user.level || 1)}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                            <div className=\"text-white/80 text-sm font-bold uppercase tracking-wider mb-1\">{t('xp_points')}</div>\r\n                            <div className=\"text-xl font-bold text-white font-mono\">\r\n                                {user.xp || 0} <span className=\"text-white/40 text-sm\">/ {getXPForNextLevel(user.level || 1)}</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* XP Progress Bar */}\r\n                    <div className=\"relative h-7 bg-gray-900/50 backdrop-blur-sm rounded-full overflow-hidden shadow-[inset_0_2px_4px_rgba(0,0,0,0.5)] border border-white/10 flex items-center justify-center group\">\r\n                        {/* Progress fill */}\r\n                        <div\r\n                            className=\"absolute top-0 left-0 h-full bg-gradient-to-r from-purple-800 via-purple-600 to-purple-400 shadow-[0_0_20px_rgba(168,85,247,0.5)] transition-all duration-1000 ease-out z-10\"\r\n                            style={{\r\n                                width: `${Math.max(2, getLevelProgress(user.xp || 0).percentage)}%`\r\n                            }}\r\n                        >\r\n                            {/* Glow tip */}\r\n                            <div className=\"absolute top-0 right-0 h-full w-[2px] bg-white/50 blur-[2px] shadow-[0_0_10px_white]\"></div>\r\n                        </div>\r\n\r\n                        {/* Text inside bar */}\r\n                        <div className=\"relative z-20 flex items-center justify-center gap-1.5 h-full w-full text-[10px] font-bold tracking-widest uppercase text-white/90 drop-shadow-md leading-none\">\r\n                            <span className=\"text-purple-300\">\r\n                                {Math.ceil(getLevelProgress(user.xp || 0).total - getLevelProgress(user.xp || 0).current)} XP\r\n                            </span>\r\n                            <span className=\"opacity-80\">{t('to_next_level')}</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Badge Collection Section */}\r\n                <div className=\"bg-white/5 border border-white/10 rounded-3xl p-6 shadow-xl backdrop-blur-md\">\r\n                    <div className=\"flex items-center justify-between mb-6 pl-1\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <div className=\"w-8 h-8 rounded-xl bg-yellow-500/20 flex items-center justify-center text-yellow-400\">\r\n                                <Crown size={18} />\r\n                            </div>\r\n                            <h2 className=\"text-lg font-bold text-white uppercase tracking-wider\">{t('badges_collection')}</h2>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid grid-cols-4 gap-y-6 gap-x-2\">\r\n                        {Object.values(BADGE_CONFIGS).map((config) => {\r\n                            const userBadge = user.badges?.find(b => b.badgeId === config.id);\r\n                            const isEarned = !!userBadge;\r\n                            const isActive = user.activeBadgeId === config.id;\r\n\r\n                            return (\r\n                                <div key={config.id} className=\"flex flex-col items-center gap-2\">\r\n                                    <button\r\n                                        onClick={() => setSelectedBadgeId(config.id)}\r\n                                        className={`relative w-14 h-14 flex items-center justify-center rounded-full border-2 transition-all duration-500 group shadow-[0_4px_15px_rgba(0,0,0,0.3)] hover:scale-110 active:scale-95 cursor-pointer bg-gradient-to-br ${config.style} ${isEarned\r\n                                            ? 'border-white/20 opacity-100'\r\n                                            : 'border-white/5 opacity-60 grayscale-[0.3]'\r\n                                            } ${isActive ? 'ring-2 ring-white ring-offset-2 ring-offset-[#120024] scale-110' : ''}`}\r\n                                    >\r\n                                        <span className={`text-5xl absolute transition-all duration-500 z-10 drop-shadow-2xl ${isEarned ? 'group-hover:rotate-12 group-hover:scale-125' : 'group-hover:grayscale-0 group-hover:opacity-100 group-hover:scale-110'}`}>\r\n                                            {config.icon}\r\n                                        </span>\r\n\r\n                                        {!isEarned && (\r\n                                            <div className=\"absolute inset-0 flex items-center justify-center bg-black/40 rounded-full group-hover:bg-black/20 transition-colors z-20\">\r\n                                                <Lock size={16} className=\"text-white/80 drop-shadow-md\" />\r\n                                            </div>\r\n                                        )}\r\n\r\n                                        {isActive && (\r\n                                            <div className=\"absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-lg ring-2 ring-[#120024] animate-in zoom-in-0 duration-300 z-30\">\r\n                                                <Check className=\"text-[#120024]\" size={10} strokeWidth={4} />\r\n                                            </div>\r\n                                        )}\r\n                                    </button>\r\n                                    <div className=\"relative mt-[-20px] group z-40 w-full flex justify-center items-center pointer-events-none\">\r\n                                        {/* Arched Ribbon Wings (Back) */}\r\n                                        <div\r\n                                            className={`absolute left-[calc(50%-36px)] top-3 w-8 h-4 -z-20 brightness-[0.3] bg-gradient-to-br ${config.style} [clip-path:polygon(100%_0,0_50%,100%_100%)] group-hover:left-[calc(50%-42px)] transition-all duration-300 shadow-2xl`}\r\n                                        />\r\n                                        <div\r\n                                            className={`absolute right-[calc(50%-36px)] top-3 w-8 h-4 -z-20 brightness-[0.3] bg-gradient-to-br ${config.style} [clip-path:polygon(0_0,100%_50%,0_100%)] group-hover:right-[calc(50%-42px)] transition-all duration-300 shadow-2xl`}\r\n                                        />\r\n\r\n                                        {/* Fold Shadows */}\r\n                                        <div className=\"absolute left-[calc(50%-26px)] top-1 w-3 h-5 -z-10 bg-black/60 skew-y-[30deg]\" />\r\n                                        <div className=\"absolute right-[calc(50%-26px)] top-1 w-3 h-5 -z-10 bg-black/60 -skew-y-[30deg]\" />\r\n\r\n                                        {/* Arched Ribbon Body (Front) */}\r\n                                        <div className={`relative px-4 py-2 bg-gradient-to-br ${config.style} shadow-[0_8px_25px_rgba(0,0,0,0.7)] border-t border-white/50 min-w-[70px] max-w-[90px] flex items-center justify-center overflow-hidden\r\n                                            [clip-path:polygon(0_15%,_50%_0%,_100%_15%,_100%_85%,_50%_100%,_0_85%)]\r\n                                            before:absolute before:inset-0 before:bg-gradient-to-b before:from-white/30 before:to-transparent before:opacity-50\r\n                                            after:absolute after:inset-0 after:bg-gradient-to-r after:from-black/30 after:via-transparent after:to-black/30`}>\r\n                                            <span className={`relative z-10 text-[11px] font-black uppercase tracking-tight text-center leading-none transition-all duration-500 drop-shadow-[0_2px_4px_rgba(0,0,0,1)] whitespace-nowrap overflow-hidden text-ellipsis px-1 ${isEarned ? 'text-white' : 'text-white/80'}`}>\r\n                                                {t(config.nameKey)}\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Privacy Settings */}\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"flex items-center gap-3 px-1 mb-2\">\r\n                        <div className=\"w-8 h-8 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-300\">\r\n                            <Shield size={18} />\r\n                        </div>\r\n                        <h3 className=\"text-lg font-black text-white uppercase tracking-widest\">\r\n                            {t('privacy')}\r\n                        </h3>\r\n                    </div>\r\n\r\n                    <div className=\"bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/[0.07] transition-colors group\">\r\n                        <div className=\"pr-4\">\r\n                            <div className=\"text-white font-bold mb-1 group-hover:text-purple-200 transition-colors uppercase tracking-wider text-sm\">{t('hide_profile')}</div>\r\n                            <div className=\"text-white/60 text-xs leading-relaxed\">\r\n                                {t('hide_profile_desc')}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => toggleAnonymity(!user.isAnonymous)}\r\n                            className={`relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-all duration-300 focus:outline-none ${user.isAnonymous\r\n                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 shadow-[0_0_15px_rgba(168,85,247,0.4)]'\r\n                                : 'bg-white/10'}`}\r\n                        >\r\n                            <span\r\n                                className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-300 ${user.isAnonymous ? 'translate-x-6' : 'translate-x-1'\r\n                                    }`}\r\n                            />\r\n                        </button>\r\n                    </div>\r\n\r\n                    <div className=\"bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/[0.07] transition-colors group\">\r\n                        <div className=\"pr-4\">\r\n                            <div className=\"text-white font-bold mb-1 group-hover:text-purple-200 transition-colors uppercase tracking-wider text-sm\">{t('ghost_mode')}</div>\r\n                            <div className=\"text-white/60 text-xs leading-relaxed\">\r\n                                {t('ghost_mode_desc')}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => toggleLocationPrivacy(!user.hideLocationFromFriends)}\r\n                            className={`relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-all duration-300 focus:outline-none ${user.hideLocationFromFriends\r\n                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 shadow-[0_0_15px_rgba(168,85,247,0.4)]'\r\n                                : 'bg-white/10'}`}\r\n                        >\r\n                            <span\r\n                                className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-300 ${user.hideLocationFromFriends ? 'translate-x-6' : 'translate-x-1'\r\n                                    }`}\r\n                            />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Map Preferences */}\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"flex items-center gap-3 px-1 mb-2\">\r\n                        <div className=\"w-8 h-8 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-300\">\r\n                            <Globe size={18} />\r\n                        </div>\r\n                        <h3 className=\"text-lg font-black text-white uppercase tracking-widest\">\r\n                            {t('map')}\r\n                        </h3>\r\n                    </div>\r\n\r\n                    <div className=\"bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/[0.07] transition-colors group\">\r\n                        <div className=\"pr-4\">\r\n                            <div className=\"text-white font-bold mb-1 group-hover:text-purple-200 transition-colors uppercase tracking-wider text-sm\">\r\n                                {t('globe_3d')}\r\n                            </div>\r\n                            <div className=\"text-white/60 text-xs leading-relaxed\">\r\n                                {is3DMap ? t('globe_3d_desc_on') : t('globe_3d_desc_off')}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => toggle3DMap(!is3DMap)}\r\n                            className={`relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-all duration-300 focus:outline-none ${is3DMap\r\n                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 shadow-[0_0_15px_rgba(168,85,247,0.4)]'\r\n                                : 'bg-white/10'}`}\r\n                        >\r\n                            <span\r\n                                className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-300 ${is3DMap ? 'translate-x-6' : 'translate-x-1'\r\n                                    }`}\r\n                            />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* 3D Buildings */}\r\n                    <div className=\"bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/[0.07] transition-colors group\">\r\n                        <div className=\"pr-4\">\r\n                            <div className=\"text-white font-bold mb-1 group-hover:text-purple-200 transition-colors uppercase tracking-wider text-sm\">\r\n                                {t('buildings_3d')}\r\n                            </div>\r\n                            <div className=\"text-white/60 text-xs leading-relaxed\">\r\n                                {show3DBuildings ? t('buildings_3d_desc_on') : t('buildings_3d_desc_off')}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => toggle3DBuildings(!show3DBuildings)}\r\n                            className={`relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-all duration-300 focus:outline-none ${show3DBuildings\r\n                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 shadow-[0_0_15px_rgba(168,85,247,0.4)]'\r\n                                : 'bg-white/10'}`}\r\n                        >\r\n                            <span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-300 ${show3DBuildings ? 'translate-x-6' : 'translate-x-1'}`} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* 3D Terrain */}\r\n                    <div className=\"bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/[0.07] transition-colors group\">\r\n                        <div className=\"pr-4\">\r\n                            <div className=\"text-white font-bold mb-1 group-hover:text-purple-200 transition-colors uppercase tracking-wider text-sm\">\r\n                                {t('terrain_3d')}\r\n                            </div>\r\n                            <div className=\"text-white/60 text-xs leading-relaxed\">\r\n                                {show3DTerrain ? t('terrain_3d_desc_on') : t('terrain_3d_desc_off')}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => toggle3DTerrain(!show3DTerrain)}\r\n                            className={`relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-all duration-300 focus:outline-none ${show3DTerrain\r\n                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 shadow-[0_0_15px_rgba(168,85,247,0.4)]'\r\n                                : 'bg-white/10'}`}\r\n                        >\r\n                            <span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-300 ${show3DTerrain ? 'translate-x-6' : 'translate-x-1'}`} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Places & Labels (POI) */}\r\n                    <div className=\"bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/[0.07] transition-colors group\">\r\n                        <div className=\"pr-4\">\r\n                            <div className=\"text-white font-bold mb-1 group-hover:text-purple-200 transition-colors uppercase tracking-wider text-sm\">\r\n                                {t('places_labels')}\r\n                            </div>\r\n                            <div className=\"text-white/60 text-xs leading-relaxed\">\r\n                                {showPOI ? t('places_labels_desc_on') : t('places_labels_desc_off')}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => togglePOI(!showPOI)}\r\n                            className={`relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-all duration-300 focus:outline-none ${showPOI\r\n                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 shadow-[0_0_15px_rgba(168,85,247,0.4)]'\r\n                                : 'bg-white/10'}`}\r\n                        >\r\n                            <span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-300 ${showPOI ? 'translate-x-6' : 'translate-x-1'}`} />\r\n                        </button>\r\n                    </div>\r\n\r\n                    {/* Road & Transit Network */}\r\n                    <div className=\"bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center justify-between hover:bg-white/[0.07] transition-colors group\">\r\n                        <div className=\"pr-4\">\r\n                            <div className=\"text-white font-bold mb-1 group-hover:text-purple-200 transition-colors uppercase tracking-wider text-sm\">\r\n                                {t('road_transit_network')}\r\n                            </div>\r\n                            <div className=\"text-white/60 text-xs leading-relaxed\">\r\n                                {showTransit ? t('road_transit_network_desc_on') : t('road_transit_network_desc_off')}\r\n                            </div>\r\n                        </div>\r\n                        <button\r\n                            onClick={() => toggleTransit(!showTransit)}\r\n                            className={`relative inline-flex h-7 w-12 shrink-0 items-center rounded-full transition-all duration-300 focus:outline-none ${showTransit\r\n                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 shadow-[0_0_15px_rgba(168,85,247,0.4)]'\r\n                                : 'bg-white/10'}`}\r\n                        >\r\n                            <span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-300 ${showTransit ? 'translate-x-6' : 'translate-x-1'}`} />\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Go Premium Section */}\r\n\r\n                {!user.isPremium && (\r\n                    <div className=\"relative overflow-hidden bg-gradient-to-br from-yellow-900/40 via-black to-black border-2 border-yellow-500/50 rounded-3xl p-6 shadow-2xl shadow-yellow-500/10\">\r\n                        <div className=\"absolute top-0 right-0 w-32 h-32 bg-yellow-500/20 rounded-full blur-[60px] -mr-10 -mt-10 pointer-events-none animate-pulse\"></div>\r\n                        <div className=\"relative z-10\">\r\n                            <div className=\"flex items-center gap-3 mb-4\">\r\n                                <div className=\"w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center text-yellow-400\">\r\n                                    <Crown size={22} />\r\n                                </div>\r\n                                <h2 className=\"text-xl font-black text-yellow-300 uppercase tracking-tight\">{t('go_premium')}</h2>\r\n                            </div>\r\n                            <p className=\"text-yellow-100/70 text-sm mb-6 leading-relaxed\">\r\n                                {t('premium_desc')}\r\n                            </p>\r\n                            <button\r\n                                onClick={() => alert(t('premium_coming_soon'))}\r\n                                className=\"w-full py-4 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-300 hover:to-orange-400 text-black font-black rounded-2xl transition-all shadow-xl shadow-yellow-500/20 active:scale-95 uppercase tracking-wider text-sm\"\r\n                            >\r\n                                {t('upgrade_premium')}\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Language Section */}\r\n                <div className=\"bg-white/5 border border-white/10 rounded-3xl p-6 shadow-xl backdrop-blur-md\">\r\n                    <div className=\"flex items-center gap-3 mb-6 pl-1\">\r\n                        <div className=\"w-8 h-8 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-300\">\r\n                            <Globe size={18} />\r\n                        </div>\r\n                        <h3 className=\"text-lg font-black text-white uppercase tracking-widest\">{t('language')}</h3>\r\n                    </div>\r\n\r\n                    <LanguageDropdown lang={lang} setLanguage={setLanguage} />\r\n                </div>\r\n\r\n                {/* Account Actions */}\r\n                <div className=\"pt-4 pb-8\">\r\n                    <button\r\n                        onClick={() => signOut()}\r\n                        className=\"w-full group bg-red-500/5 hover:bg-red-500/10 border border-red-500/10 hover:border-red-500/20 rounded-2xl p-4 flex items-center justify-between transition-all duration-300 shadow-lg shadow-red-500/5 group\"\r\n                    >\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <div className=\"w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center text-red-400 group-hover:scale-110 transition-transform\">\r\n                                <LogOut size={20} />\r\n                            </div>\r\n                            <span className=\"text-red-400 font-bold\">{t('logout')}</span>\r\n                        </div>\r\n                        <div className=\"w-8 h-8 rounded-lg flex items-center justify-center text-red-500/30 group-hover:text-red-500/60 transition-colors\">\r\n                            <X size={18} />\r\n                        </div>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Badge Info Modal */}\r\n            <BadgeInfoModal\r\n                badgeId={selectedBadgeId}\r\n                isEarned={!!user.badges?.find(b => b.badgeId === selectedBadgeId)}\r\n                isActive={user.activeBadgeId === selectedBadgeId}\r\n                canActivate={true}\r\n                onClose={() => setSelectedBadgeId(null)}\r\n                onActivate={(id) => {\r\n                    handleSelectBadge(id);\r\n                    setSelectedBadgeId(null);\r\n                }}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\context\\ConfigContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\context\\LocalizationContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\context\\UIContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\hooks\\useLocation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\hooks\\useMessages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\hooks\\usePushNotifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\hooks\\useUser.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\badgeConfig.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\badgeLogic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\firebase-admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\gameLogic.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\mapStyle.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\mapboxStyle.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\messages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\notifications.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\translations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\userStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\next-auth.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\src\\proxy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\mustafasenel\\.gemini\\antigravity\\scratch\\nextjs-bootstrap\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]